{"version":3,"file":"angular-three-soba-performances.mjs","sources":["../../../../packages/soba/performances/src/preload/preload.directive.ts","../../../../packages/soba/performances/src/detailed/detailed.component.ts","../../../../packages/soba/performances/src/angular-three-soba-performances.ts"],"sourcesContent":["import { EnhancedRxState, NgtStore } from '@angular-three/core';\nimport { Directive, Input, NgModule, OnInit } from '@angular/core';\nimport * as THREE from 'three';\n\ninterface NgtSobaPreloadState {\n  all: boolean;\n  scene?: THREE.Object3D;\n  camera?: THREE.Camera;\n}\n\n@Directive({\n  selector: 'ngt-soba-preload',\n  exportAs: 'ngtSobaPreload',\n})\nexport class NgtSobaPreload\n  extends EnhancedRxState<NgtSobaPreloadState>\n  implements OnInit\n{\n  @Input() set all(v: boolean) {\n    this.set({ all: v });\n  }\n\n  @Input() set scene(v: THREE.Object3D) {\n    this.set({ scene: v });\n  }\n\n  @Input() set camera(v: THREE.Camera) {\n    this.set({ camera: v });\n  }\n\n  get #precompileParams() {\n    const { all, scene, camera } = this.get();\n    const {\n      camera: canvasCamera,\n      scene: canvasScene,\n      renderer,\n    } = this.store.get();\n    return {\n      all,\n      scene: scene || canvasScene,\n      camera: camera || canvasCamera,\n      renderer,\n    };\n  }\n\n  constructor(private store: NgtStore) {\n    super();\n    this.set({\n      all: false,\n      scene: undefined,\n      camera: undefined,\n    });\n  }\n\n  ngOnInit() {\n    this.hold(this.store.select('ready'), (ready) => {\n      if (ready) {\n        const { all, scene, camera, renderer } = this.#precompileParams;\n        const invisible: THREE.Object3D[] = [];\n\n        if (all) {\n          scene!.traverse((object) => {\n            if (!object.visible) {\n              invisible.push(object);\n              object.visible = true;\n            }\n          });\n        }\n\n        // Now compile\n        renderer!.compile(scene!, camera!);\n        // And for good measure, hit it with a cube camera\n        const cubeRenderTarget = new THREE.WebGLCubeRenderTarget(128);\n        const cubeCamera = new THREE.CubeCamera(0.01, 100000, cubeRenderTarget);\n        cubeCamera.update(renderer!, scene as THREE.Scene);\n        cubeRenderTarget.dispose();\n        // Flips these objects back\n        invisible.forEach((object) => (object.visible = false));\n      }\n    });\n  }\n}\n\n@NgModule({\n  declarations: [NgtSobaPreload],\n  exports: [NgtSobaPreload],\n})\nexport class NgtSobaPreloadModule {}\n","import {\n  EnhancedRxState,\n  NGT_OBJECT_INPUTS_CONTROLLER_PROVIDER,\n  NGT_OBJECT_INPUTS_WATCHED_CONTROLLER,\n  NgtObject3dController,\n  NgtObject3dInputsController,\n  NgtObject3dInputsControllerModule,\n  NgtRender,\n  NgtSobaExtender,\n} from '@angular-three/core';\nimport { NgtLodModule } from '@angular-three/core/lod';\nimport {\n  AfterContentInit,\n  ChangeDetectionStrategy,\n  Component,\n  ContentChildren,\n  Inject,\n  Injectable,\n  Input,\n  NgModule,\n  QueryList,\n} from '@angular/core';\nimport { asapScheduler } from '@rx-angular/cdk/zone-less';\nimport { selectSlice } from '@rx-angular/state';\nimport { combineLatest, map, observeOn, startWith } from 'rxjs';\nimport * as THREE from 'three';\n\ninterface NgtSobaDetailedStoreState {\n  lod: THREE.LOD;\n  distances: number[];\n  children: THREE.Object3D[];\n}\n\n@Injectable()\nexport class NgtSobaDetailedStore extends EnhancedRxState<NgtSobaDetailedStoreState> {\n  #updateLodChildrenParams$ = this.select(selectSlice(['lod', 'children']));\n\n  constructor() {\n    super();\n    this.set({ distances: [], children: [] });\n    this.hold(this.#updateLodChildrenParams$, ({ lod, children }) => {\n      const distances = this.get('distances');\n      if (!children.length) lod.levels.length = 0;\n      children.forEach((object, index) => {\n        lod.addLevel(object, distances[index]);\n      });\n    });\n  }\n}\n\n@Component({\n  selector: 'ngt-soba-detailed',\n  template: `\n    <ngt-lod\n      #lod=\"ngtLod\"\n      (ready)=\"onLodReady($event)\"\n      (animateReady)=\"onLodAnimateReady($event, lod.lod)\"\n      [object3dInputsController]=\"objectInputsController\"\n    ></ngt-lod>\n    <ng-content></ng-content>\n  `,\n  changeDetection: ChangeDetectionStrategy.OnPush,\n  providers: [\n    NGT_OBJECT_INPUTS_CONTROLLER_PROVIDER,\n    NgtSobaDetailedStore,\n    {\n      provide: NgtSobaExtender,\n      useExisting: NgtSobaDetailed,\n    },\n  ],\n})\nexport class NgtSobaDetailed\n  extends NgtSobaExtender<THREE.LOD>\n  implements AfterContentInit\n{\n  @Input() set distances(v: number[]) {\n    this.detailedStore.set({ distances: v });\n  }\n\n  @ContentChildren(NgtObject3dController, { descendants: true })\n  children!: QueryList<NgtObject3dController>;\n\n  @ContentChildren(NgtSobaExtender, { descendants: true })\n  extenders!: QueryList<NgtSobaExtender<THREE.Object3D>>;\n\n  constructor(\n    @Inject(NGT_OBJECT_INPUTS_WATCHED_CONTROLLER)\n    public objectInputsController: NgtObject3dInputsController,\n    private detailedStore: NgtSobaDetailedStore\n  ) {\n    super();\n  }\n\n  ngAfterContentInit() {\n    const children$ = combineLatest([\n      this.extenders.changes.pipe(\n        startWith(this.extenders),\n        observeOn(asapScheduler)\n      ),\n      this.children.changes.pipe(\n        startWith(this.children),\n        observeOn(asapScheduler)\n      ),\n    ]).pipe(\n      map(\n        ([extendersList, childrenList]: [\n          QueryList<NgtSobaExtender<THREE.Object3D>>,\n          QueryList<NgtObject3dController>\n        ]) => [\n          ...childrenList.map((child) => child.object3d),\n          ...extendersList.map((extender) => extender.object),\n        ]\n      )\n    );\n    this.detailedStore.connect('children', children$);\n  }\n\n  onLodAnimateReady({ camera }: NgtRender, lod: THREE.LOD) {\n    lod.update(camera);\n  }\n\n  onLodReady(lod: THREE.LOD) {\n    this.object = lod;\n    this.detailedStore.set({ lod });\n  }\n}\n\n@NgModule({\n  declarations: [NgtSobaDetailed],\n  exports: [NgtSobaDetailed, NgtObject3dInputsControllerModule],\n  imports: [NgtLodModule],\n})\nexport class NgtSobaDetailedModule {}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":[],"mappings":"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"}