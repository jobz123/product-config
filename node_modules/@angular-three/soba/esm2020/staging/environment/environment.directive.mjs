var _NgtSobaEnvironment_instances, _NgtSobaEnvironment_textureParams$, _NgtSobaEnvironment_environmentParams$, _NgtSobaEnvironment_isCubeMap_get;
import { __classPrivateFieldGet } from "tslib";
import { EnhancedRxState, NgtLoaderService, NgtStore, } from '@angular-three/core';
import { presetsObj } from '@angular-three/soba';
import { Directive, Input, NgModule, NgZone } from '@angular/core';
import { selectSlice } from '@rx-angular/state';
import { combineLatest, map, startWith, switchMap } from 'rxjs';
import * as THREE from 'three';
import { RGBELoader } from 'three-stdlib';
import * as i0 from "@angular/core";
import * as i1 from "@angular-three/core";
const CUBEMAP_ROOT = 'https://rawcdn.githack.com/pmndrs/drei-assets/aa3600359ba664d546d05821bcbca42013587df2';
export class NgtSobaEnvironment extends EnhancedRxState {
    constructor(loaderService, ngZone, store) {
        super();
        this.loaderService = loaderService;
        this.ngZone = ngZone;
        this.store = store;
        _NgtSobaEnvironment_instances.add(this);
        _NgtSobaEnvironment_textureParams$.set(this, combineLatest([
            this.select(selectSlice(['files', 'path'])),
            this.select('extensions').pipe(startWith(undefined)),
        ]).pipe(map(([{ path, files }, extensions]) => {
            const loader = __classPrivateFieldGet(this, _NgtSobaEnvironment_instances, "a", _NgtSobaEnvironment_isCubeMap_get) ? THREE.CubeTextureLoader : RGBELoader;
            const urls = __classPrivateFieldGet(this, _NgtSobaEnvironment_instances, "a", _NgtSobaEnvironment_isCubeMap_get) ? [files] : files;
            return { loader, urls, path, extensions };
        })));
        _NgtSobaEnvironment_environmentParams$.set(this, combineLatest([
            this.select(selectSlice(['texture', 'background'])),
            this.select('scene').pipe(startWith(undefined)),
        ]).pipe(map(([{ texture, background }, scene]) => ({ texture, background, scene }))));
        this.set({
            background: false,
            files: ['/px.png', '/nx.png', '/py.png', '/ny.png', '/pz.png', '/nz.png'],
            path: '',
            scene: undefined,
            extensions: undefined,
        });
    }
    set background(v) {
        this.set({ background: v });
    }
    set files(v) {
        this.set({ files: v });
    }
    set path(v) {
        this.set({ path: v });
    }
    set preset(v) {
        if (!(v in presetsObj)) {
            throw new Error('Preset must be one of: ' + Object.keys(presetsObj).join(', '));
        }
        this.set({ files: presetsObj[v], path: CUBEMAP_ROOT + '/hdri/' });
    }
    set scene(v) {
        this.set({ scene: v });
    }
    set extensions(v) {
        this.set({ extensions: v });
    }
    ngOnInit() {
        this.hold(__classPrivateFieldGet(this, _NgtSobaEnvironment_textureParams$, "f").pipe(switchMap(({ path, extensions, loader, urls }) => 
        // @ts-ignore
        this.loaderService.use(loader, urls, (innerLoader) => {
            innerLoader.setPath(path);
            if (extensions) {
                extensions(innerLoader);
            }
        }))), (textureResult) => {
            const renderer = this.store.get('renderer');
            const gen = new THREE.PMREMGenerator(renderer);
            const texture = NgtSobaEnvironment.getTexture(textureResult, gen, __classPrivateFieldGet(this, _NgtSobaEnvironment_instances, "a", _NgtSobaEnvironment_isCubeMap_get));
            gen.dispose();
            this.set({ texture });
        });
        this.holdEffect(__classPrivateFieldGet(this, _NgtSobaEnvironment_environmentParams$, "f"), ({ texture, scene, background }) => {
            const defaultScene = this.store.get('scene');
            const oldBg = scene ? scene.background : defaultScene.background;
            const oldEnv = scene ? scene.environment : defaultScene.environment;
            if (scene) {
                scene.environment = texture;
                if (background)
                    scene.background = texture;
            }
            else {
                defaultScene.environment = texture;
                if (background)
                    defaultScene.background = texture;
            }
            return () => {
                if (scene) {
                    scene.environment = oldEnv;
                    scene.background = oldBg;
                }
                else {
                    defaultScene.environment = oldEnv;
                    defaultScene.background = oldBg;
                }
                texture.dispose();
            };
        });
    }
    static getTexture(texture, gen, isCubeMap) {
        if (isCubeMap) {
            gen.compileEquirectangularShader();
            return gen.fromCubemap(texture).texture;
        }
        return gen.fromEquirectangular(texture).texture;
    }
}
_NgtSobaEnvironment_textureParams$ = new WeakMap(), _NgtSobaEnvironment_environmentParams$ = new WeakMap(), _NgtSobaEnvironment_instances = new WeakSet(), _NgtSobaEnvironment_isCubeMap_get = function _NgtSobaEnvironment_isCubeMap_get() {
    return Array.isArray(this.get('files'));
};
NgtSobaEnvironment.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaEnvironment, deps: [{ token: i1.NgtLoaderService }, { token: i0.NgZone }, { token: i1.NgtStore }], target: i0.ɵɵFactoryTarget.Directive });
NgtSobaEnvironment.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.1.1", type: NgtSobaEnvironment, selector: "ngt-soba-environment", inputs: { background: "background", files: "files", path: "path", preset: "preset", scene: "scene", extensions: "extensions" }, exportAs: ["ngtSobaEnvironment"], usesInheritance: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaEnvironment, decorators: [{
            type: Directive,
            args: [{
                    selector: 'ngt-soba-environment',
                    exportAs: 'ngtSobaEnvironment',
                }]
        }], ctorParameters: function () { return [{ type: i1.NgtLoaderService }, { type: i0.NgZone }, { type: i1.NgtStore }]; }, propDecorators: { background: [{
                type: Input
            }], files: [{
                type: Input
            }], path: [{
                type: Input
            }], preset: [{
                type: Input
            }], scene: [{
                type: Input
            }], extensions: [{
                type: Input
            }] } });
export class NgtSobaEnvironmentModule {
}
NgtSobaEnvironmentModule.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaEnvironmentModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule });
NgtSobaEnvironmentModule.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaEnvironmentModule, declarations: [NgtSobaEnvironment], exports: [NgtSobaEnvironment] });
NgtSobaEnvironmentModule.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaEnvironmentModule });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaEnvironmentModule, decorators: [{
            type: NgModule,
            args: [{
                    declarations: [NgtSobaEnvironment],
                    exports: [NgtSobaEnvironment],
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW52aXJvbm1lbnQuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvc29iYS9zdGFnaW5nL3NyYy9lbnZpcm9ubWVudC9lbnZpcm9ubWVudC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxPQUFPLEVBQ0wsZUFBZSxFQUNmLGdCQUFnQixFQUNoQixRQUFRLEdBQ1QsTUFBTSxxQkFBcUIsQ0FBQztBQUM3QixPQUFPLEVBQUUsVUFBVSxFQUFlLE1BQU0scUJBQXFCLENBQUM7QUFDOUQsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBVSxNQUFNLGVBQWUsQ0FBQztBQUMzRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDaEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxHQUFHLEVBQWMsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM1RSxPQUFPLEtBQUssS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMvQixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sY0FBYyxDQUFDOzs7QUFFMUMsTUFBTSxZQUFZLEdBQ2hCLHdGQUF3RixDQUFDO0FBZTNGLE1BQU0sT0FBTyxrQkFDWCxTQUFRLGVBQXdDO0lBa0RoRCxZQUNVLGFBQStCLEVBQy9CLE1BQWMsRUFDZCxLQUFlO1FBRXZCLEtBQUssRUFBRSxDQUFDO1FBSkEsa0JBQWEsR0FBYixhQUFhLENBQWtCO1FBQy9CLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDZCxVQUFLLEdBQUwsS0FBSyxDQUFVOztRQXJCekIsNkNBQWtCLGFBQWEsQ0FBQztZQUM5QixJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQzNDLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsSUFB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K0dBNUhVLGtCQUFrQjttR0FBbEIsa0JBQWtCOzJGQUFsQixrQkFBa0I7a0JBSjlCLFNBQVM7bUJBQUM7b0JBQ1QsUUFBUSxFQUFFLHNCQUFzQjtvQkFDaEMsUUFBUSxFQUFFLG9CQUFvQjtpQkFDL0I7bUpBS2MsVUFBVTtzQkFBdEIsS0FBSztnQkFJTyxLQUFLO3NCQUFqQixLQUFLO2dCQUlPLElBQUk7c0JBQWhCLEtBQUs7Z0JBSU8sTUFBTTtzQkFBbEIsS0FBSztnQkFTTyxLQUFLO3NCQUFqQixLQUFLO2dCQUlPLFVBQVU7c0JBQXRCLEtBQUs7O0FBa0hSLE1BQU0sT0FBTyx3QkFBd0I7O3FIQUF4Qix3QkFBd0I7c0hBQXhCLHdCQUF3QixpQkEvSXhCLGtCQUFrQixhQUFsQixrQkFBa0I7c0hBK0lsQix3QkFBd0I7MkZBQXhCLHdCQUF3QjtrQkFKcEMsUUFBUTttQkFBQztvQkFDUixZQUFZLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQztvQkFDbEMsT0FBTyxFQUFFLENBQUMsa0JBQWtCLENBQUM7aUJBQzlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRW5oYW5jZWRSeFN0YXRlLFxuICBOZ3RMb2FkZXJTZXJ2aWNlLFxuICBOZ3RTdG9yZSxcbn0gZnJvbSAnQGFuZ3VsYXItdGhyZWUvY29yZSc7XG5pbXBvcnQgeyBwcmVzZXRzT2JqLCBQcmVzZXRzVHlwZSB9IGZyb20gJ0Bhbmd1bGFyLXRocmVlL3NvYmEnO1xuaW1wb3J0IHsgRGlyZWN0aXZlLCBJbnB1dCwgTmdNb2R1bGUsIE5nWm9uZSwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBzZWxlY3RTbGljZSB9IGZyb20gJ0ByeC1hbmd1bGFyL3N0YXRlJztcbmltcG9ydCB7IGNvbWJpbmVMYXRlc3QsIG1hcCwgT2JzZXJ2YWJsZSwgc3RhcnRXaXRoLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzJztcbmltcG9ydCAqIGFzIFRIUkVFIGZyb20gJ3RocmVlJztcbmltcG9ydCB7IFJHQkVMb2FkZXIgfSBmcm9tICd0aHJlZS1zdGRsaWInO1xuXG5jb25zdCBDVUJFTUFQX1JPT1QgPVxuICAnaHR0cHM6Ly9yYXdjZG4uZ2l0aGFjay5jb20vcG1uZHJzL2RyZWktYXNzZXRzL2FhMzYwMDM1OWJhNjY0ZDU0NmQwNTgyMWJjYmNhNDIwMTM1ODdkZjInO1xuXG5pbnRlcmZhY2UgTmd0U29iYUVudmlyb25tZW50U3RhdGUge1xuICBiYWNrZ3JvdW5kPzogYm9vbGVhbjtcbiAgdGV4dHVyZTogVEhSRUUuVGV4dHVyZTtcbiAgZmlsZXM/OiBzdHJpbmcgfCBzdHJpbmdbXTtcbiAgcGF0aD86IHN0cmluZztcbiAgc2NlbmU/OiBUSFJFRS5TY2VuZTtcbiAgZXh0ZW5zaW9ucz86IChsb2FkZXI6IFRIUkVFLkxvYWRlcikgPT4gdm9pZDtcbn1cblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnbmd0LXNvYmEtZW52aXJvbm1lbnQnLFxuICBleHBvcnRBczogJ25ndFNvYmFFbnZpcm9ubWVudCcsXG59KVxuZXhwb3J0IGNsYXNzIE5ndFNvYmFFbnZpcm9ubWVudFxuICBleHRlbmRzIEVuaGFuY2VkUnhTdGF0ZTxOZ3RTb2JhRW52aXJvbm1lbnRTdGF0ZT5cbiAgaW1wbGVtZW50cyBPbkluaXRcbntcbiAgQElucHV0KCkgc2V0IGJhY2tncm91bmQodjogYm9vbGVhbikge1xuICAgIHRoaXMuc2V0KHsgYmFja2dyb3VuZDogdiB9KTtcbiAgfVxuXG4gIEBJbnB1dCgpIHNldCBmaWxlcyh2OiBzdHJpbmcgfCBzdHJpbmdbXSkge1xuICAgIHRoaXMuc2V0KHsgZmlsZXM6IHYgfSk7XG4gIH1cblxuICBASW5wdXQoKSBzZXQgcGF0aCh2OiBzdHJpbmcpIHtcbiAgICB0aGlzLnNldCh7IHBhdGg6IHYgfSk7XG4gIH1cblxuICBASW5wdXQoKSBzZXQgcHJlc2V0KHY6IFByZXNldHNUeXBlKSB7XG4gICAgaWYgKCEodiBpbiBwcmVzZXRzT2JqKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnUHJlc2V0IG11c3QgYmUgb25lIG9mOiAnICsgT2JqZWN0LmtleXMocHJlc2V0c09iaikuam9pbignLCAnKVxuICAgICAgKTtcbiAgICB9XG4gICAgdGhpcy5zZXQoeyBmaWxlczogcHJlc2V0c09ialt2XSwgcGF0aDogQ1VCRU1BUF9ST09UICsgJy9oZHJpLycgfSk7XG4gIH1cblxuICBASW5wdXQoKSBzZXQgc2NlbmUodjogVEhSRUUuU2NlbmUpIHtcbiAgICB0aGlzLnNldCh7IHNjZW5lOiB2IH0pO1xuICB9XG5cbiAgQElucHV0KCkgc2V0IGV4dGVuc2lvbnModjogKGxvYWRlcjogVEhSRUUuTG9hZGVyKSA9PiB2b2lkKSB7XG4gICAgdGhpcy5zZXQoeyBleHRlbnNpb25zOiB2IH0pO1xuICB9XG5cbiAgI3RleHR1cmVQYXJhbXMkID0gY29tYmluZUxhdGVzdChbXG4gICAgdGhpcy5zZWxlY3Qoc2VsZWN0U2xpY2UoWydmaWxlcycsICdwYXRoJ10pKSxcbiAgICB0aGlzLnNlbGVjdCgnZXh0ZW5zaW9ucycpLnBpcGUoc3RhcnRXaXRoKHVuZGVmaW5lZCkpLFxuICBdKS5waXBlKFxuICAgIG1hcCgoW3sgcGF0aCwgZmlsZXMgfSwgZXh0ZW5zaW9uc10pID0+IHtcbiAgICAgIGNvbnN0IGxvYWRlciA9IHRoaXMuI2lzQ3ViZU1hcCA/IFRIUkVFLkN1YmVUZXh0dXJlTG9hZGVyIDogUkdCRUxvYWRlcjtcbiAgICAgIGNvbnN0IHVybHMgPSB0aGlzLiNpc0N1YmVNYXAgPyBbZmlsZXNdIDogZmlsZXM7XG4gICAgICByZXR1cm4geyBsb2FkZXIsIHVybHMsIHBhdGgsIGV4dGVuc2lvbnMgfTtcbiAgICB9KVxuICApO1xuXG4gICNlbnZpcm9ubWVudFBhcmFtcyQgPSBjb21iaW5lTGF0ZXN0KFtcbiAgICB0aGlzLnNlbGVjdChzZWxlY3RTbGljZShbJ3RleHR1cmUnLCAnYmFja2dyb3VuZCddKSksXG4gICAgdGhpcy5zZWxlY3QoJ3NjZW5lJykucGlwZShzdGFydFdpdGgodW5kZWZpbmVkKSksXG4gIF0pLnBpcGUoXG4gICAgbWFwKChbeyB0ZXh0dXJlLCBiYWNrZ3JvdW5kIH0sIHNjZW5lXSkgPT4gKHsgdGV4dHVyZSwgYmFja2dyb3VuZCwgc2NlbmUgfSkpXG4gICk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBsb2FkZXJTZXJ2aWNlOiBOZ3RMb2FkZXJTZXJ2aWNlLFxuICAgIHByaXZhdGUgbmdab25lOiBOZ1pvbmUsXG4gICAgcHJpdmF0ZSBzdG9yZTogTmd0U3RvcmVcbiAgKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLnNldCh7XG4gICAgICBiYWNrZ3JvdW5kOiBmYWxzZSxcbiAgICAgIGZpbGVzOiBbJy9weC5wbmcnLCAnL254LnBuZycsICcvcHkucG5nJywgJy9ueS5wbmcnLCAnL3B6LnBuZycsICcvbnoucG5nJ10sXG4gICAgICBwYXRoOiAnJyxcbiAgICAgIHNjZW5lOiB1bmRlZmluZWQsXG4gICAgICBleHRlbnNpb25zOiB1bmRlZmluZWQsXG4gICAgfSk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmhvbGQoXG4gICAgICB0aGlzLiN0ZXh0dXJlUGFyYW1zJC5waXBlKFxuICAgICAgICBzd2l0Y2hNYXAoKHsgcGF0aCwgZXh0ZW5zaW9ucywgbG9hZGVyLCB1cmxzIH0pID0+XG4gICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgIHRoaXMubG9hZGVyU2VydmljZS51c2UobG9hZGVyLCB1cmxzLCAoaW5uZXJMb2FkZXIpID0+IHtcbiAgICAgICAgICAgIGlubmVyTG9hZGVyLnNldFBhdGgocGF0aCEpO1xuICAgICAgICAgICAgaWYgKGV4dGVuc2lvbnMpIHtcbiAgICAgICAgICAgICAgZXh0ZW5zaW9ucyhpbm5lckxvYWRlcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICAgKSBhcyBPYnNlcnZhYmxlPFRIUkVFLlRleHR1cmU+LFxuICAgICAgKHRleHR1cmVSZXN1bHQpID0+IHtcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSB0aGlzLnN0b3JlLmdldCgncmVuZGVyZXInKTtcbiAgICAgICAgY29uc3QgZ2VuID0gbmV3IFRIUkVFLlBNUkVNR2VuZXJhdG9yKHJlbmRlcmVyISk7XG4gICAgICAgIGNvbnN0IHRleHR1cmUgPSBOZ3RTb2JhRW52aXJvbm1lbnQuZ2V0VGV4dHVyZShcbiAgICAgICAgICB0ZXh0dXJlUmVzdWx0LFxuICAgICAgICAgIGdlbixcbiAgICAgICAgICB0aGlzLiNpc0N1YmVNYXBcbiAgICAgICAgKSBhcyBUSFJFRS5UZXh0dXJlO1xuICAgICAgICBnZW4uZGlzcG9zZSgpO1xuXG4gICAgICAgIHRoaXMuc2V0KHsgdGV4dHVyZSB9KTtcbiAgICAgIH1cbiAgICApO1xuXG4gICAgdGhpcy5ob2xkRWZmZWN0KFxuICAgICAgdGhpcy4jZW52aXJvbm1lbnRQYXJhbXMkLFxuICAgICAgKHsgdGV4dHVyZSwgc2NlbmUsIGJhY2tncm91bmQgfSkgPT4ge1xuICAgICAgICBjb25zdCBkZWZhdWx0U2NlbmUgPSB0aGlzLnN0b3JlLmdldCgnc2NlbmUnKTtcbiAgICAgICAgY29uc3Qgb2xkQmcgPSBzY2VuZSA/IHNjZW5lLmJhY2tncm91bmQgOiBkZWZhdWx0U2NlbmUhLmJhY2tncm91bmQ7XG4gICAgICAgIGNvbnN0IG9sZEVudiA9IHNjZW5lID8gc2NlbmUuZW52aXJvbm1lbnQgOiBkZWZhdWx0U2NlbmUhLmVudmlyb25tZW50O1xuXG4gICAgICAgIGlmIChzY2VuZSkge1xuICAgICAgICAgIHNjZW5lLmVudmlyb25tZW50ID0gdGV4dHVyZSE7XG4gICAgICAgICAgaWYgKGJhY2tncm91bmQpIHNjZW5lLmJhY2tncm91bmQgPSB0ZXh0dXJlITtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBkZWZhdWx0U2NlbmUhLmVudmlyb25tZW50ID0gdGV4dHVyZSE7XG4gICAgICAgICAgaWYgKGJhY2tncm91bmQpIGRlZmF1bHRTY2VuZSEuYmFja2dyb3VuZCA9IHRleHR1cmUhO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgICBpZiAoc2NlbmUpIHtcbiAgICAgICAgICAgIHNjZW5lLmVudmlyb25tZW50ID0gb2xkRW52O1xuICAgICAgICAgICAgc2NlbmUuYmFja2dyb3VuZCA9IG9sZEJnO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBkZWZhdWx0U2NlbmUhLmVudmlyb25tZW50ID0gb2xkRW52O1xuICAgICAgICAgICAgZGVmYXVsdFNjZW5lIS5iYWNrZ3JvdW5kID0gb2xkQmc7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRleHR1cmUuZGlzcG9zZSgpO1xuICAgICAgICB9O1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBnZXQgI2lzQ3ViZU1hcCgpIHtcbiAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh0aGlzLmdldCgnZmlsZXMnKSk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBnZXRUZXh0dXJlKFxuICAgIHRleHR1cmU6IFRIUkVFLlRleHR1cmUgfCBUSFJFRS5DdWJlVGV4dHVyZSxcbiAgICBnZW46IFRIUkVFLlBNUkVNR2VuZXJhdG9yLFxuICAgIGlzQ3ViZU1hcDogYm9vbGVhblxuICApIHtcbiAgICBpZiAoaXNDdWJlTWFwKSB7XG4gICAgICBnZW4uY29tcGlsZUVxdWlyZWN0YW5ndWxhclNoYWRlcigpO1xuICAgICAgcmV0dXJuIGdlbi5mcm9tQ3ViZW1hcCh0ZXh0dXJlIGFzIFRIUkVFLkN1YmVUZXh0dXJlKS50ZXh0dXJlO1xuICAgIH1cbiAgICByZXR1cm4gZ2VuLmZyb21FcXVpcmVjdGFuZ3VsYXIodGV4dHVyZSkudGV4dHVyZTtcbiAgfVxufVxuXG5ATmdNb2R1bGUoe1xuICBkZWNsYXJhdGlvbnM6IFtOZ3RTb2JhRW52aXJvbm1lbnRdLFxuICBleHBvcnRzOiBbTmd0U29iYUVudmlyb25tZW50XSxcbn0pXG5leHBvcnQgY2xhc3MgTmd0U29iYUVudmlyb25tZW50TW9kdWxlIHt9XG4iXX0=