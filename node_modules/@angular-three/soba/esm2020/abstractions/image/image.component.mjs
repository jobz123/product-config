import { NGT_OBJECT_INPUTS_CONTROLLER_PROVIDER, NGT_OBJECT_INPUTS_WATCHED_CONTROLLER, NgtMaterial, NgtObject3dInputsController, NgtObject3dInputsControllerModule, NgtSobaExtender, } from '@angular-three/core';
import { NgtPlaneGeometryModule } from '@angular-three/core/geometries';
import { NgtMeshModule } from '@angular-three/core/meshes';
import { shaderMaterial } from '@angular-three/soba';
import { NgtTextureLoaderService } from '@angular-three/soba/loaders';
import { CommonModule } from '@angular/common';
import { ChangeDetectionStrategy, Component, Directive, Inject, Input, NgModule, } from '@angular/core';
import { tap } from 'rxjs';
import * as THREE from 'three';
import * as i0 from "@angular/core";
import * as i1 from "@angular-three/soba/loaders";
import * as i2 from "@angular/common";
import * as i3 from "@angular-three/core/meshes";
import * as i4 from "@angular-three/core";
import * as i5 from "@angular-three/core/geometries";
export const ImageShaderMaterial = shaderMaterial({
    color: new THREE.Color('white'),
    scale: [1, 1],
    imageBounds: [1, 1],
    map: null,
    zoom: 1,
    grayscale: 0,
}, 
// language=glsl
`
  varying vec2 vUv;
  void main() {
    gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.);
    vUv = uv;
  }
`, 
// language=glsl
`
  // mostly from https://gist.github.com/statico/df64c5d167362ecf7b34fca0b1459a44
  varying vec2 vUv;
  uniform vec2 scale;
  uniform vec2 imageBounds;
  uniform vec3 color;
  uniform sampler2D map;
  uniform float zoom;
  uniform float grayscale;
  const vec3 luma = vec3(.299, 0.587, 0.114);
  vec4 toGrayscale(vec4 color, float intensity) {
    return vec4(mix(color.rgb, vec3(dot(color.rgb, luma)), intensity), color.a);
  }
  vec2 aspect(vec2 size) {
    return size / min(size.x, size.y);
  }
  void main() {
    vec2 s = aspect(scale);
    vec2 i = aspect(imageBounds);
    float rs = s.x / s.y;
    float ri = i.x / i.y;
    vec2 new = rs < ri ? vec2(i.x * s.y / i.y, s.y) : vec2(s.x, i.y * s.x / i.x);
    vec2 offset = (rs < ri ? vec2((new.x - s.x) / 2.0, 0.0) : vec2(0.0, (new.y - s.y) / 2.0)) / new;
    vec2 uv = vUv * s / new + offset;
    vec2 zUv = (uv - vec2(0.5, 0.5)) / zoom + vec2(0.5, 0.5);
    gl_FragColor = toGrayscale(texture2D(map, zUv) * vec4(color, 1.0), grayscale);
  }
`);
export class NgtSobaImageShaderMaterial extends NgtMaterial {
    constructor() {
        super(...arguments);
        this.materialType = ImageShaderMaterial;
    }
}
NgtSobaImageShaderMaterial.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaImageShaderMaterial, deps: null, target: i0.ɵɵFactoryTarget.Directive });
NgtSobaImageShaderMaterial.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.1.1", type: NgtSobaImageShaderMaterial, selector: "ngt-soba-image-shader-material", providers: [
        { provide: NgtMaterial, useExisting: NgtSobaImageShaderMaterial },
    ], exportAs: ["ngtSobaImageShaderMaterial"], usesInheritance: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaImageShaderMaterial, decorators: [{
            type: Directive,
            args: [{
                    selector: 'ngt-soba-image-shader-material',
                    exportAs: 'ngtSobaImageShaderMaterial',
                    providers: [
                        { provide: NgtMaterial, useExisting: NgtSobaImageShaderMaterial },
                    ],
                }]
        }] });
export class NgtSobaImage extends NgtSobaExtender {
    constructor(textureLoaderService, objectInputsController) {
        super();
        this.textureLoaderService = textureLoaderService;
        this.objectInputsController = objectInputsController;
    }
    set url(v) {
        this.texture$ = this.textureLoaderService.load(v).pipe(tap((texture) => {
            this.imageBounds = [texture.image.width, texture.image.height];
        }));
    }
    ngOnChanges() {
        this.planeBounds = Array.isArray(this.scale)
            ? [this.scale[0], this.scale[1]]
            : [this.scale, this.scale];
    }
}
NgtSobaImage.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaImage, deps: [{ token: i1.NgtTextureLoaderService }, { token: NGT_OBJECT_INPUTS_WATCHED_CONTROLLER }], target: i0.ɵɵFactoryTarget.Component });
NgtSobaImage.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "13.1.1", type: NgtSobaImage, selector: "ngt-soba-image[url]", inputs: { segments: "segments", scale: "scale", color: "color", zoom: "zoom", grayscale: "grayscale", url: "url" }, providers: [
        NGT_OBJECT_INPUTS_CONTROLLER_PROVIDER,
        { provide: NgtSobaExtender, useExisting: NgtSobaImage },
    ], usesInheritance: true, usesOnChanges: true, ngImport: i0, template: `
    <ng-container *ngIf="texture$ | async as texture">
      <ngt-mesh
        [scale]="scale"
        [object3dInputsController]="objectInputsController"
        (ready)="object = $event"
      >
        <ngt-plane-geometry
          [args]="[1, 1, segments, segments]"
        ></ngt-plane-geometry>
        <ngt-soba-image-shader-material
          [parameters]="{color, map: texture, zoom, grayscale, scale: planeBounds, imageBounds}"
        ></ngt-soba-image-shader-material>
        <ng-content></ng-content>
      </ngt-mesh>
    </ng-container>
  `, isInline: true, directives: [{ type: i2.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { type: i3.NgtMesh, selector: "ngt-mesh", exportAs: ["ngtMesh"] }, { type: i4.NgtMaterialGeometryController, selector: "    ngt-mesh,    ngt-instanced-mesh,    ngt-skinned-mesh,    ngt-line,    ngt-line-loop,    ngt-line-segments,    ngt-points  ", inputs: ["morphTargetInfluences", "morphTargetDictionary"], exportAs: ["ngtMaterialGeometryController"] }, { type: i4.NgtObject3dController, selector: "    ngt-primitive,    ngt-bone,    ngt-group,    ngt-lod,    ngt-points,    ngt-mesh,    ngt-instanced-mesh,    ngt-skinned-mesh,    ngt-audio,    ngt-positional-audio,    ngt-line,    ngt-line-loop,    ngt-line-segments,    ngt-light-probe,    ngt-ambient-light,    ngt-ambient-light-probe,    ngt-hemisphere-light,    ngt-hemisphere-light-probe,    ngt-directional-light,    ngt-point-light,    ngt-spot-light,    ngt-rect-area-light,    ngt-arrow-helper,    ngt-axes-helper,    ngt-box3-helper,    ngt-grid-helper,    ngt-plane-helper,    ngt-polar-grid-helper,    ngt-sprite,    ngt-camera,    ngt-perspective-camera,    ngt-orthographic-camera,    ngt-array-camera,    ngt-stereo-camera,    ngt-cube-camera  ", exportAs: ["ngtObject3dController"] }, { type: i4.NgtObject3dInputsController, selector: "    ngt-primitive,    ngt-bone,    ngt-group,    ngt-lod,    ngt-points,    ngt-mesh,    ngt-instanced-mesh,    ngt-skinned-mesh,    ngt-audio,    ngt-positional-audio,    ngt-line,    ngt-line-loop,    ngt-line-segments,    ngt-light-probe,    ngt-ambient-light,    ngt-ambient-light-probe,    ngt-hemisphere-light,    ngt-hemisphere-light-probe,    ngt-directional-light,    ngt-point-light,    ngt-spot-light,    ngt-rect-area-light,    ngt-arrow-helper,    ngt-axes-helper,    ngt-box3-helper,    ngt-grid-helper,    ngt-plane-helper,    ngt-polar-grid-helper,    ngt-sprite,    ngt-camera,    ngt-perspective-camera,    ngt-orthographic-camera,    ngt-array-camera,    ngt-stereo-camera,    ngt-cube-camera,    ngt-soba-plane,    ngt-soba-box,    ngt-soba-cylinder,    ngt-soba-cone,    ngt-soba-circle,    ngt-soba-sphere,    ngt-soba-tube,    ngt-soba-torus,    ngt-soba-tetrahedron,    ngt-soba-ring,    ngt-soba-polyhedron,    ngt-soba-octahedron,    ngt-soba-dodecahedron,    ngt-soba-icosahedron,    ngt-soba-extrude,    ngt-soba-lathe,    ngt-soba-torus-knot,    ngt-soba-billboard,    ngt-soba-detailed,    ngt-soba-line,    ngt-soba-quadratic-bezier-line,    ngt-soba-cubic-bezier-line,    ngt-soba-orthographic-camera,    ngt-soba-gizmo-helper,    ngt-soba-gizmo-viewport,    ngt-soba-gizmo-axis-head,    ngt-soba-text  ", inputs: ["name", "position", "rotation", "quaternion", "scale", "color", "userData", "castShadow", "receiveShadow", "visible", "matrixAutoUpdate", "dispose", "raycast", "appendMode", "appendTo", "object3dInputsController"], outputs: ["click", "contextmenu", "dblclick", "pointerup", "pointerdown", "pointerover", "pointerout", "pointerenter", "pointerleave", "pointermove", "pointermissed", "pointercancel", "wheel"], exportAs: ["ngtObject3dInputsController"] }, { type: i4.NgtContentMaterialController, selector: "    ngt-mesh,    ngt-instanced-mesh,    ngt-skinned-mesh,    ngt-line,    ngt-line-loop,    ngt-line-segments,    ngt-soba-plane,    ngt-soba-box,    ngt-soba-cylinder,    ngt-soba-cone,    ngt-soba-circle,    ngt-soba-sphere,    ngt-soba-tube,    ngt-soba-torus,    ngt-soba-tetrahedron,    ngt-soba-ring,    ngt-soba-polyhedron,    ngt-soba-octahedron,    ngt-soba-dodecahedron,    ngt-soba-icosahedron,    ngt-soba-extrude,    ngt-soba-lathe,    ngt-soba-torus-knot,    ngt-soba-text,,    ngt-points  ", inputs: ["material", "isMaterialArray", "contentMaterialController"], exportAs: ["ngtContentMaterialController"] }, { type: i4.NgtContentGeometryController, selector: "    ngt-mesh,    ngt-instanced-mesh,    ngt-skinned-mesh,    ngt-line,    ngt-line-loop,    ngt-line-segments,    ngt-points  ", inputs: ["geometry", "contentGeometryController"], exportAs: ["ngtContentGeometryController"] }, { type: i5.NgtPlaneGeometry, selector: "ngt-plane-geometry", inputs: ["args"], exportAs: ["ngtPlaneGeometry"] }, { type: NgtSobaImageShaderMaterial, selector: "ngt-soba-image-shader-material", exportAs: ["ngtSobaImageShaderMaterial"] }], pipes: { "async": i2.AsyncPipe }, changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaImage, decorators: [{
            type: Component,
            args: [{
                    selector: 'ngt-soba-image[url]',
                    template: `
    <ng-container *ngIf="texture$ | async as texture">
      <ngt-mesh
        [scale]="scale"
        [object3dInputsController]="objectInputsController"
        (ready)="object = $event"
      >
        <ngt-plane-geometry
          [args]="[1, 1, segments, segments]"
        ></ngt-plane-geometry>
        <ngt-soba-image-shader-material
          [parameters]="{color, map: texture, zoom, grayscale, scale: planeBounds, imageBounds}"
        ></ngt-soba-image-shader-material>
        <ng-content></ng-content>
      </ngt-mesh>
    </ng-container>
  `,
                    changeDetection: ChangeDetectionStrategy.OnPush,
                    providers: [
                        NGT_OBJECT_INPUTS_CONTROLLER_PROVIDER,
                        { provide: NgtSobaExtender, useExisting: NgtSobaImage },
                    ],
                }]
        }], ctorParameters: function () { return [{ type: i1.NgtTextureLoaderService }, { type: i4.NgtObject3dInputsController, decorators: [{
                    type: Inject,
                    args: [NGT_OBJECT_INPUTS_WATCHED_CONTROLLER]
                }] }]; }, propDecorators: { segments: [{
                type: Input
            }], scale: [{
                type: Input
            }], color: [{
                type: Input
            }], zoom: [{
                type: Input
            }], grayscale: [{
                type: Input
            }], url: [{
                type: Input
            }] } });
export class NgtSobaImageModule {
}
NgtSobaImageModule.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaImageModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule });
NgtSobaImageModule.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaImageModule, declarations: [NgtSobaImage, NgtSobaImageShaderMaterial], imports: [NgtMeshModule, NgtPlaneGeometryModule, CommonModule], exports: [NgtSobaImage, NgtSobaImageShaderMaterial, NgtObject3dInputsControllerModule] });
NgtSobaImageModule.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaImageModule, imports: [[NgtMeshModule, NgtPlaneGeometryModule, CommonModule], NgtObject3dInputsControllerModule] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaImageModule, decorators: [{
            type: NgModule,
            args: [{
                    declarations: [NgtSobaImage, NgtSobaImageShaderMaterial],
                    exports: [
                        NgtSobaImage,
                        NgtSobaImageShaderMaterial,
                        NgtObject3dInputsControllerModule,
                    ],
                    imports: [NgtMeshModule, NgtPlaneGeometryModule, CommonModule],
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2UuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvc29iYS9hYnN0cmFjdGlvbnMvc3JjL2ltYWdlL2ltYWdlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wscUNBQXFDLEVBQ3JDLG9DQUFvQyxFQUVwQyxXQUFXLEVBQ1gsMkJBQTJCLEVBQzNCLGlDQUFpQyxFQUNqQyxlQUFlLEdBQ2hCLE1BQU0scUJBQXFCLENBQUM7QUFDN0IsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDeEUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzNELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUN0RSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDL0MsT0FBTyxFQUNMLHVCQUF1QixFQUN2QixTQUFTLEVBQ1QsU0FBUyxFQUNULE1BQU0sRUFDTixLQUFLLEVBQ0wsUUFBUSxHQUVULE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBYyxHQUFHLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkMsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUM7Ozs7Ozs7QUFZL0IsTUFBTSxDQUFDLE1BQU0sbUJBQW1CLEdBQUcsY0FBYyxDQUMvQztJQUNFLEtBQUssRUFBRSxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDO0lBQy9CLEtBQUssRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDYixXQUFXLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ25CLEdBQUcsRUFBRSxJQUFJO0lBQ1QsSUFBSSxFQUFFLENBQUM7SUFDUCxTQUFTLEVBQUUs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QixDQUFDLGFBQWEsRUFBRSxzQkFBc0IsRUFBRSxZQUFZLENBQUMsRUFGNUQsaUNBQWlDOzJGQUl4QixrQkFBa0I7a0JBVDlCLFFBQVE7bUJBQUM7b0JBQ1IsWUFBWSxFQUFFLENBQUMsWUFBWSxFQUFFLDBCQUEwQixDQUFDO29CQUN4RCxPQUFPLEVBQUU7d0JBQ1AsWUFBWTt3QkFDWiwwQkFBMEI7d0JBQzFCLGlDQUFpQztxQkFDbEM7b0JBQ0QsT0FBTyxFQUFFLENBQUMsYUFBYSxFQUFFLHNCQUFzQixFQUFFLFlBQVksQ0FBQztpQkFDL0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBOR1RfT0JKRUNUX0lOUFVUU19DT05UUk9MTEVSX1BST1ZJREVSLFxuICBOR1RfT0JKRUNUX0lOUFVUU19XQVRDSEVEX0NPTlRST0xMRVIsXG4gIE5ndENvbG9yLFxuICBOZ3RNYXRlcmlhbCxcbiAgTmd0T2JqZWN0M2RJbnB1dHNDb250cm9sbGVyLFxuICBOZ3RPYmplY3QzZElucHV0c0NvbnRyb2xsZXJNb2R1bGUsXG4gIE5ndFNvYmFFeHRlbmRlcixcbn0gZnJvbSAnQGFuZ3VsYXItdGhyZWUvY29yZSc7XG5pbXBvcnQgeyBOZ3RQbGFuZUdlb21ldHJ5TW9kdWxlIH0gZnJvbSAnQGFuZ3VsYXItdGhyZWUvY29yZS9nZW9tZXRyaWVzJztcbmltcG9ydCB7IE5ndE1lc2hNb2R1bGUgfSBmcm9tICdAYW5ndWxhci10aHJlZS9jb3JlL21lc2hlcyc7XG5pbXBvcnQgeyBzaGFkZXJNYXRlcmlhbCB9IGZyb20gJ0Bhbmd1bGFyLXRocmVlL3NvYmEnO1xuaW1wb3J0IHsgTmd0VGV4dHVyZUxvYWRlclNlcnZpY2UgfSBmcm9tICdAYW5ndWxhci10aHJlZS9zb2JhL2xvYWRlcnMnO1xuaW1wb3J0IHsgQ29tbW9uTW9kdWxlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7XG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuICBDb21wb25lbnQsXG4gIERpcmVjdGl2ZSxcbiAgSW5qZWN0LFxuICBJbnB1dCxcbiAgTmdNb2R1bGUsXG4gIE9uQ2hhbmdlcyxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCB0YXAgfSBmcm9tICdyeGpzJztcbmltcG9ydCAqIGFzIFRIUkVFIGZyb20gJ3RocmVlJztcblxuZXhwb3J0IHR5cGUgTmd0U29iYUltYWdlU2hhZGVyTWF0ZXJpYWxQYXJhbWV0ZXJzID1cbiAgVEhSRUUuU2hhZGVyTWF0ZXJpYWxQYXJhbWV0ZXJzICYge1xuICAgIHNjYWxlPzogbnVtYmVyW107XG4gICAgaW1hZ2VCb3VuZHM/OiBudW1iZXJbXTtcbiAgICBjb2xvcj86IE5ndENvbG9yO1xuICAgIG1hcDogVEhSRUUuVGV4dHVyZTtcbiAgICB6b29tPzogbnVtYmVyO1xuICAgIGdyYXlzY2FsZT86IG51bWJlcjtcbiAgfTtcblxuZXhwb3J0IGNvbnN0IEltYWdlU2hhZGVyTWF0ZXJpYWwgPSBzaGFkZXJNYXRlcmlhbChcbiAge1xuICAgIGNvbG9yOiBuZXcgVEhSRUUuQ29sb3IoJ3doaXRlJyksXG4gICAgc2NhbGU6IFsxLCAxXSxcbiAgICBpbWFnZUJvdW5kczogWzEsIDFdLFxuICAgIG1hcDogbnVsbCxcbiAgICB6b29tOiAxLFxuICAgIGdyYXlzY2FsZTogMCxcbiAgfSxcbiAgLy8gbGFuZ3VhZ2U9Z2xzbFxuICBgXG4gIHZhcnlpbmcgdmVjMiB2VXY7XG4gIHZvaWQgbWFpbigpIHtcbiAgICBnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiB2aWV3TWF0cml4ICogbW9kZWxNYXRyaXggKiB2ZWM0KHBvc2l0aW9uLCAxLik7XG4gICAgdlV2ID0gdXY7XG4gIH1cbmAsXG4gIC8vIGxhbmd1YWdlPWdsc2xcbiAgYFxuICAvLyBtb3N0bHkgZnJvbSBodHRwczovL2dpc3QuZ2l0aHViLmNvbS9zdGF0aWNvL2RmNjRjNWQxNjczNjJlY2Y3YjM0ZmNhMGIxNDU5YTQ0XG4gIHZhcnlpbmcgdmVjMiB2VXY7XG4gIHVuaWZvcm0gdmVjMiBzY2FsZTtcbiAgdW5pZm9ybSB2ZWMyIGltYWdlQm91bmRzO1xuICB1bmlmb3JtIHZlYzMgY29sb3I7XG4gIHVuaWZvcm0gc2FtcGxlcjJEIG1hcDtcbiAgdW5pZm9ybSBmbG9hdCB6b29tO1xuICB1bmlmb3JtIGZsb2F0IGdyYXlzY2FsZTtcbiAgY29uc3QgdmVjMyBsdW1hID0gdmVjMyguMjk5LCAwLjU4NywgMC4xMTQpO1xuICB2ZWM0IHRvR3JheXNjYWxlKHZlYzQgY29sb3IsIGZsb2F0IGludGVuc2l0eSkge1xuICAgIHJldHVybiB2ZWM0KG1peChjb2xvci5yZ2IsIHZlYzMoZG90KGNvbG9yLnJnYiwgbHVtYSkpLCBpbnRlbnNpdHkpLCBjb2xvci5hKTtcbiAgfVxuICB2ZWMyIGFzcGVjdCh2ZWMyIHNpemUpIHtcbiAgICByZXR1cm4gc2l6ZSAvIG1pbihzaXplLngsIHNpemUueSk7XG4gIH1cbiAgdm9pZCBtYWluKCkge1xuICAgIHZlYzIgcyA9IGFzcGVjdChzY2FsZSk7XG4gICAgdmVjMiBpID0gYXNwZWN0KGltYWdlQm91bmRzKTtcbiAgICBmbG9hdCBycyA9IHMueCAvIHMueTtcbiAgICBmbG9hdCByaSA9IGkueCAvIGkueTtcbiAgICB2ZWMyIG5ldyA9IHJzIDwgcmkgPyB2ZWMyKGkueCAqIHMueSAvIGkueSwgcy55KSA6IHZlYzIocy54LCBpLnkgKiBzLnggLyBpLngpO1xuICAgIHZlYzIgb2Zmc2V0ID0gKHJzIDwgcmkgPyB2ZWMyKChuZXcueCAtIHMueCkgLyAyLjAsIDAuMCkgOiB2ZWMyKDAuMCwgKG5ldy55IC0gcy55KSAvIDIuMCkpIC8gbmV3O1xuICAgIHZlYzIgdXYgPSB2VXYgKiBzIC8gbmV3ICsgb2Zmc2V0O1xuICAgIHZlYzIgelV2ID0gKHV2IC0gdmVjMigwLjUsIDAuNSkpIC8gem9vbSArIHZlYzIoMC41LCAwLjUpO1xuICAgIGdsX0ZyYWdDb2xvciA9IHRvR3JheXNjYWxlKHRleHR1cmUyRChtYXAsIHpVdikgKiB2ZWM0KGNvbG9yLCAxLjApLCBncmF5c2NhbGUpO1xuICB9XG5gXG4pO1xuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICduZ3Qtc29iYS1pbWFnZS1zaGFkZXItbWF0ZXJpYWwnLFxuICBleHBvcnRBczogJ25ndFNvYmFJbWFnZVNoYWRlck1hdGVyaWFsJyxcbiAgcHJvdmlkZXJzOiBbXG4gICAgeyBwcm92aWRlOiBOZ3RNYXRlcmlhbCwgdXNlRXhpc3Rpbmc6IE5ndFNvYmFJbWFnZVNoYWRlck1hdGVyaWFsIH0sXG4gIF0sXG59KVxuZXhwb3J0IGNsYXNzIE5ndFNvYmFJbWFnZVNoYWRlck1hdGVyaWFsIGV4dGVuZHMgTmd0TWF0ZXJpYWw8XG4gIE5ndFNvYmFJbWFnZVNoYWRlck1hdGVyaWFsUGFyYW1ldGVycyxcbiAgdHlwZW9mIEltYWdlU2hhZGVyTWF0ZXJpYWwucHJvdG90eXBlXG4+IHtcbiAgc3RhdGljIG5nQWNjZXB0SW5wdXRUeXBlX3BhcmFtZXRlcnM6XG4gICAgfCBOZ3RTb2JhSW1hZ2VTaGFkZXJNYXRlcmlhbFBhcmFtZXRlcnNcbiAgICB8IHVuZGVmaW5lZDtcblxuICBtYXRlcmlhbFR5cGUgPSBJbWFnZVNoYWRlck1hdGVyaWFsO1xufVxuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICduZ3Qtc29iYS1pbWFnZVt1cmxdJyxcbiAgdGVtcGxhdGU6IGBcbiAgICA8bmctY29udGFpbmVyICpuZ0lmPVwidGV4dHVyZSQgfCBhc3luYyBhcyB0ZXh0dXJlXCI+XG4gICAgICA8bmd0LW1lc2hcbiAgICAgICAgW3NjYWxlXT1cInNjYWxlXCJcbiAgICAgICAgW29iamVjdDNkSW5wdXRzQ29udHJvbGxlcl09XCJvYmplY3RJbnB1dHNDb250cm9sbGVyXCJcbiAgICAgICAgKHJlYWR5KT1cIm9iamVjdCA9ICRldmVudFwiXG4gICAgICA+XG4gICAgICAgIDxuZ3QtcGxhbmUtZ2VvbWV0cnlcbiAgICAgICAgICBbYXJnc109XCJbMSwgMSwgc2VnbWVudHMsIHNlZ21lbnRzXVwiXG4gICAgICAgID48L25ndC1wbGFuZS1nZW9tZXRyeT5cbiAgICAgICAgPG5ndC1zb2JhLWltYWdlLXNoYWRlci1tYXRlcmlhbFxuICAgICAgICAgIFtwYXJhbWV0ZXJzXT1cIntjb2xvciwgbWFwOiB0ZXh0dXJlLCB6b29tLCBncmF5c2NhbGUsIHNjYWxlOiBwbGFuZUJvdW5kcywgaW1hZ2VCb3VuZHN9XCJcbiAgICAgICAgPjwvbmd0LXNvYmEtaW1hZ2Utc2hhZGVyLW1hdGVyaWFsPlxuICAgICAgICA8bmctY29udGVudD48L25nLWNvbnRlbnQ+XG4gICAgICA8L25ndC1tZXNoPlxuICAgIDwvbmctY29udGFpbmVyPlxuICBgLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbiAgcHJvdmlkZXJzOiBbXG4gICAgTkdUX09CSkVDVF9JTlBVVFNfQ09OVFJPTExFUl9QUk9WSURFUixcbiAgICB7IHByb3ZpZGU6IE5ndFNvYmFFeHRlbmRlciwgdXNlRXhpc3Rpbmc6IE5ndFNvYmFJbWFnZSB9LFxuICBdLFxufSlcbmV4cG9ydCBjbGFzcyBOZ3RTb2JhSW1hZ2VcbiAgZXh0ZW5kcyBOZ3RTb2JhRXh0ZW5kZXI8VEhSRUUuTWVzaD5cbiAgaW1wbGVtZW50cyBPbkNoYW5nZXNcbntcbiAgQElucHV0KCkgc2VnbWVudHM/OiBudW1iZXI7XG4gIEBJbnB1dCgpIHNjYWxlPzogbnVtYmVyO1xuICBASW5wdXQoKSBjb2xvcj86IE5ndENvbG9yO1xuICBASW5wdXQoKSB6b29tPzogbnVtYmVyO1xuICBASW5wdXQoKSBncmF5c2NhbGU/OiBudW1iZXI7XG5cbiAgQElucHV0KCkgc2V0IHVybCh2OiBzdHJpbmcpIHtcbiAgICB0aGlzLnRleHR1cmUkID0gdGhpcy50ZXh0dXJlTG9hZGVyU2VydmljZS5sb2FkKHYpLnBpcGUoXG4gICAgICB0YXAoKHRleHR1cmUpID0+IHtcbiAgICAgICAgdGhpcy5pbWFnZUJvdW5kcyA9IFt0ZXh0dXJlLmltYWdlLndpZHRoLCB0ZXh0dXJlLmltYWdlLmhlaWdodF07XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwbGFuZUJvdW5kcz86IFtudW1iZXIsIG51bWJlcl07XG4gIGltYWdlQm91bmRzPzogW251bWJlciwgbnVtYmVyXTtcblxuICB0ZXh0dXJlJD86IE9ic2VydmFibGU8VEhSRUUuVGV4dHVyZT47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB0ZXh0dXJlTG9hZGVyU2VydmljZTogTmd0VGV4dHVyZUxvYWRlclNlcnZpY2UsXG4gICAgQEluamVjdChOR1RfT0JKRUNUX0lOUFVUU19XQVRDSEVEX0NPTlRST0xMRVIpXG4gICAgcHVibGljIG9iamVjdElucHV0c0NvbnRyb2xsZXI6IE5ndE9iamVjdDNkSW5wdXRzQ29udHJvbGxlclxuICApIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoKSB7XG4gICAgdGhpcy5wbGFuZUJvdW5kcyA9IEFycmF5LmlzQXJyYXkodGhpcy5zY2FsZSlcbiAgICAgID8gW3RoaXMuc2NhbGVbMF0sIHRoaXMuc2NhbGVbMV1dXG4gICAgICA6IFt0aGlzLnNjYWxlLCB0aGlzLnNjYWxlXTtcbiAgfVxufVxuXG5ATmdNb2R1bGUoe1xuICBkZWNsYXJhdGlvbnM6IFtOZ3RTb2JhSW1hZ2UsIE5ndFNvYmFJbWFnZVNoYWRlck1hdGVyaWFsXSxcbiAgZXhwb3J0czogW1xuICAgIE5ndFNvYmFJbWFnZSxcbiAgICBOZ3RTb2JhSW1hZ2VTaGFkZXJNYXRlcmlhbCxcbiAgICBOZ3RPYmplY3QzZElucHV0c0NvbnRyb2xsZXJNb2R1bGUsXG4gIF0sXG4gIGltcG9ydHM6IFtOZ3RNZXNoTW9kdWxlLCBOZ3RQbGFuZUdlb21ldHJ5TW9kdWxlLCBDb21tb25Nb2R1bGVdLFxufSlcbmV4cG9ydCBjbGFzcyBOZ3RTb2JhSW1hZ2VNb2R1bGUge31cbiJdfQ==