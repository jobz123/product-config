var _NgtSobaGizmoHelperStore_instances, _NgtSobaGizmoHelperStore_animating, _NgtSobaGizmoHelperStore_focusPoint, _NgtSobaGizmoHelperStore_radius, _NgtSobaGizmoHelperStore_ready$, _NgtSobaGizmoHelperStore_animateStep, _NgtSobaGizmoHelperStore_beforeRender;
import { __classPrivateFieldGet, __classPrivateFieldSet } from "tslib";
import { EnhancedRxState, NGT_OBJECT_INPUTS_WATCHED_CONTROLLER, NgtAnimationFrameStore, NgtLoopService, NgtObject3dInputsController, NgtStore, } from '@angular-three/core';
import { Inject, Injectable, NgZone } from '@angular/core';
import { selectSlice } from '@rx-angular/state';
import { combineLatest, filter, map } from 'rxjs';
import * as THREE from 'three';
import * as i0 from "@angular/core";
import * as i1 from "@angular-three/core";
const turnRate = 2 * Math.PI; // turn rate in angles per second
const dummy = new THREE.Object3D();
const matrix = new THREE.Matrix4();
const [q1, q2] = [new THREE.Quaternion(), new THREE.Quaternion()];
const target = new THREE.Vector3();
const targetPosition = new THREE.Vector3();
export class NgtSobaGizmoHelperStore extends EnhancedRxState {
    constructor(objectInputsController, animationFrameStore, ngZone, store, loopService) {
        super();
        this.store = store;
        this.loopService = loopService;
        _NgtSobaGizmoHelperStore_instances.add(this);
        _NgtSobaGizmoHelperStore_animating.set(this, false);
        _NgtSobaGizmoHelperStore_focusPoint.set(this, new THREE.Vector3());
        _NgtSobaGizmoHelperStore_radius.set(this, 0);
        this.actions = this.create();
        this.gizmoProps$ = combineLatest([
            this.select(selectSlice(['margin', 'alignment', 'objectInputsController'])),
            this.store.select('size'),
        ]).pipe(map(([{ alignment, margin: [marginX, marginY], objectInputsController, }, size,]) => {
            const x = alignment.endsWith('-left')
                ? -size.width / 2 + marginX
                : size.width / 2 - marginX;
            const y = alignment.startsWith('top-')
                ? size.height / 2 - marginY
                : -size.height / 2 + marginY;
            objectInputsController.position = [x, y, 0];
            return {
                objectInputsController,
                x,
                y,
            };
        }));
        _NgtSobaGizmoHelperStore_ready$.set(this, combineLatest([
            this.actions.init$,
            this.store.select('ready').pipe(filter((ready) => ready)),
        ]));
        const virtualScene = new THREE.Scene();
        objectInputsController.appendTo = virtualScene;
        this.set({
            alignment: 'bottom-right',
            margin: [80, 80],
            renderPriority: 0,
            virtualScene,
            objectInputsController,
        });
        this.holdEffect(__classPrivateFieldGet(this, _NgtSobaGizmoHelperStore_ready$, "f"), () => {
            return ngZone.runOutsideAngular(() => {
                let mainSceneBackground;
                const scene = this.store.get('scene');
                const virtualScene = this.get('virtualScene');
                if (scene.background) {
                    mainSceneBackground = scene.background;
                    scene.background = null;
                    virtualScene.background = mainSceneBackground;
                }
                return () => {
                    if (mainSceneBackground) {
                        scene.background = mainSceneBackground;
                    }
                };
            });
        });
        this.holdEffect(__classPrivateFieldGet(this, _NgtSobaGizmoHelperStore_ready$, "f"), () => {
            return ngZone.runOutsideAngular(() => {
                const priority = this.get('renderPriority');
                const renderer = this.store.get('renderer');
                const animationUuid = animationFrameStore.register({
                    callback: ({ delta }) => {
                        const { virtualScene, virtualCamera, gizmo } = this.get();
                        if (virtualCamera && gizmo) {
                            __classPrivateFieldGet(this, _NgtSobaGizmoHelperStore_instances, "m", _NgtSobaGizmoHelperStore_animateStep).call(this, delta);
                            __classPrivateFieldGet(this, _NgtSobaGizmoHelperStore_instances, "m", _NgtSobaGizmoHelperStore_beforeRender).call(this);
                            renderer.autoClear = false;
                            renderer.clearDepth();
                            renderer.render(virtualScene, virtualCamera);
                        }
                    },
                    priority,
                });
                return () => {
                    animationFrameStore.actions.unsubscriberUuid(animationUuid);
                };
            });
        });
        this.connect('raycast', this.select('virtualCamera'), (_, virtualCamera) => {
            const mouse = this.store.get('mouse');
            const raycaster = new THREE.Raycaster();
            return function (_, intersects) {
                raycaster.setFromCamera(mouse, virtualCamera);
                const rc = this.constructor.prototype.raycast.bind(this);
                if (rc) {
                    rc(raycaster, intersects);
                }
            };
        });
    }
    tweenCamera(direction) {
        const { controls: defaultControls, camera: mainCamera } = this.store.get();
        __classPrivateFieldSet(this, _NgtSobaGizmoHelperStore_animating, true, "f");
        if (defaultControls) {
            __classPrivateFieldSet(this, _NgtSobaGizmoHelperStore_focusPoint, defaultControls.target, "f");
        }
        __classPrivateFieldSet(this, _NgtSobaGizmoHelperStore_radius, mainCamera.position.distanceTo(target), "f");
        // Rotate from current camera orientation
        q1.copy(mainCamera.quaternion);
        // To new current camera orientation
        targetPosition.copy(direction).multiplyScalar(__classPrivateFieldGet(this, _NgtSobaGizmoHelperStore_radius, "f")).add(target);
        dummy.lookAt(targetPosition);
        q2.copy(dummy.quaternion);
        this.loopService.invalidate();
    }
}
_NgtSobaGizmoHelperStore_animating = new WeakMap(), _NgtSobaGizmoHelperStore_focusPoint = new WeakMap(), _NgtSobaGizmoHelperStore_radius = new WeakMap(), _NgtSobaGizmoHelperStore_ready$ = new WeakMap(), _NgtSobaGizmoHelperStore_instances = new WeakSet(), _NgtSobaGizmoHelperStore_animateStep = function _NgtSobaGizmoHelperStore_animateStep(delta) {
    if (!__classPrivateFieldGet(this, _NgtSobaGizmoHelperStore_animating, "f"))
        return;
    if (q1.angleTo(q2) < 0.01) {
        __classPrivateFieldSet(this, _NgtSobaGizmoHelperStore_animating, false, "f");
        return;
    }
    const { controls: defaultControls, camera: mainCamera } = this.store.get();
    const step = delta * turnRate;
    // animate position by doing a lerp and then scaling the position on the unit sphere
    q1.rotateTowards(q2, step);
    // animate orientation
    mainCamera.position
        .set(0, 0, 1)
        .applyQuaternion(q1)
        .multiplyScalar(__classPrivateFieldGet(this, _NgtSobaGizmoHelperStore_radius, "f"))
        .add(__classPrivateFieldGet(this, _NgtSobaGizmoHelperStore_focusPoint, "f"));
    mainCamera.up.set(0, 1, 0).applyQuaternion(q1).normalize();
    mainCamera.quaternion.copy(q1);
    if (defaultControls) {
        defaultControls.update();
    }
    this.loopService.invalidate();
}, _NgtSobaGizmoHelperStore_beforeRender = function _NgtSobaGizmoHelperStore_beforeRender() {
    const mainCamera = this.store.get('camera');
    const gizmo = this.get('gizmo');
    // sync gizmo with main camera orientation
    matrix.copy(mainCamera.matrix).invert();
    gizmo?.quaternion.setFromRotationMatrix(matrix);
};
NgtSobaGizmoHelperStore.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaGizmoHelperStore, deps: [{ token: NGT_OBJECT_INPUTS_WATCHED_CONTROLLER }, { token: i1.NgtAnimationFrameStore }, { token: i0.NgZone }, { token: i1.NgtStore }, { token: i1.NgtLoopService }], target: i0.ɵɵFactoryTarget.Injectable });
NgtSobaGizmoHelperStore.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaGizmoHelperStore });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaGizmoHelperStore, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.NgtObject3dInputsController, decorators: [{
                    type: Inject,
                    args: [NGT_OBJECT_INPUTS_WATCHED_CONTROLLER]
                }] }, { type: i1.NgtAnimationFrameStore }, { type: i0.NgZone }, { type: i1.NgtStore }, { type: i1.NgtLoopService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2l6bW8taGVscGVyLnN0b3JlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvc29iYS9hYnN0cmFjdGlvbnMvc3JjL2dpem1vLWhlbHBlci9naXptby1oZWxwZXIuc3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxPQUFPLEVBQ0wsZUFBZSxFQUNmLG9DQUFvQyxFQUNwQyxzQkFBc0IsRUFDdEIsY0FBYyxFQUNkLDJCQUEyQixFQUMzQixRQUFRLEdBQ1QsTUFBTSxxQkFBcUIsQ0FBQztBQUM3QixPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0QsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsRCxPQUFPLEtBQUssS0FBSyxNQUFNLE9BQU8sQ0FBQzs7O0FBRS9CLE1BQU0sUUFBUSxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsaUNBQWlDO0FBQy9ELE1BQU0sS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDO0FBQ25DLE1BQU0sTUFBTSxHQUFHLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQ25DLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEtBQUssQ0FBQyxVQUFVLEVBQUUsRUFBRSxJQUFJLEtBQUssQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO0FBQ2xFLE1BQU0sTUFBTSxHQUFHLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQ25DLE1BQU0sY0FBYyxHQUFHLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBZ0IzQyxNQUFNLE9BQU8sdUJBQXdCLFNBQVEsZUFHNUM7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QUFDLENBQUM7SUFDekIsVUFBVSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDM0QsVUFBVSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7SUFFL0IsSUFBSSxlQUFlLEVBQUU7UUFDbEIsZUFBNEMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztLQUN4RDtJQUVELElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLENBQUM7QUFDaEMsQ0FBQztJQUdDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzVDLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFaEMsMENBQTBDO0lBQzFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ3hDLEtBQUssRUFBRSxVQUFVLENBQUMscUJBQXFCLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDbEQsQ0FBQztvSEExTFUsdUJBQXVCLGtCQThDeEIsb0NBQW9DO3dIQTlDbkMsdUJBQXVCOzJGQUF2Qix1QkFBdUI7a0JBRG5DLFVBQVU7OzBCQStDTixNQUFNOzJCQUFDLG9DQUFvQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEVuaGFuY2VkUnhTdGF0ZSxcbiAgTkdUX09CSkVDVF9JTlBVVFNfV0FUQ0hFRF9DT05UUk9MTEVSLFxuICBOZ3RBbmltYXRpb25GcmFtZVN0b3JlLFxuICBOZ3RMb29wU2VydmljZSxcbiAgTmd0T2JqZWN0M2RJbnB1dHNDb250cm9sbGVyLFxuICBOZ3RTdG9yZSxcbn0gZnJvbSAnQGFuZ3VsYXItdGhyZWUvY29yZSc7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIE5nWm9uZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgc2VsZWN0U2xpY2UgfSBmcm9tICdAcngtYW5ndWxhci9zdGF0ZSc7XG5pbXBvcnQgeyBjb21iaW5lTGF0ZXN0LCBmaWx0ZXIsIG1hcCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0ICogYXMgVEhSRUUgZnJvbSAndGhyZWUnO1xuXG5jb25zdCB0dXJuUmF0ZSA9IDIgKiBNYXRoLlBJOyAvLyB0dXJuIHJhdGUgaW4gYW5nbGVzIHBlciBzZWNvbmRcbmNvbnN0IGR1bW15ID0gbmV3IFRIUkVFLk9iamVjdDNEKCk7XG5jb25zdCBtYXRyaXggPSBuZXcgVEhSRUUuTWF0cml4NCgpO1xuY29uc3QgW3ExLCBxMl0gPSBbbmV3IFRIUkVFLlF1YXRlcm5pb24oKSwgbmV3IFRIUkVFLlF1YXRlcm5pb24oKV07XG5jb25zdCB0YXJnZXQgPSBuZXcgVEhSRUUuVmVjdG9yMygpO1xuY29uc3QgdGFyZ2V0UG9zaXRpb24gPSBuZXcgVEhSRUUuVmVjdG9yMygpO1xuXG50eXBlIENvbnRyb2xzUHJvdG8gPSB7IHVwZGF0ZSgpOiB2b2lkOyB0YXJnZXQ6IFRIUkVFLlZlY3RvcjMgfTtcblxuZXhwb3J0IGludGVyZmFjZSBOZ3RTb2JhR2l6bW9IZWxwZXJTdGF0ZSB7XG4gIGFsaWdubWVudDogJ3RvcC1sZWZ0JyB8ICd0b3AtcmlnaHQnIHwgJ2JvdHRvbS1yaWdodCcgfCAnYm90dG9tLWxlZnQnO1xuICBtYXJnaW46IFtudW1iZXIsIG51bWJlcl07XG4gIHJlbmRlclByaW9yaXR5OiBudW1iZXI7XG4gIHZpcnR1YWxTY2VuZTogVEhSRUUuU2NlbmU7XG4gIHZpcnR1YWxDYW1lcmE6IFRIUkVFLkNhbWVyYTtcbiAgZ2l6bW86IFRIUkVFLkdyb3VwO1xuICByYXljYXN0OiBUSFJFRS5PYmplY3QzRFsncmF5Y2FzdCddO1xuICBvYmplY3RJbnB1dHNDb250cm9sbGVyOiBOZ3RPYmplY3QzZElucHV0c0NvbnRyb2xsZXI7XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBOZ3RTb2JhR2l6bW9IZWxwZXJTdG9yZSBleHRlbmRzIEVuaGFuY2VkUnhTdGF0ZTxcbiAgTmd0U29iYUdpem1vSGVscGVyU3RhdGUsXG4gIHsgaW5pdDogdm9pZCB9XG4+IHtcbiAgI2FuaW1hdGluZyA9IGZhbHNlO1xuICAjZm9jdXNQb2ludCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7XG4gICNyYWRpdXMgPSAwO1xuXG4gIGFjdGlvbnMgPSB0aGlzLmNyZWF0ZSgpO1xuXG4gIHJlYWRvbmx5IGdpem1vUHJvcHMkID0gY29tYmluZUxhdGVzdChbXG4gICAgdGhpcy5zZWxlY3Qoc2VsZWN0U2xpY2UoWydtYXJnaW4nLCAnYWxpZ25tZW50JywgJ29iamVjdElucHV0c0NvbnRyb2xsZXInXSkpLFxuICAgIHRoaXMuc3RvcmUuc2VsZWN0KCdzaXplJyksXG4gIF0pLnBpcGUoXG4gICAgbWFwKFxuICAgICAgKFtcbiAgICAgICAge1xuICAgICAgICAgIGFsaWdubWVudCxcbiAgICAgICAgICBtYXJnaW46IFttYXJnaW5YLCBtYXJnaW5ZXSxcbiAgICAgICAgICBvYmplY3RJbnB1dHNDb250cm9sbGVyLFxuICAgICAgICB9LFxuICAgICAgICBzaXplLFxuICAgICAgXSkgPT4ge1xuICAgICAgICBjb25zdCB4ID0gYWxpZ25tZW50LmVuZHNXaXRoKCctbGVmdCcpXG4gICAgICAgICAgPyAtc2l6ZS53aWR0aCAvIDIgKyBtYXJnaW5YXG4gICAgICAgICAgOiBzaXplLndpZHRoIC8gMiAtIG1hcmdpblg7XG4gICAgICAgIGNvbnN0IHkgPSBhbGlnbm1lbnQuc3RhcnRzV2l0aCgndG9wLScpXG4gICAgICAgICAgPyBzaXplLmhlaWdodCAvIDIgLSBtYXJnaW5ZXG4gICAgICAgICAgOiAtc2l6ZS5oZWlnaHQgLyAyICsgbWFyZ2luWTtcblxuICAgICAgICBvYmplY3RJbnB1dHNDb250cm9sbGVyLnBvc2l0aW9uID0gW3gsIHksIDBdO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG9iamVjdElucHV0c0NvbnRyb2xsZXIsXG4gICAgICAgICAgeCxcbiAgICAgICAgICB5LFxuICAgICAgICB9O1xuICAgICAgfVxuICAgIClcbiAgKTtcblxuICAjcmVhZHkkID0gY29tYmluZUxhdGVzdChbXG4gICAgdGhpcy5hY3Rpb25zLmluaXQkLFxuICAgIHRoaXMuc3RvcmUuc2VsZWN0KCdyZWFkeScpLnBpcGUoZmlsdGVyKChyZWFkeSkgPT4gcmVhZHkpKSxcbiAgXSk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChOR1RfT0JKRUNUX0lOUFVUU19XQVRDSEVEX0NPTlRST0xMRVIpXG4gICAgb2JqZWN0SW5wdXRzQ29udHJvbGxlcjogTmd0T2JqZWN0M2RJbnB1dHNDb250cm9sbGVyLFxuICAgIGFuaW1hdGlvbkZyYW1lU3RvcmU6IE5ndEFuaW1hdGlvbkZyYW1lU3RvcmUsXG4gICAgbmdab25lOiBOZ1pvbmUsXG4gICAgcHJpdmF0ZSBzdG9yZTogTmd0U3RvcmUsXG4gICAgcHJpdmF0ZSBsb29wU2VydmljZTogTmd0TG9vcFNlcnZpY2VcbiAgKSB7XG4gICAgc3VwZXIoKTtcblxuICAgIGNvbnN0IHZpcnR1YWxTY2VuZSA9IG5ldyBUSFJFRS5TY2VuZSgpO1xuICAgIG9iamVjdElucHV0c0NvbnRyb2xsZXIuYXBwZW5kVG8gPSB2aXJ0dWFsU2NlbmU7XG5cbiAgICB0aGlzLnNldCh7XG4gICAgICBhbGlnbm1lbnQ6ICdib3R0b20tcmlnaHQnLFxuICAgICAgbWFyZ2luOiBbODAsIDgwXSxcbiAgICAgIHJlbmRlclByaW9yaXR5OiAwLFxuICAgICAgdmlydHVhbFNjZW5lLFxuICAgICAgb2JqZWN0SW5wdXRzQ29udHJvbGxlcixcbiAgICB9KTtcblxuICAgIHRoaXMuaG9sZEVmZmVjdCh0aGlzLiNyZWFkeSQsICgpID0+IHtcbiAgICAgIHJldHVybiBuZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgICBsZXQgbWFpblNjZW5lQmFja2dyb3VuZDogVEhSRUUuU2NlbmVbJ2JhY2tncm91bmQnXTtcbiAgICAgICAgY29uc3Qgc2NlbmUgPSB0aGlzLnN0b3JlLmdldCgnc2NlbmUnKTtcbiAgICAgICAgY29uc3QgdmlydHVhbFNjZW5lID0gdGhpcy5nZXQoJ3ZpcnR1YWxTY2VuZScpO1xuXG4gICAgICAgIGlmIChzY2VuZS5iYWNrZ3JvdW5kKSB7XG4gICAgICAgICAgbWFpblNjZW5lQmFja2dyb3VuZCA9IHNjZW5lLmJhY2tncm91bmQ7XG4gICAgICAgICAgc2NlbmUuYmFja2dyb3VuZCA9IG51bGw7XG4gICAgICAgICAgdmlydHVhbFNjZW5lLmJhY2tncm91bmQgPSBtYWluU2NlbmVCYWNrZ3JvdW5kO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgICBpZiAobWFpblNjZW5lQmFja2dyb3VuZCkge1xuICAgICAgICAgICAgc2NlbmUuYmFja2dyb3VuZCA9IG1haW5TY2VuZUJhY2tncm91bmQ7XG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICB0aGlzLmhvbGRFZmZlY3QodGhpcy4jcmVhZHkkLCAoKSA9PiB7XG4gICAgICByZXR1cm4gbmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgICAgY29uc3QgcHJpb3JpdHkgPSB0aGlzLmdldCgncmVuZGVyUHJpb3JpdHknKTtcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSB0aGlzLnN0b3JlLmdldCgncmVuZGVyZXInKTtcblxuICAgICAgICBjb25zdCBhbmltYXRpb25VdWlkID0gYW5pbWF0aW9uRnJhbWVTdG9yZS5yZWdpc3Rlcih7XG4gICAgICAgICAgY2FsbGJhY2s6ICh7IGRlbHRhIH0pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHsgdmlydHVhbFNjZW5lLCB2aXJ0dWFsQ2FtZXJhLCBnaXptbyB9ID0gdGhpcy5nZXQoKTtcbiAgICAgICAgICAgIGlmICh2aXJ0dWFsQ2FtZXJhICYmIGdpem1vKSB7XG4gICAgICAgICAgICAgIHRoaXMuI2FuaW1hdGVTdGVwKGRlbHRhKTtcbiAgICAgICAgICAgICAgdGhpcy4jYmVmb3JlUmVuZGVyKCk7XG4gICAgICAgICAgICAgIHJlbmRlcmVyLmF1dG9DbGVhciA9IGZhbHNlO1xuICAgICAgICAgICAgICByZW5kZXJlci5jbGVhckRlcHRoKCk7XG4gICAgICAgICAgICAgIHJlbmRlcmVyLnJlbmRlcih2aXJ0dWFsU2NlbmUsIHZpcnR1YWxDYW1lcmEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0sXG4gICAgICAgICAgcHJpb3JpdHksXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAgICAgYW5pbWF0aW9uRnJhbWVTdG9yZS5hY3Rpb25zLnVuc3Vic2NyaWJlclV1aWQoYW5pbWF0aW9uVXVpZCk7XG4gICAgICAgIH07XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIHRoaXMuY29ubmVjdChcbiAgICAgICdyYXljYXN0JyxcbiAgICAgIHRoaXMuc2VsZWN0KCd2aXJ0dWFsQ2FtZXJhJyksXG4gICAgICAoXywgdmlydHVhbENhbWVyYSkgPT4ge1xuICAgICAgICBjb25zdCBtb3VzZSA9IHRoaXMuc3RvcmUuZ2V0KCdtb3VzZScpO1xuICAgICAgICBjb25zdCByYXljYXN0ZXIgPSBuZXcgVEhSRUUuUmF5Y2FzdGVyKCk7XG5cbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh0aGlzOiBUSFJFRS5PYmplY3QzRCwgXywgaW50ZXJzZWN0cykge1xuICAgICAgICAgIHJheWNhc3Rlci5zZXRGcm9tQ2FtZXJhKG1vdXNlLCB2aXJ0dWFsQ2FtZXJhKTtcbiAgICAgICAgICBjb25zdCByYyA9IHRoaXMuY29uc3RydWN0b3IucHJvdG90eXBlLnJheWNhc3QuYmluZCh0aGlzKTtcbiAgICAgICAgICBpZiAocmMpIHtcbiAgICAgICAgICAgIHJjKHJheWNhc3RlciwgaW50ZXJzZWN0cyk7XG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICB0d2VlbkNhbWVyYShkaXJlY3Rpb246IFRIUkVFLlZlY3RvcjMpIHtcbiAgICBjb25zdCB7IGNvbnRyb2xzOiBkZWZhdWx0Q29udHJvbHMsIGNhbWVyYTogbWFpbkNhbWVyYSB9ID0gdGhpcy5zdG9yZS5nZXQoKTtcbiAgICB0aGlzLiNhbmltYXRpbmcgPSB0cnVlO1xuXG4gICAgaWYgKGRlZmF1bHRDb250cm9scykge1xuICAgICAgdGhpcy4jZm9jdXNQb2ludCA9IChkZWZhdWx0Q29udHJvbHMgYXMgdW5rbm93biBhcyBDb250cm9sc1Byb3RvKS50YXJnZXQ7XG4gICAgfVxuICAgIHRoaXMuI3JhZGl1cyA9IG1haW5DYW1lcmEucG9zaXRpb24uZGlzdGFuY2VUbyh0YXJnZXQpO1xuXG4gICAgLy8gUm90YXRlIGZyb20gY3VycmVudCBjYW1lcmEgb3JpZW50YXRpb25cbiAgICBxMS5jb3B5KG1haW5DYW1lcmEucXVhdGVybmlvbik7XG5cbiAgICAvLyBUbyBuZXcgY3VycmVudCBjYW1lcmEgb3JpZW50YXRpb25cbiAgICB0YXJnZXRQb3NpdGlvbi5jb3B5KGRpcmVjdGlvbikubXVsdGlwbHlTY2FsYXIodGhpcy4jcmFkaXVzKS5hZGQodGFyZ2V0KTtcbiAgICBkdW1teS5sb29rQXQodGFyZ2V0UG9zaXRpb24pO1xuICAgIHEyLmNvcHkoZHVtbXkucXVhdGVybmlvbik7XG5cbiAgICB0aGlzLmxvb3BTZXJ2aWNlLmludmFsaWRhdGUoKTtcbiAgfVxuXG4gICNhbmltYXRlU3RlcChkZWx0YTogbnVtYmVyKSB7XG4gICAgaWYgKCF0aGlzLiNhbmltYXRpbmcpIHJldHVybjtcblxuICAgIGlmIChxMS5hbmdsZVRvKHEyKSA8IDAuMDEpIHtcbiAgICAgIHRoaXMuI2FuaW1hdGluZyA9IGZhbHNlO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHsgY29udHJvbHM6IGRlZmF1bHRDb250cm9scywgY2FtZXJhOiBtYWluQ2FtZXJhIH0gPSB0aGlzLnN0b3JlLmdldCgpO1xuICAgIGNvbnN0IHN0ZXAgPSBkZWx0YSAqIHR1cm5SYXRlO1xuXG4gICAgLy8gYW5pbWF0ZSBwb3NpdGlvbiBieSBkb2luZyBhIGxlcnAgYW5kIHRoZW4gc2NhbGluZyB0aGUgcG9zaXRpb24gb24gdGhlIHVuaXQgc3BoZXJlXG4gICAgcTEucm90YXRlVG93YXJkcyhxMiwgc3RlcCk7XG5cbiAgICAvLyBhbmltYXRlIG9yaWVudGF0aW9uXG4gICAgbWFpbkNhbWVyYS5wb3NpdGlvblxuICAgICAgLnNldCgwLCAwLCAxKVxuICAgICAgLmFwcGx5UXVhdGVybmlvbihxMSlcbiAgICAgIC5tdWx0aXBseVNjYWxhcih0aGlzLiNyYWRpdXMpXG4gICAgICAuYWRkKHRoaXMuI2ZvY3VzUG9pbnQpO1xuICAgIG1haW5DYW1lcmEudXAuc2V0KDAsIDEsIDApLmFwcGx5UXVhdGVybmlvbihxMSkubm9ybWFsaXplKCk7XG4gICAgbWFpbkNhbWVyYS5xdWF0ZXJuaW9uLmNvcHkocTEpO1xuXG4gICAgaWYgKGRlZmF1bHRDb250cm9scykge1xuICAgICAgKGRlZmF1bHRDb250cm9scyBhcyB1bmtub3duIGFzIENvbnRyb2xzUHJvdG8pLnVwZGF0ZSgpO1xuICAgIH1cblxuICAgIHRoaXMubG9vcFNlcnZpY2UuaW52YWxpZGF0ZSgpO1xuICB9XG5cbiAgI2JlZm9yZVJlbmRlcigpIHtcbiAgICBjb25zdCBtYWluQ2FtZXJhID0gdGhpcy5zdG9yZS5nZXQoJ2NhbWVyYScpO1xuICAgIGNvbnN0IGdpem1vID0gdGhpcy5nZXQoJ2dpem1vJyk7XG5cbiAgICAvLyBzeW5jIGdpem1vIHdpdGggbWFpbiBjYW1lcmEgb3JpZW50YXRpb25cbiAgICBtYXRyaXguY29weShtYWluQ2FtZXJhLm1hdHJpeCkuaW52ZXJ0KCk7XG4gICAgZ2l6bW8/LnF1YXRlcm5pb24uc2V0RnJvbVJvdGF0aW9uTWF0cml4KG1hdHJpeCk7XG4gIH1cbn1cbiJdfQ==