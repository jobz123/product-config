var _NgtSobaOrbitControls_controlsEventsChanges$, _NgtSobaOrbitControls_makeDefaultParams$, _NgtSobaOrbitControls_controlsTargetParams$;
import { __classPrivateFieldGet } from "tslib";
import { EnhancedRxState, makeVector3, NgtAnimationFrameStore, NgtEventsStore, NgtLoopService, NgtPerformanceStore, NgtStore, } from '@angular-three/core';
import { Directive, EventEmitter, Input, NgModule, NgZone, Output, } from '@angular/core';
import { selectSlice } from '@rx-angular/state';
import { of, switchMap } from 'rxjs';
import * as THREE from 'three';
import { OrbitControls } from 'three-stdlib/controls/OrbitControls';
import * as i0 from "@angular/core";
import * as i1 from "@angular-three/core";
export class NgtSobaOrbitControls extends EnhancedRxState {
    constructor(loopService, store, eventsStore, animationFrameStore, performanceStore, ngZone) {
        super();
        this.loopService = loopService;
        this.store = store;
        this.eventsStore = eventsStore;
        this.animationFrameStore = animationFrameStore;
        this.performanceStore = performanceStore;
        this.ngZone = ngZone;
        this.ready = this.select('controls');
        this.change = new EventEmitter();
        this.start = new EventEmitter();
        this.end = new EventEmitter();
        _NgtSobaOrbitControls_controlsEventsChanges$.set(this, this.select(selectSlice(['regress', 'controls', 'domElement'])));
        _NgtSobaOrbitControls_makeDefaultParams$.set(this, this.select(selectSlice(['makeDefault', 'controls'])));
        _NgtSobaOrbitControls_controlsTargetParams$.set(this, this.select(selectSlice(['target', 'controls'])));
        this.set({
            target: undefined,
            regress: false,
            enableDamping: true,
            makeDefault: false,
            camera: undefined,
            domElement: undefined,
        });
    }
    set target(v) {
        this.set({ target: v });
    }
    set camera(v) {
        this.set({ camera: v });
    }
    set domElement(v) {
        this.set({ domElement: v });
    }
    set regress(v) {
        this.set({ regress: v });
    }
    set enableDamping(v) {
        this.set({ enableDamping: v });
    }
    set makeDefault(v) {
        this.set({ makeDefault: v });
    }
    ngOnInit() {
        this.connect('camera', this.store.select('camera'));
        this.connect('domElement', this.eventsStore.select('connected').pipe(switchMap((connected) => {
            if (typeof connected !== 'boolean')
                return of(connected);
            return this.store.select('renderer', 'domElement');
        })));
        this.holdEffect(this.select('controls'), (controls) => {
            let animationUuid;
            if (controls.enabled) {
                animationUuid = this.animationFrameStore.register({
                    callback: () => {
                        controls.update();
                    },
                });
            }
            return () => {
                this.animationFrameStore.actions.unsubscriberUuid(animationUuid);
            };
        });
        this.hold(this.select('camera'), (camera) => {
            const enableDamping = this.get('enableDamping');
            if (camera) {
                const controls = new OrbitControls(camera);
                controls.enableDamping = enableDamping;
                this.set({ controls });
            }
        });
        this.hold(__classPrivateFieldGet(this, _NgtSobaOrbitControls_controlsTargetParams$, "f"), ({ controls, target }) => {
            if (controls) {
                const vector3Target = makeVector3(target);
                if (vector3Target) {
                    controls.target = vector3Target;
                }
            }
        });
        this.holdEffect(__classPrivateFieldGet(this, _NgtSobaOrbitControls_controlsEventsChanges$, "f"), ({ controls, regress, domElement }) => {
            return this.ngZone.runOutsideAngular(() => {
                const changeCallback = (e) => {
                    this.loopService.invalidate();
                    if (regress) {
                        this.performanceStore.regress();
                    }
                    if (this.change.observed) {
                        this.change.emit(e);
                    }
                };
                let startCallback;
                let endCallback;
                if (domElement) {
                    controls.connect(domElement);
                }
                controls.addEventListener('change', changeCallback);
                if (this.start.observed) {
                    startCallback = (event) => {
                        this.start.emit(event);
                    };
                    controls.addEventListener('start', startCallback);
                }
                if (this.end.observed) {
                    endCallback = (event) => {
                        this.end.emit(event);
                    };
                    controls.addEventListener('end', endCallback);
                }
                return () => {
                    controls.removeEventListener('change', changeCallback);
                    if (endCallback)
                        controls.removeEventListener('end', endCallback);
                    if (startCallback)
                        controls.removeEventListener('start', startCallback);
                    controls.dispose();
                };
            });
        });
        this.holdEffect(__classPrivateFieldGet(this, _NgtSobaOrbitControls_makeDefaultParams$, "f"), ({ controls, makeDefault }) => {
            const oldControls = this.store.get('controls');
            if (makeDefault) {
                this.store.set({ controls });
            }
            return () => {
                this.store.set({ controls: oldControls });
            };
        });
    }
    get controls() {
        return (this.store.get('controls') ||
            this.get('controls'));
    }
}
_NgtSobaOrbitControls_controlsEventsChanges$ = new WeakMap(), _NgtSobaOrbitControls_makeDefaultParams$ = new WeakMap(), _NgtSobaOrbitControls_controlsTargetParams$ = new WeakMap();
NgtSobaOrbitControls.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaOrbitControls, deps: [{ token: i1.NgtLoopService }, { token: i1.NgtStore }, { token: i1.NgtEventsStore }, { token: i1.NgtAnimationFrameStore }, { token: i1.NgtPerformanceStore }, { token: i0.NgZone }], target: i0.ɵɵFactoryTarget.Directive });
NgtSobaOrbitControls.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.1.1", type: NgtSobaOrbitControls, selector: "ngt-soba-orbit-controls", inputs: { target: "target", camera: "camera", domElement: "domElement", regress: "regress", enableDamping: "enableDamping", makeDefault: "makeDefault" }, outputs: { ready: "ready", change: "change", start: "start", end: "end" }, exportAs: ["ngtSobaOrbitControls"], usesInheritance: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaOrbitControls, decorators: [{
            type: Directive,
            args: [{
                    selector: 'ngt-soba-orbit-controls',
                    exportAs: 'ngtSobaOrbitControls',
                }]
        }], ctorParameters: function () { return [{ type: i1.NgtLoopService }, { type: i1.NgtStore }, { type: i1.NgtEventsStore }, { type: i1.NgtAnimationFrameStore }, { type: i1.NgtPerformanceStore }, { type: i0.NgZone }]; }, propDecorators: { target: [{
                type: Input
            }], camera: [{
                type: Input
            }], domElement: [{
                type: Input
            }], regress: [{
                type: Input
            }], enableDamping: [{
                type: Input
            }], makeDefault: [{
                type: Input
            }], ready: [{
                type: Output
            }], change: [{
                type: Output
            }], start: [{
                type: Output
            }], end: [{
                type: Output
            }] } });
export class NgtSobaOrbitControlsModule {
}
NgtSobaOrbitControlsModule.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaOrbitControlsModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule });
NgtSobaOrbitControlsModule.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaOrbitControlsModule, declarations: [NgtSobaOrbitControls], exports: [NgtSobaOrbitControls] });
NgtSobaOrbitControlsModule.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaOrbitControlsModule });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSobaOrbitControlsModule, decorators: [{
            type: NgModule,
            args: [{
                    declarations: [NgtSobaOrbitControls],
                    exports: [NgtSobaOrbitControls],
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3JiaXQtY29udHJvbHMuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvc29iYS9jb250cm9scy9zcmMvbGliL29yYml0LWNvbnRyb2xzL29yYml0LWNvbnRyb2xzLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE9BQU8sRUFDTCxlQUFlLEVBQ2YsV0FBVyxFQUNYLHNCQUFzQixFQUN0QixjQUFjLEVBQ2QsY0FBYyxFQUNkLG1CQUFtQixFQUNuQixRQUFRLEdBRVQsTUFBTSxxQkFBcUIsQ0FBQztBQUM3QixPQUFPLEVBQ0wsU0FBUyxFQUNULFlBQVksRUFDWixLQUFLLEVBQ0wsUUFBUSxFQUNSLE1BQU0sRUFFTixNQUFNLEdBQ1AsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3JDLE9BQU8sS0FBSyxLQUFLLE1BQU0sT0FBTyxDQUFDO0FBQy9CLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQzs7O0FBZ0JwRSxNQUFNLE9BQU8sb0JBQ1gsU0FBUSxlQUEwQztJQXVDbEQsWUFDVSxXQUEyQixFQUMzQixLQUFlLEVBQ2YsV0FBMkIsRUFDM0IsbUJBQTJDLEVBQzNDLGdCQUFxQyxFQUNyQyxNQUFjO1FBRXRCLEtBQUssRUFBRSxDQUFDO1FBUEEsZ0JBQVcsR0FBWCxXQUFXLENBQWdCO1FBQzNCLFVBQUssR0FBTCxLQUFLLENBQVU7UUFDZixnQkFBVyxHQUFYLFdBQVcsQ0FBZ0I7UUFDM0Isd0JBQW1CLEdBQW5CLG1CQUFtQixDQUF3QjtRQUMzQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQXFCO1FBQ3JDLFdBQU0sR0FBTixNQUFNLENBQVE7UUFsQmQsVUFBSyxHQUFHLElBQUksQ0FB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QUFLO2dCQUlPLE9BQU87c0JBQW5CLEtBQUs7Z0JBSU8sYUFBYTtzQkFBekIsS0FBSztnQkFJTyxXQUFXO3NCQUF2QixLQUFLO2dCQUlJLEtBQUs7c0JBQWQsTUFBTTtnQkFDRyxNQUFNO3NCQUFmLE1BQU07Z0JBQ0csS0FBSztzQkFBZCxNQUFNO2dCQUNHLEdBQUc7c0JBQVosTUFBTTs7QUE4SVQsTUFBTSxPQUFPLDBCQUEwQjs7dUhBQTFCLDBCQUEwQjt3SEFBMUIsMEJBQTBCLGlCQTdLMUIsb0JBQW9CLGFBQXBCLG9CQUFvQjt3SEE2S3BCLDBCQUEwQjsyRkFBMUIsMEJBQTBCO2tCQUp0QyxRQUFRO21CQUFDO29CQUNSLFlBQVksRUFBRSxDQUFDLG9CQUFvQixDQUFDO29CQUNwQyxPQUFPLEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQztpQkFDaEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBFbmhhbmNlZFJ4U3RhdGUsXG4gIG1ha2VWZWN0b3IzLFxuICBOZ3RBbmltYXRpb25GcmFtZVN0b3JlLFxuICBOZ3RFdmVudHNTdG9yZSxcbiAgTmd0TG9vcFNlcnZpY2UsXG4gIE5ndFBlcmZvcm1hbmNlU3RvcmUsXG4gIE5ndFN0b3JlLFxuICBOZ3RWZWN0b3IzLFxufSBmcm9tICdAYW5ndWxhci10aHJlZS9jb3JlJztcbmltcG9ydCB7XG4gIERpcmVjdGl2ZSxcbiAgRXZlbnRFbWl0dGVyLFxuICBJbnB1dCxcbiAgTmdNb2R1bGUsXG4gIE5nWm9uZSxcbiAgT25Jbml0LFxuICBPdXRwdXQsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgc2VsZWN0U2xpY2UgfSBmcm9tICdAcngtYW5ndWxhci9zdGF0ZSc7XG5pbXBvcnQgeyBvZiwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgKiBhcyBUSFJFRSBmcm9tICd0aHJlZSc7XG5pbXBvcnQgeyBPcmJpdENvbnRyb2xzIH0gZnJvbSAndGhyZWUtc3RkbGliL2NvbnRyb2xzL09yYml0Q29udHJvbHMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIE5ndFNvYmFPcmJpdENvbnRyb2xzU3RhdGUge1xuICBlbmFibGVEYW1waW5nOiBib29sZWFuO1xuICBtYWtlRGVmYXVsdDogYm9vbGVhbjtcbiAgcmVncmVzczogYm9vbGVhbjtcbiAgY29udHJvbHM6IE9yYml0Q29udHJvbHM7XG4gIGNhbWVyYT86IFRIUkVFLkNhbWVyYTtcbiAgZG9tRWxlbWVudD86IEhUTUxFbGVtZW50O1xuICB0YXJnZXQ/OiBOZ3RWZWN0b3IzO1xufVxuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICduZ3Qtc29iYS1vcmJpdC1jb250cm9scycsXG4gIGV4cG9ydEFzOiAnbmd0U29iYU9yYml0Q29udHJvbHMnLFxufSlcbmV4cG9ydCBjbGFzcyBOZ3RTb2JhT3JiaXRDb250cm9sc1xuICBleHRlbmRzIEVuaGFuY2VkUnhTdGF0ZTxOZ3RTb2JhT3JiaXRDb250cm9sc1N0YXRlPlxuICBpbXBsZW1lbnRzIE9uSW5pdFxue1xuICBASW5wdXQoKSBzZXQgdGFyZ2V0KHY6IE5ndFZlY3RvcjMpIHtcbiAgICB0aGlzLnNldCh7IHRhcmdldDogdiB9KTtcbiAgfVxuXG4gIEBJbnB1dCgpIHNldCBjYW1lcmEodjogVEhSRUUuQ2FtZXJhKSB7XG4gICAgdGhpcy5zZXQoeyBjYW1lcmE6IHYgfSk7XG4gIH1cblxuICBASW5wdXQoKSBzZXQgZG9tRWxlbWVudCh2OiBIVE1MRWxlbWVudCkge1xuICAgIHRoaXMuc2V0KHsgZG9tRWxlbWVudDogdiB9KTtcbiAgfVxuXG4gIEBJbnB1dCgpIHNldCByZWdyZXNzKHY6IGJvb2xlYW4pIHtcbiAgICB0aGlzLnNldCh7IHJlZ3Jlc3M6IHYgfSk7XG4gIH1cblxuICBASW5wdXQoKSBzZXQgZW5hYmxlRGFtcGluZyh2OiBib29sZWFuKSB7XG4gICAgdGhpcy5zZXQoeyBlbmFibGVEYW1waW5nOiB2IH0pO1xuICB9XG5cbiAgQElucHV0KCkgc2V0IG1ha2VEZWZhdWx0KHY6IGJvb2xlYW4pIHtcbiAgICB0aGlzLnNldCh7IG1ha2VEZWZhdWx0OiB2IH0pO1xuICB9XG5cbiAgQE91dHB1dCgpIHJlYWR5ID0gdGhpcy5zZWxlY3QoJ2NvbnRyb2xzJyk7XG4gIEBPdXRwdXQoKSBjaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPFRIUkVFLkV2ZW50PigpO1xuICBAT3V0cHV0KCkgc3RhcnQgPSBuZXcgRXZlbnRFbWl0dGVyPFRIUkVFLkV2ZW50PigpO1xuICBAT3V0cHV0KCkgZW5kID0gbmV3IEV2ZW50RW1pdHRlcjxUSFJFRS5FdmVudD4oKTtcblxuICAjY29udHJvbHNFdmVudHNDaGFuZ2VzJCA9IHRoaXMuc2VsZWN0KFxuICAgIHNlbGVjdFNsaWNlKFsncmVncmVzcycsICdjb250cm9scycsICdkb21FbGVtZW50J10pXG4gICk7XG5cbiAgI21ha2VEZWZhdWx0UGFyYW1zJCA9IHRoaXMuc2VsZWN0KHNlbGVjdFNsaWNlKFsnbWFrZURlZmF1bHQnLCAnY29udHJvbHMnXSkpO1xuICAjY29udHJvbHNUYXJnZXRQYXJhbXMkID0gdGhpcy5zZWxlY3Qoc2VsZWN0U2xpY2UoWyd0YXJnZXQnLCAnY29udHJvbHMnXSkpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgbG9vcFNlcnZpY2U6IE5ndExvb3BTZXJ2aWNlLFxuICAgIHByaXZhdGUgc3RvcmU6IE5ndFN0b3JlLFxuICAgIHByaXZhdGUgZXZlbnRzU3RvcmU6IE5ndEV2ZW50c1N0b3JlLFxuICAgIHByaXZhdGUgYW5pbWF0aW9uRnJhbWVTdG9yZTogTmd0QW5pbWF0aW9uRnJhbWVTdG9yZSxcbiAgICBwcml2YXRlIHBlcmZvcm1hbmNlU3RvcmU6IE5ndFBlcmZvcm1hbmNlU3RvcmUsXG4gICAgcHJpdmF0ZSBuZ1pvbmU6IE5nWm9uZVxuICApIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuc2V0KHtcbiAgICAgIHRhcmdldDogdW5kZWZpbmVkLFxuICAgICAgcmVncmVzczogZmFsc2UsXG4gICAgICBlbmFibGVEYW1waW5nOiB0cnVlLFxuICAgICAgbWFrZURlZmF1bHQ6IGZhbHNlLFxuICAgICAgY2FtZXJhOiB1bmRlZmluZWQsXG4gICAgICBkb21FbGVtZW50OiB1bmRlZmluZWQsXG4gICAgfSk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmNvbm5lY3QoJ2NhbWVyYScsIHRoaXMuc3RvcmUuc2VsZWN0KCdjYW1lcmEnKSk7XG4gICAgdGhpcy5jb25uZWN0KFxuICAgICAgJ2RvbUVsZW1lbnQnLFxuICAgICAgdGhpcy5ldmVudHNTdG9yZS5zZWxlY3QoJ2Nvbm5lY3RlZCcpLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcCgoY29ubmVjdGVkKSA9PiB7XG4gICAgICAgICAgaWYgKHR5cGVvZiBjb25uZWN0ZWQgIT09ICdib29sZWFuJykgcmV0dXJuIG9mKGNvbm5lY3RlZCk7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmUuc2VsZWN0KCdyZW5kZXJlcicsICdkb21FbGVtZW50Jyk7XG4gICAgICAgIH0pXG4gICAgICApXG4gICAgKTtcblxuICAgIHRoaXMuaG9sZEVmZmVjdCh0aGlzLnNlbGVjdCgnY29udHJvbHMnKSwgKGNvbnRyb2xzKSA9PiB7XG4gICAgICBsZXQgYW5pbWF0aW9uVXVpZDogc3RyaW5nO1xuICAgICAgaWYgKGNvbnRyb2xzLmVuYWJsZWQpIHtcbiAgICAgICAgYW5pbWF0aW9uVXVpZCA9IHRoaXMuYW5pbWF0aW9uRnJhbWVTdG9yZS5yZWdpc3Rlcih7XG4gICAgICAgICAgY2FsbGJhY2s6ICgpID0+IHtcbiAgICAgICAgICAgIGNvbnRyb2xzLnVwZGF0ZSgpO1xuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgdGhpcy5hbmltYXRpb25GcmFtZVN0b3JlLmFjdGlvbnMudW5zdWJzY3JpYmVyVXVpZChhbmltYXRpb25VdWlkKTtcbiAgICAgIH07XG4gICAgfSk7XG5cbiAgICB0aGlzLmhvbGQodGhpcy5zZWxlY3QoJ2NhbWVyYScpLCAoY2FtZXJhKSA9PiB7XG4gICAgICBjb25zdCBlbmFibGVEYW1waW5nID0gdGhpcy5nZXQoJ2VuYWJsZURhbXBpbmcnKTtcbiAgICAgIGlmIChjYW1lcmEpIHtcbiAgICAgICAgY29uc3QgY29udHJvbHMgPSBuZXcgT3JiaXRDb250cm9scyhjYW1lcmEpO1xuICAgICAgICBjb250cm9scy5lbmFibGVEYW1waW5nID0gZW5hYmxlRGFtcGluZztcbiAgICAgICAgdGhpcy5zZXQoeyBjb250cm9scyB9KTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMuaG9sZCh0aGlzLiNjb250cm9sc1RhcmdldFBhcmFtcyQsICh7IGNvbnRyb2xzLCB0YXJnZXQgfSkgPT4ge1xuICAgICAgaWYgKGNvbnRyb2xzKSB7XG4gICAgICAgIGNvbnN0IHZlY3RvcjNUYXJnZXQgPSBtYWtlVmVjdG9yMyh0YXJnZXQpO1xuICAgICAgICBpZiAodmVjdG9yM1RhcmdldCkge1xuICAgICAgICAgIGNvbnRyb2xzLnRhcmdldCA9IHZlY3RvcjNUYXJnZXQ7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMuaG9sZEVmZmVjdChcbiAgICAgIHRoaXMuI2NvbnRyb2xzRXZlbnRzQ2hhbmdlcyQsXG4gICAgICAoeyBjb250cm9scywgcmVncmVzcywgZG9tRWxlbWVudCB9KSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLm5nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICAgICAgY29uc3QgY2hhbmdlQ2FsbGJhY2s6IChlOiBUSFJFRS5FdmVudCkgPT4gdm9pZCA9IChlKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmxvb3BTZXJ2aWNlLmludmFsaWRhdGUoKTtcbiAgICAgICAgICAgIGlmIChyZWdyZXNzKSB7XG4gICAgICAgICAgICAgIHRoaXMucGVyZm9ybWFuY2VTdG9yZS5yZWdyZXNzKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmNoYW5nZS5vYnNlcnZlZCkge1xuICAgICAgICAgICAgICB0aGlzLmNoYW5nZS5lbWl0KGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH07XG4gICAgICAgICAgbGV0IHN0YXJ0Q2FsbGJhY2s6IChlOiBUSFJFRS5FdmVudCkgPT4gdm9pZDtcbiAgICAgICAgICBsZXQgZW5kQ2FsbGJhY2s6IChlOiBUSFJFRS5FdmVudCkgPT4gdm9pZDtcblxuICAgICAgICAgIGlmIChkb21FbGVtZW50KSB7XG4gICAgICAgICAgICBjb250cm9scy5jb25uZWN0KGRvbUVsZW1lbnQpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbnRyb2xzLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIGNoYW5nZUNhbGxiYWNrKTtcblxuICAgICAgICAgIGlmICh0aGlzLnN0YXJ0Lm9ic2VydmVkKSB7XG4gICAgICAgICAgICBzdGFydENhbGxiYWNrID0gKGV2ZW50OiBUSFJFRS5FdmVudCkgPT4ge1xuICAgICAgICAgICAgICB0aGlzLnN0YXJ0LmVtaXQoZXZlbnQpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGNvbnRyb2xzLmFkZEV2ZW50TGlzdGVuZXIoJ3N0YXJ0Jywgc3RhcnRDYWxsYmFjayk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKHRoaXMuZW5kLm9ic2VydmVkKSB7XG4gICAgICAgICAgICBlbmRDYWxsYmFjayA9IChldmVudDogVEhSRUUuRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgdGhpcy5lbmQuZW1pdChldmVudCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgY29udHJvbHMuYWRkRXZlbnRMaXN0ZW5lcignZW5kJywgZW5kQ2FsbGJhY2spO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAgICAgICBjb250cm9scy5yZW1vdmVFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCBjaGFuZ2VDYWxsYmFjayk7XG4gICAgICAgICAgICBpZiAoZW5kQ2FsbGJhY2spIGNvbnRyb2xzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2VuZCcsIGVuZENhbGxiYWNrKTtcbiAgICAgICAgICAgIGlmIChzdGFydENhbGxiYWNrKVxuICAgICAgICAgICAgICBjb250cm9scy5yZW1vdmVFdmVudExpc3RlbmVyKCdzdGFydCcsIHN0YXJ0Q2FsbGJhY2spO1xuICAgICAgICAgICAgY29udHJvbHMuZGlzcG9zZSgpO1xuICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICk7XG5cbiAgICB0aGlzLmhvbGRFZmZlY3QodGhpcy4jbWFrZURlZmF1bHRQYXJhbXMkLCAoeyBjb250cm9scywgbWFrZURlZmF1bHQgfSkgPT4ge1xuICAgICAgY29uc3Qgb2xkQ29udHJvbHMgPSB0aGlzLnN0b3JlLmdldCgnY29udHJvbHMnKTtcbiAgICAgIGlmIChtYWtlRGVmYXVsdCkge1xuICAgICAgICB0aGlzLnN0b3JlLnNldCh7IGNvbnRyb2xzIH0pO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICB0aGlzLnN0b3JlLnNldCh7IGNvbnRyb2xzOiBvbGRDb250cm9scyB9KTtcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICBnZXQgY29udHJvbHMoKSB7XG4gICAgcmV0dXJuICh0aGlzLnN0b3JlLmdldCgnY29udHJvbHMnKSB8fFxuICAgICAgdGhpcy5nZXQoJ2NvbnRyb2xzJykpIGFzIE9yYml0Q29udHJvbHM7XG4gIH1cbn1cblxuQE5nTW9kdWxlKHtcbiAgZGVjbGFyYXRpb25zOiBbTmd0U29iYU9yYml0Q29udHJvbHNdLFxuICBleHBvcnRzOiBbTmd0U29iYU9yYml0Q29udHJvbHNdLFxufSlcbmV4cG9ydCBjbGFzcyBOZ3RTb2JhT3JiaXRDb250cm9sc01vZHVsZSB7fVxuIl19