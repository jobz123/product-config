var _NgtStore_instances, _NgtStore_allReady$, _NgtStore_dimensions$, _NgtStore_init, _NgtStore_updateDimensions;
import { __classPrivateFieldGet } from "tslib";
import { ElementRef, Inject, Injectable } from '@angular/core';
import { selectSlice } from '@rx-angular/state';
import { map, Observable } from 'rxjs';
import * as THREE from 'three';
import { NGT_PERFORMANCE_OPTIONS } from '../di/performance';
import { NgtResize } from '../services/resize.service';
import { applyProps } from '../utils/apply-props';
import { calculateDpr } from '../utils/calculate-dpr';
import { isOrthographicCamera } from '../utils/is-orthographic';
import { EnhancedRxState } from './enhanced-rx-state';
import * as i0 from "@angular/core";
import * as i1 from "rxjs";
const position = new THREE.Vector3();
const defaultTarget = new THREE.Vector3();
export class NgtStore extends EnhancedRxState {
    constructor(performance, { nativeElement: canvasHost }, resizeResult$) {
        super();
        this.resizeResult$ = resizeResult$;
        _NgtStore_instances.add(this);
        _NgtStore_allReady$.set(this, this.select(selectSlice(['scene', 'camera', 'renderer', 'raycaster']), map(({ scene, camera, renderer, raycaster }) => !!scene && !!camera && !!renderer && !!raycaster)));
        _NgtStore_dimensions$.set(this, this.select(selectSlice(['size', 'viewport'])));
        this.actions = this.create();
        this.set({
            ready: false,
            vr: false,
            orthographic: false,
            flat: false,
            linear: false,
            size: {
                height: canvasHost.clientHeight,
                width: canvasHost.clientWidth,
            },
            mouse: new THREE.Vector2(),
            clock: new THREE.Clock(),
            frameloop: 'always',
            performance,
            controls: null,
            objects: {},
            dpr: 1,
            shadows: false,
            cameraOptions: {},
            glOptions: {},
            raycasterOptions: {},
            sceneOptions: {},
            viewport: {
                initialDpr: calculateDpr(this.get('dpr')),
                dpr: calculateDpr(this.get('dpr')),
                width: canvasHost.clientWidth,
                height: canvasHost.clientHeight,
                aspect: canvasHost.clientWidth / canvasHost.clientHeight,
                distance: 0,
                factor: 0,
                getCurrentViewport: (camera = this.get('camera'), target = defaultTarget, size = this.get('size')) => {
                    const { width, height } = size;
                    const aspect = width / height;
                    const distance = camera
                        .getWorldDirection(position)
                        .distanceTo(target);
                    if (isOrthographicCamera(camera)) {
                        return {
                            width: width / camera.zoom,
                            height: height / camera.zoom,
                            factor: 1,
                            distance,
                            aspect,
                        };
                    }
                    const fov = (camera.fov * Math.PI) / 180; // convert vertical fov to radians
                    const h = 2 * Math.tan(fov / 2) * distance; // height of viewport
                    const w = h * aspect; // width of viewport
                    return {
                        width: w,
                        height: h,
                        factor: width / w,
                        distance,
                        aspect,
                    };
                },
            },
        });
        this.connect('ready', __classPrivateFieldGet(this, _NgtStore_allReady$, "f"));
        this.connect('size', this.resizeResult$, (_, { width, height }) => ({
            width,
            height,
        }));
        this.connect('viewport', this.resizeResult$, ({ viewport }, { dpr }) => ({
            ...viewport,
            dpr,
        }));
        this.hold(__classPrivateFieldGet(this, _NgtStore_dimensions$, "f"), __classPrivateFieldGet(this, _NgtStore_instances, "m", _NgtStore_updateDimensions).bind(this));
        this.holdEffect(this.actions.canvasElement$, __classPrivateFieldGet(this, _NgtStore_instances, "m", _NgtStore_init).bind(this));
    }
}
_NgtStore_allReady$ = new WeakMap(), _NgtStore_dimensions$ = new WeakMap(), _NgtStore_instances = new WeakSet(), _NgtStore_init = function _NgtStore_init(canvasElement) {
    const { size, viewport, vr, linear, flat, orthographic } = this.get();
    const { shadows, glOptions, sceneOptions, cameraOptions, raycasterOptions, } = this.get();
    // Scene
    const scene = new THREE.Scene();
    applyProps(scene, sceneOptions);
    // Camera
    const isCamera = cameraOptions instanceof THREE.Camera;
    const camera = isCamera
        ? cameraOptions
        : orthographic
            ? new THREE.OrthographicCamera(0, 0, 0, 0, 0.1, 1000)
            : new THREE.PerspectiveCamera(75, size.width / size.height, 0.1, 1000);
    if (!isCamera) {
        camera.position.z = 5;
        if (cameraOptions) {
            applyProps(camera, cameraOptions);
            // Update projection matrix after applying props
            camera.updateProjectionMatrix();
        }
        // look at center if initial rotation isn't set
        if (!cameraOptions?.rotation)
            camera.lookAt(0, 0, 0);
    }
    // Raycaster
    const raycaster = new THREE.Raycaster();
    const { params, ...options } = raycasterOptions || {};
    applyProps(raycaster, {
        enabled: true,
        ...options,
        params: { ...raycaster.params, ...params },
    });
    // Renderer
    const customRenderer = (typeof glOptions === 'function' ? glOptions(canvasElement) : glOptions);
    // userland custom renderer, assign as-is
    if (!!customRenderer?.render) {
        this.set({
            renderer: customRenderer,
            scene,
            camera,
            raycaster: raycaster,
        });
        return;
    }
    const renderer = new THREE.WebGLRenderer({
        powerPreference: 'high-performance',
        canvas: canvasElement,
        antialias: true,
        alpha: true,
        ...(glOptions || {}),
    });
    if (glOptions) {
        applyProps(renderer, glOptions);
    }
    if (shadows) {
        renderer.shadowMap.enabled = true;
        if (typeof shadows === 'object') {
            Object.assign(renderer.shadowMap, shadows);
        }
        else {
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        }
    }
    if (!linear) {
        // auto color management
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.outputEncoding = THREE.sRGBEncoding;
    }
    else {
        renderer.outputEncoding = THREE.LinearEncoding;
    }
    if (flat) {
        renderer.toneMapping = THREE.NoToneMapping;
    }
    renderer.setClearAlpha(0);
    renderer.setPixelRatio(calculateDpr(viewport.dpr));
    renderer.setSize(size.width, size.height);
    if (vr) {
        renderer.xr.enabled = true;
    }
    this.set({
        renderer,
        scene,
        camera,
        raycaster: raycaster,
    });
    return () => {
        const { renderer, vr } = this.get();
        if (renderer) {
            renderer.renderLists.dispose();
            renderer.forceContextLoss();
            if (vr) {
                renderer.setAnimationLoop(null);
            }
        }
    };
}, _NgtStore_updateDimensions = function _NgtStore_updateDimensions({ size, viewport, }) {
    const { camera, renderer, ready, cameraOptions } = this.get();
    if (ready) {
        // update renderer
        renderer.setPixelRatio(viewport.dpr);
        renderer.setSize(size.width, size.height);
        // leave the userland camera alone
        if (cameraOptions instanceof THREE.Camera)
            return;
        if (isOrthographicCamera(camera)) {
            camera.left = size.width / -2;
            camera.right = size.width / 2;
            camera.top = size.height / 2;
            camera.bottom = size.height / -2;
        }
        else {
            camera.aspect = size.width / size.height;
        }
        camera.updateProjectionMatrix();
        // https://github.com/pmndrs/react-three-fiber/issues/178
        // Update matrix world since the renderer is a frame late
        camera.updateMatrixWorld();
    }
};
NgtStore.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtStore, deps: [{ token: NGT_PERFORMANCE_OPTIONS }, { token: i0.ElementRef }, { token: NgtResize }], target: i0.ɵɵFactoryTarget.Injectable });
NgtStore.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtStore });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtStore, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [NGT_PERFORMANCE_OPTIONS]
                }] }, { type: i0.ElementRef }, { type: i1.Observable, decorators: [{
                    type: Inject,
                    args: [NgtResize]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9jb3JlL3NyYy9saWIvc3RvcmVzL3N0b3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQy9ELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNoRCxPQUFPLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN2QyxPQUFPLEtBQUssS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMvQixPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUM1RCxPQUFPLEVBQUUsU0FBUyxFQUFtQixNQUFNLDRCQUE0QixDQUFDO0FBVXhFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDaEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDOzs7QUFFdEQsTUFBTSxRQUFRLEdBQUcsSUFBSSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDckMsTUFBTSxhQUFhLEdBQUcsSUFBSSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7QUFHMUMsTUFBTSxPQUFPLFFBQVMsU0FBUSxlQUc3QjtJQWFDLFlBQ21DLFdBQTJCLEVBQzVELEVBQUUsYUFBYSxFQUFFLFVBQVUsRUFBMkIsRUFFOUMsYUFBMEM7UUFFbEQsS0FBSyxFQUFFLENBQUM7UUFGQSxrQkFBYSxHQUFiLGFBQWEsQ0FBNkI7O1FBaEJwRCw4QkFBYSxJQUFJLENBQUMsTUFBTSxDQUN0QixXQUFXLENBQUMsQ0FBQyxPQUFPLEVBQUUs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LENBQUM7S0FDNUI7QUFDSCxDQUFDO3FHQTlQVSxRQUFRLGtCQWlCVCx1QkFBdUIsdUNBRXZCLFNBQVM7eUdBbkJSLFFBQVE7MkZBQVIsUUFBUTtrQkFEcEIsVUFBVTs7MEJBa0JOLE1BQU07MkJBQUMsdUJBQXVCOzswQkFFOUIsTUFBTTsyQkFBQyxTQUFTIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRWxlbWVudFJlZiwgSW5qZWN0LCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBzZWxlY3RTbGljZSB9IGZyb20gJ0ByeC1hbmd1bGFyL3N0YXRlJztcbmltcG9ydCB7IG1hcCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0ICogYXMgVEhSRUUgZnJvbSAndGhyZWUnO1xuaW1wb3J0IHsgTkdUX1BFUkZPUk1BTkNFX09QVElPTlMgfSBmcm9tICcuLi9kaS9wZXJmb3JtYW5jZSc7XG5pbXBvcnQgeyBOZ3RSZXNpemUsIE5ndFJlc2l6ZVJlc3VsdCB9IGZyb20gJy4uL3NlcnZpY2VzL3Jlc2l6ZS5zZXJ2aWNlJztcbmltcG9ydCB7XG4gIE5ndEluc3RhbmNlLFxuICBOZ3RQZXJmb3JtYW5jZSxcbiAgTmd0UmF5Y2FzdGVyLFxuICBOZ3RTaXplLFxuICBOZ3RTdGF0ZSxcbiAgTmd0Vmlld3BvcnQsXG4gIFVua25vd25SZWNvcmQsXG59IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCB7IGFwcGx5UHJvcHMgfSBmcm9tICcuLi91dGlscy9hcHBseS1wcm9wcyc7XG5pbXBvcnQgeyBjYWxjdWxhdGVEcHIgfSBmcm9tICcuLi91dGlscy9jYWxjdWxhdGUtZHByJztcbmltcG9ydCB7IGlzT3J0aG9ncmFwaGljQ2FtZXJhIH0gZnJvbSAnLi4vdXRpbHMvaXMtb3J0aG9ncmFwaGljJztcbmltcG9ydCB7IEVuaGFuY2VkUnhTdGF0ZSB9IGZyb20gJy4vZW5oYW5jZWQtcngtc3RhdGUnO1xuXG5jb25zdCBwb3NpdGlvbiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7XG5jb25zdCBkZWZhdWx0VGFyZ2V0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE5ndFN0b3JlIGV4dGVuZHMgRW5oYW5jZWRSeFN0YXRlPFxuICBOZ3RTdGF0ZSxcbiAgeyBjYW52YXNFbGVtZW50OiBIVE1MQ2FudmFzRWxlbWVudCB9XG4+IHtcbiAgI2FsbFJlYWR5JCA9IHRoaXMuc2VsZWN0KFxuICAgIHNlbGVjdFNsaWNlKFsnc2NlbmUnLCAnY2FtZXJhJywgJ3JlbmRlcmVyJywgJ3JheWNhc3RlciddKSxcbiAgICBtYXAoXG4gICAgICAoeyBzY2VuZSwgY2FtZXJhLCByZW5kZXJlciwgcmF5Y2FzdGVyIH0pID0+XG4gICAgICAgICEhc2NlbmUgJiYgISFjYW1lcmEgJiYgISFyZW5kZXJlciAmJiAhIXJheWNhc3RlclxuICAgIClcbiAgKTtcblxuICAjZGltZW5zaW9ucyQgPSB0aGlzLnNlbGVjdChzZWxlY3RTbGljZShbJ3NpemUnLCAndmlld3BvcnQnXSkpO1xuXG4gIGFjdGlvbnMgPSB0aGlzLmNyZWF0ZSgpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoTkdUX1BFUkZPUk1BTkNFX09QVElPTlMpIHBlcmZvcm1hbmNlOiBOZ3RQZXJmb3JtYW5jZSxcbiAgICB7IG5hdGl2ZUVsZW1lbnQ6IGNhbnZhc0hvc3QgfTogRWxlbWVudFJlZjxIVE1MRWxlbWVudD4sXG4gICAgQEluamVjdChOZ3RSZXNpemUpXG4gICAgcHJpdmF0ZSByZXNpemVSZXN1bHQkOiBPYnNlcnZhYmxlPE5ndFJlc2l6ZVJlc3VsdD5cbiAgKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLnNldCh7XG4gICAgICByZWFkeTogZmFsc2UsXG4gICAgICB2cjogZmFsc2UsXG4gICAgICBvcnRob2dyYXBoaWM6IGZhbHNlLFxuICAgICAgZmxhdDogZmFsc2UsXG4gICAgICBsaW5lYXI6IGZhbHNlLFxuICAgICAgc2l6ZToge1xuICAgICAgICBoZWlnaHQ6IGNhbnZhc0hvc3QuY2xpZW50SGVpZ2h0LFxuICAgICAgICB3aWR0aDogY2FudmFzSG9zdC5jbGllbnRXaWR0aCxcbiAgICAgIH0sXG4gICAgICBtb3VzZTogbmV3IFRIUkVFLlZlY3RvcjIoKSxcbiAgICAgIGNsb2NrOiBuZXcgVEhSRUUuQ2xvY2soKSxcbiAgICAgIGZyYW1lbG9vcDogJ2Fsd2F5cycsXG4gICAgICBwZXJmb3JtYW5jZSxcbiAgICAgIGNvbnRyb2xzOiBudWxsLFxuICAgICAgb2JqZWN0czoge30sXG4gICAgICBkcHI6IDEsXG4gICAgICBzaGFkb3dzOiBmYWxzZSxcbiAgICAgIGNhbWVyYU9wdGlvbnM6IHt9LFxuICAgICAgZ2xPcHRpb25zOiB7fSxcbiAgICAgIHJheWNhc3Rlck9wdGlvbnM6IHt9LFxuICAgICAgc2NlbmVPcHRpb25zOiB7fSxcbiAgICAgIHZpZXdwb3J0OiB7XG4gICAgICAgIGluaXRpYWxEcHI6IGNhbGN1bGF0ZURwcih0aGlzLmdldCgnZHByJykpLFxuICAgICAgICBkcHI6IGNhbGN1bGF0ZURwcih0aGlzLmdldCgnZHByJykpLFxuICAgICAgICB3aWR0aDogY2FudmFzSG9zdC5jbGllbnRXaWR0aCxcbiAgICAgICAgaGVpZ2h0OiBjYW52YXNIb3N0LmNsaWVudEhlaWdodCxcbiAgICAgICAgYXNwZWN0OiBjYW52YXNIb3N0LmNsaWVudFdpZHRoIC8gY2FudmFzSG9zdC5jbGllbnRIZWlnaHQsXG4gICAgICAgIGRpc3RhbmNlOiAwLFxuICAgICAgICBmYWN0b3I6IDAsXG4gICAgICAgIGdldEN1cnJlbnRWaWV3cG9ydDogKFxuICAgICAgICAgIGNhbWVyYSA9IHRoaXMuZ2V0KCdjYW1lcmEnKSxcbiAgICAgICAgICB0YXJnZXQgPSBkZWZhdWx0VGFyZ2V0LFxuICAgICAgICAgIHNpemUgPSB0aGlzLmdldCgnc2l6ZScpXG4gICAgICAgICkgPT4ge1xuICAgICAgICAgIGNvbnN0IHsgd2lkdGgsIGhlaWdodCB9ID0gc2l6ZTtcbiAgICAgICAgICBjb25zdCBhc3BlY3QgPSB3aWR0aCAvIGhlaWdodDtcbiAgICAgICAgICBjb25zdCBkaXN0YW5jZSA9IGNhbWVyYVxuICAgICAgICAgICAgLmdldFdvcmxkRGlyZWN0aW9uKHBvc2l0aW9uKVxuICAgICAgICAgICAgLmRpc3RhbmNlVG8odGFyZ2V0KTtcbiAgICAgICAgICBpZiAoaXNPcnRob2dyYXBoaWNDYW1lcmEoY2FtZXJhKSkge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgd2lkdGg6IHdpZHRoIC8gY2FtZXJhLnpvb20sXG4gICAgICAgICAgICAgIGhlaWdodDogaGVpZ2h0IC8gY2FtZXJhLnpvb20sXG4gICAgICAgICAgICAgIGZhY3RvcjogMSxcbiAgICAgICAgICAgICAgZGlzdGFuY2UsXG4gICAgICAgICAgICAgIGFzcGVjdCxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY29uc3QgZm92ID0gKGNhbWVyYS5mb3YgKiBNYXRoLlBJKSAvIDE4MDsgLy8gY29udmVydCB2ZXJ0aWNhbCBmb3YgdG8gcmFkaWFuc1xuICAgICAgICAgIGNvbnN0IGggPSAyICogTWF0aC50YW4oZm92IC8gMikgKiBkaXN0YW5jZTsgLy8gaGVpZ2h0IG9mIHZpZXdwb3J0XG4gICAgICAgICAgY29uc3QgdyA9IGggKiBhc3BlY3Q7IC8vIHdpZHRoIG9mIHZpZXdwb3J0XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHdpZHRoOiB3LFxuICAgICAgICAgICAgaGVpZ2h0OiBoLFxuICAgICAgICAgICAgZmFjdG9yOiB3aWR0aCAvIHcsXG4gICAgICAgICAgICBkaXN0YW5jZSxcbiAgICAgICAgICAgIGFzcGVjdCxcbiAgICAgICAgICB9O1xuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHRoaXMuY29ubmVjdCgncmVhZHknLCB0aGlzLiNhbGxSZWFkeSQpO1xuICAgIHRoaXMuY29ubmVjdCgnc2l6ZScsIHRoaXMucmVzaXplUmVzdWx0JCwgKF8sIHsgd2lkdGgsIGhlaWdodCB9KSA9PiAoe1xuICAgICAgd2lkdGgsXG4gICAgICBoZWlnaHQsXG4gICAgfSkpO1xuICAgIHRoaXMuY29ubmVjdCgndmlld3BvcnQnLCB0aGlzLnJlc2l6ZVJlc3VsdCQsICh7IHZpZXdwb3J0IH0sIHsgZHByIH0pID0+ICh7XG4gICAgICAuLi52aWV3cG9ydCxcbiAgICAgIGRwcixcbiAgICB9KSk7XG5cbiAgICB0aGlzLmhvbGQodGhpcy4jZGltZW5zaW9ucyQsIHRoaXMuI3VwZGF0ZURpbWVuc2lvbnMuYmluZCh0aGlzKSk7XG4gICAgdGhpcy5ob2xkRWZmZWN0KHRoaXMuYWN0aW9ucy5jYW52YXNFbGVtZW50JCwgdGhpcy4jaW5pdC5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gICNpbml0KGNhbnZhc0VsZW1lbnQ6IEhUTUxDYW52YXNFbGVtZW50KSB7XG4gICAgY29uc3QgeyBzaXplLCB2aWV3cG9ydCwgdnIsIGxpbmVhciwgZmxhdCwgb3J0aG9ncmFwaGljIH0gPSB0aGlzLmdldCgpO1xuICAgIGNvbnN0IHtcbiAgICAgIHNoYWRvd3MsXG4gICAgICBnbE9wdGlvbnMsXG4gICAgICBzY2VuZU9wdGlvbnMsXG4gICAgICBjYW1lcmFPcHRpb25zLFxuICAgICAgcmF5Y2FzdGVyT3B0aW9ucyxcbiAgICB9ID0gdGhpcy5nZXQoKTtcblxuICAgIC8vIFNjZW5lXG4gICAgY29uc3Qgc2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTtcbiAgICBhcHBseVByb3BzKHNjZW5lLCBzY2VuZU9wdGlvbnMgYXMgVW5rbm93blJlY29yZCk7XG5cbiAgICAvLyBDYW1lcmFcbiAgICBjb25zdCBpc0NhbWVyYSA9IGNhbWVyYU9wdGlvbnMgaW5zdGFuY2VvZiBUSFJFRS5DYW1lcmE7XG4gICAgY29uc3QgY2FtZXJhID0gaXNDYW1lcmFcbiAgICAgID8gY2FtZXJhT3B0aW9uc1xuICAgICAgOiBvcnRob2dyYXBoaWNcbiAgICAgID8gbmV3IFRIUkVFLk9ydGhvZ3JhcGhpY0NhbWVyYSgwLCAwLCAwLCAwLCAwLjEsIDEwMDApXG4gICAgICA6IG5ldyBUSFJFRS5QZXJzcGVjdGl2ZUNhbWVyYSg3NSwgc2l6ZS53aWR0aCAvIHNpemUuaGVpZ2h0LCAwLjEsIDEwMDApO1xuXG4gICAgaWYgKCFpc0NhbWVyYSkge1xuICAgICAgY2FtZXJhLnBvc2l0aW9uLnogPSA1O1xuICAgICAgaWYgKGNhbWVyYU9wdGlvbnMpIHtcbiAgICAgICAgYXBwbHlQcm9wcyhjYW1lcmEsIGNhbWVyYU9wdGlvbnMgYXMgVW5rbm93blJlY29yZCk7XG4gICAgICAgIC8vIFVwZGF0ZSBwcm9qZWN0aW9uIG1hdHJpeCBhZnRlciBhcHBseWluZyBwcm9wc1xuICAgICAgICBjYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpO1xuICAgICAgfVxuICAgICAgLy8gbG9vayBhdCBjZW50ZXIgaWYgaW5pdGlhbCByb3RhdGlvbiBpc24ndCBzZXRcbiAgICAgIGlmICghY2FtZXJhT3B0aW9ucz8ucm90YXRpb24pIGNhbWVyYS5sb29rQXQoMCwgMCwgMCk7XG4gICAgfVxuXG4gICAgLy8gUmF5Y2FzdGVyXG4gICAgY29uc3QgcmF5Y2FzdGVyID0gbmV3IFRIUkVFLlJheWNhc3RlcigpO1xuICAgIGNvbnN0IHsgcGFyYW1zLCAuLi5vcHRpb25zIH0gPSByYXljYXN0ZXJPcHRpb25zIHx8IHt9O1xuICAgIGFwcGx5UHJvcHMocmF5Y2FzdGVyIGFzIHVua25vd24gYXMgTmd0SW5zdGFuY2UsIHtcbiAgICAgIGVuYWJsZWQ6IHRydWUsXG4gICAgICAuLi5vcHRpb25zLFxuICAgICAgcGFyYW1zOiB7IC4uLnJheWNhc3Rlci5wYXJhbXMsIC4uLnBhcmFtcyB9LFxuICAgIH0pO1xuXG4gICAgLy8gUmVuZGVyZXJcbiAgICBjb25zdCBjdXN0b21SZW5kZXJlciA9IChcbiAgICAgIHR5cGVvZiBnbE9wdGlvbnMgPT09ICdmdW5jdGlvbicgPyBnbE9wdGlvbnMoY2FudmFzRWxlbWVudCkgOiBnbE9wdGlvbnNcbiAgICApIGFzIFRIUkVFLldlYkdMUmVuZGVyZXI7XG5cbiAgICAvLyB1c2VybGFuZCBjdXN0b20gcmVuZGVyZXIsIGFzc2lnbiBhcy1pc1xuICAgIGlmICghIWN1c3RvbVJlbmRlcmVyPy5yZW5kZXIpIHtcbiAgICAgIHRoaXMuc2V0KHtcbiAgICAgICAgcmVuZGVyZXI6IGN1c3RvbVJlbmRlcmVyLFxuICAgICAgICBzY2VuZSxcbiAgICAgICAgY2FtZXJhLFxuICAgICAgICByYXljYXN0ZXI6IHJheWNhc3RlciBhcyBOZ3RSYXljYXN0ZXIsXG4gICAgICB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCByZW5kZXJlciA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlcmVyKHtcbiAgICAgIHBvd2VyUHJlZmVyZW5jZTogJ2hpZ2gtcGVyZm9ybWFuY2UnLFxuICAgICAgY2FudmFzOiBjYW52YXNFbGVtZW50LFxuICAgICAgYW50aWFsaWFzOiB0cnVlLFxuICAgICAgYWxwaGE6IHRydWUsXG4gICAgICAuLi4oZ2xPcHRpb25zIHx8IHt9KSxcbiAgICB9KTtcblxuICAgIGlmIChnbE9wdGlvbnMpIHtcbiAgICAgIGFwcGx5UHJvcHMoXG4gICAgICAgIHJlbmRlcmVyIGFzIHVua25vd24gYXMgTmd0SW5zdGFuY2UsXG4gICAgICAgIGdsT3B0aW9ucyBhcyBVbmtub3duUmVjb3JkXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChzaGFkb3dzKSB7XG4gICAgICByZW5kZXJlci5zaGFkb3dNYXAuZW5hYmxlZCA9IHRydWU7XG4gICAgICBpZiAodHlwZW9mIHNoYWRvd3MgPT09ICdvYmplY3QnKSB7XG4gICAgICAgIE9iamVjdC5hc3NpZ24ocmVuZGVyZXIuc2hhZG93TWFwLCBzaGFkb3dzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlbmRlcmVyLnNoYWRvd01hcC50eXBlID0gVEhSRUUuUENGU29mdFNoYWRvd01hcDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIWxpbmVhcikge1xuICAgICAgLy8gYXV0byBjb2xvciBtYW5hZ2VtZW50XG4gICAgICByZW5kZXJlci50b25lTWFwcGluZyA9IFRIUkVFLkFDRVNGaWxtaWNUb25lTWFwcGluZztcbiAgICAgIHJlbmRlcmVyLm91dHB1dEVuY29kaW5nID0gVEhSRUUuc1JHQkVuY29kaW5nO1xuICAgIH0gZWxzZSB7XG4gICAgICByZW5kZXJlci5vdXRwdXRFbmNvZGluZyA9IFRIUkVFLkxpbmVhckVuY29kaW5nO1xuICAgIH1cblxuICAgIGlmIChmbGF0KSB7XG4gICAgICByZW5kZXJlci50b25lTWFwcGluZyA9IFRIUkVFLk5vVG9uZU1hcHBpbmc7XG4gICAgfVxuXG4gICAgcmVuZGVyZXIuc2V0Q2xlYXJBbHBoYSgwKTtcbiAgICByZW5kZXJlci5zZXRQaXhlbFJhdGlvKGNhbGN1bGF0ZURwcih2aWV3cG9ydC5kcHIpKTtcbiAgICByZW5kZXJlci5zZXRTaXplKHNpemUud2lkdGgsIHNpemUuaGVpZ2h0KTtcblxuICAgIGlmICh2cikge1xuICAgICAgcmVuZGVyZXIueHIuZW5hYmxlZCA9IHRydWU7XG4gICAgfVxuXG4gICAgdGhpcy5zZXQoe1xuICAgICAgcmVuZGVyZXIsXG4gICAgICBzY2VuZSxcbiAgICAgIGNhbWVyYSxcbiAgICAgIHJheWNhc3RlcjogcmF5Y2FzdGVyIGFzIE5ndFJheWNhc3RlcixcbiAgICB9KTtcblxuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBjb25zdCB7IHJlbmRlcmVyLCB2ciB9ID0gdGhpcy5nZXQoKTtcbiAgICAgIGlmIChyZW5kZXJlcikge1xuICAgICAgICByZW5kZXJlci5yZW5kZXJMaXN0cy5kaXNwb3NlKCk7XG4gICAgICAgIHJlbmRlcmVyLmZvcmNlQ29udGV4dExvc3MoKTtcblxuICAgICAgICBpZiAodnIpIHtcbiAgICAgICAgICByZW5kZXJlci5zZXRBbmltYXRpb25Mb29wKG51bGwpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gICN1cGRhdGVEaW1lbnNpb25zKHtcbiAgICBzaXplLFxuICAgIHZpZXdwb3J0LFxuICB9OiB7XG4gICAgc2l6ZTogTmd0U2l6ZTtcbiAgICB2aWV3cG9ydDogTmd0Vmlld3BvcnQ7XG4gIH0pIHtcbiAgICBjb25zdCB7IGNhbWVyYSwgcmVuZGVyZXIsIHJlYWR5LCBjYW1lcmFPcHRpb25zIH0gPSB0aGlzLmdldCgpO1xuXG4gICAgaWYgKHJlYWR5KSB7XG4gICAgICAvLyB1cGRhdGUgcmVuZGVyZXJcbiAgICAgIHJlbmRlcmVyLnNldFBpeGVsUmF0aW8odmlld3BvcnQuZHByKTtcbiAgICAgIHJlbmRlcmVyLnNldFNpemUoc2l6ZS53aWR0aCwgc2l6ZS5oZWlnaHQpO1xuXG4gICAgICAvLyBsZWF2ZSB0aGUgdXNlcmxhbmQgY2FtZXJhIGFsb25lXG4gICAgICBpZiAoY2FtZXJhT3B0aW9ucyBpbnN0YW5jZW9mIFRIUkVFLkNhbWVyYSkgcmV0dXJuO1xuXG4gICAgICBpZiAoaXNPcnRob2dyYXBoaWNDYW1lcmEoY2FtZXJhKSkge1xuICAgICAgICBjYW1lcmEubGVmdCA9IHNpemUud2lkdGggLyAtMjtcbiAgICAgICAgY2FtZXJhLnJpZ2h0ID0gc2l6ZS53aWR0aCAvIDI7XG4gICAgICAgIGNhbWVyYS50b3AgPSBzaXplLmhlaWdodCAvIDI7XG4gICAgICAgIGNhbWVyYS5ib3R0b20gPSBzaXplLmhlaWdodCAvIC0yO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2FtZXJhLmFzcGVjdCA9IHNpemUud2lkdGggLyBzaXplLmhlaWdodDtcbiAgICAgIH1cblxuICAgICAgY2FtZXJhLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTtcbiAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9wbW5kcnMvcmVhY3QtdGhyZWUtZmliZXIvaXNzdWVzLzE3OFxuICAgICAgLy8gVXBkYXRlIG1hdHJpeCB3b3JsZCBzaW5jZSB0aGUgcmVuZGVyZXIgaXMgYSBmcmFtZSBsYXRlXG4gICAgICBjYW1lcmEudXBkYXRlTWF0cml4V29ybGQoKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==