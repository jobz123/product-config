import { Directive } from '@angular/core';
import { createSideEffectObservable, RxState } from '@rx-angular/state';
import { catchError, EMPTY, noop, Subject, tap } from 'rxjs';
import * as i0 from "@angular/core";
function actionProxyHandler(subjects, transforms) {
    return {
        get(_, property) {
            const prop = property;
            // the user wants to get a observable
            if (prop.toString().split('').pop() === '$') {
                const propName = prop.toString().slice(0, -1);
                subjects[propName] = subjects[propName] || new Subject();
                return subjects[propName];
            }
            // the user wants to get a dispatcher function
            return (args) => {
                subjects[prop] = subjects[prop] || new Subject();
                const val = transforms && transforms[prop]
                    ? transforms[prop](args)
                    : args;
                subjects[prop].next(val);
            };
        },
        set() {
            throw new Error('No setters available. To emit call the property name.');
        },
    };
}
export class EnhancedRxState extends RxState {
    constructor() {
        super(...arguments);
        this.subjects = {};
        this.effect$ = createSideEffectObservable();
        this.effectSubscription = this.effect$.subscribe();
    }
    ngOnDestroy() {
        super.ngOnDestroy();
        this.effectSubscription.unsubscribe();
        this.destroy();
    }
    create(transforms) {
        return new Proxy({}, actionProxyHandler(this.subjects, transforms));
    }
    destroy() {
        for (const subjectsKey in this.subjects) {
            this.subjects[subjectsKey].complete();
        }
    }
    holdEffect(obsOrObsWithSideEffect, sideEffectFn) {
        let cleanupFn = noop;
        let firstRun = false;
        let latestValue = undefined;
        const sideEffect = obsOrObsWithSideEffect.pipe(catchError((_) => EMPTY));
        this.effect$.nextEffectObservable(sideEffect.pipe(tap({
            next: (value) => {
                if (cleanupFn && firstRun) {
                    cleanupFn(latestValue, false);
                }
                const cleanUpOrVoid = sideEffectFn(value, firstRun);
                if (cleanUpOrVoid) {
                    cleanupFn = cleanUpOrVoid;
                }
                latestValue = value;
                if (!firstRun) {
                    firstRun = true;
                }
            },
            unsubscribe: () => {
                if (cleanupFn) {
                    cleanupFn(latestValue, true);
                }
            },
        })));
    }
}
EnhancedRxState.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: EnhancedRxState, deps: null, target: i0.ɵɵFactoryTarget.Directive });
EnhancedRxState.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.1.1", type: EnhancedRxState, usesInheritance: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: EnhancedRxState, decorators: [{
            type: Directive
        }] });
export function capitalize(str) {
    return (str.charAt(0).toUpperCase() + str.slice(1));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW5oYW5jZWQtcngtc3RhdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9jb3JlL3NyYy9saWIvc3RvcmVzL2VuaGFuY2VkLXJ4LXN0YXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDMUMsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE9BQU8sRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3hFLE9BQU8sRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBYyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sTUFBTSxDQUFDOztBQXlEekUsU0FBUyxrQkFBa0IsQ0FDekIsUUFBdUIsRUFDdkIsVUFBYztJQUVkLE9BQU87UUFDTCxHQUFHLENBQUMsQ0FBQyxFQUFFLFFBQWdCO1lBSXJCLE1BQU0sSUFBSSxHQUFHLFFBQW1CLENBQUM7WUFFakMscUNBQXFDO1lBQ3JDLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLEVBQUUsS0FBSyxHQUFHLEVBQUU7Z0JBQzNDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFZLENBQUM7Z0JBQ3pELFFBQVEsQ0FBQyxRQUFRLENBQUMsR0FBRyxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksSUFBSSxPQUFPLEVBQWEsQ0FBQztnQkFDcEUsT0FBTyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDM0I7WUFFRCw4Q0FBOEM7WUFDOUMsT0FBTyxDQUFDLElBQWUsRUFBRSxFQUFFO2dCQUN6QixRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksT0FBTyxFQUFhLENBQUM7Z0JBQzVELE1BQU0sR0FBRyxHQUNQLFVBQVUsSUFBSyxVQUFrQixDQUFDLElBQUksQ0FBQztvQkFDckMsQ0FBQyxDQUFFLFVBQWtCLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUNqQyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNYLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDM0IsQ0FBQyxDQUFDO1FBQ0osQ0FBQztRQUNELEdBQUc7WUFDRCxNQUFNLElBQUksS0FBSyxDQUFDLHVEQUF1RCxDQUFDLENBQUM7UUFDM0UsQ0FBQztLQUNGLENBQUM7QUFDSixDQUFDO0FBR0QsTUFBTSxPQUFPLGVBR1gsU0FBUSxPQUFVO0lBSnBCOztRQUtVLGFBQVEsR0FBeUIsRUFBMEIsQ0FBQztRQUU1RCxZQUFPLEdBQUcsMEJBQTBCLEVBQUUsQ0FBQztRQUN2Qyx1QkFBa0IsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxDQUFDO0tBcUV2RDtJQW5FQyxXQUFXO1FBQ1QsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUN0QyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDakIsQ0FBQztJQUVELE1BQU0sQ0FDSixVQUFjO1FBRWQsT0FBTyxJQUFJLEtBQUssQ0FDZCxFQUE0QixFQUM1QixrQkFBa0IsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUNwQixDQUFDO0lBQzlCLENBQUM7SUFFRCxPQUFPO1FBQ0wsS0FBSyxNQUFNLFdBQVcsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ3ZDLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7U0FDdkM7SUFDSCxDQUFDO0lBRUQsVUFBVSxDQUNSLHNCQUFxQyxFQUNyQyxZQUtRO1FBRVIsSUFBSSxTQUFTLEdBR0QsSUFBSSxDQUFDO1FBQ2pCLElBQUksUUFBUSxHQUFHLEtBQUssQ0FBQztRQUNyQixJQUFJLFdBQVcsR0FBa0IsU0FBUyxDQUFDO1FBRTNDLE1BQU0sVUFBVSxHQUFHLHNCQUFzQixDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFFekUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxvQkFBb0IsQ0FDL0IsVUFBVSxDQUFDLElBQUksQ0FDYixHQUFHLENBQUM7WUFDRixJQUFJLEVBQUUsQ0FBQyxLQUFRLEVBQUUsRUFBRTtnQkFDakIsSUFBSSxTQUFTLElBQUksUUFBUSxFQUFFO29CQUN6QixTQUFTLENBQUMsV0FBVyxFQUFFLEtBQUssQ0FBQyxDQUFDO2lCQUMvQjtnQkFFRCxNQUFNLGFBQWEsR0FBRyxZQUFZLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO2dCQUNwRCxJQUFJLGFBQWEsRUFBRTtvQkFDakIsU0FBUyxHQUFHLGFBQWEsQ0FBQztpQkFDM0I7Z0JBRUQsV0FBVyxHQUFHLEtBQUssQ0FBQztnQkFFcEIsSUFBSSxDQUFDLFFBQVEsRUFBRTtvQkFDYixRQUFRLEdBQUcsSUFBSSxDQUFDO2lCQUNqQjtZQUNILENBQUM7WUFDRCxXQUFXLEVBQUUsR0FBRyxFQUFFO2dCQUNoQixJQUFJLFNBQVMsRUFBRTtvQkFDYixTQUFTLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxDQUFDO2lCQUM5QjtZQUNILENBQUM7U0FDRixDQUFDLENBQ0gsQ0FDRixDQUFDO0lBQ0osQ0FBQzs7NEdBM0VVLGVBQWU7Z0dBQWYsZUFBZTsyRkFBZixlQUFlO2tCQUQzQixTQUFTOztBQStFVixNQUFNLFVBQVUsVUFBVSxDQUFtQixHQUFNO0lBQ2pELE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQWtCLENBQUM7QUFDdkUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgY3JlYXRlU2lkZUVmZmVjdE9ic2VydmFibGUsIFJ4U3RhdGUgfSBmcm9tICdAcngtYW5ndWxhci9zdGF0ZSc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBFTVBUWSwgbm9vcCwgT2JzZXJ2YWJsZSwgU3ViamVjdCwgdGFwIH0gZnJvbSAncnhqcyc7XG5cbi8vIEZyb20gUnhBbmd1bGFyXG5cbnR5cGUgU3ViamVjdE1hcDxUPiA9IHsgW0sgaW4ga2V5b2YgVF06IFN1YmplY3Q8VFtLXT4gfTtcblxuZXhwb3J0IHR5cGUgVmFsdWVzT2Y8Tz4gPSBPW2tleW9mIE9dO1xuLy8gdHlwZSBLZXlzID0gS2V5c09mPHsgYTogc3RyaW5nLCBiOiBudW1iZXIgfT47IC8vIFwiYVwiIHwgXCJiXCJcbmV4cG9ydCB0eXBlIEtleXNPZjxPPiA9IGtleW9mIE87XG5cbi8vIGNsYXNzIHZzIGluc3RhbmNlXG50eXBlIEluc3RhbmNlT3JUeXBlPFQ+ID0gVCBleHRlbmRzIGFic3RyYWN0IG5ldyAoLi4uYXJnczogYW55KSA9PiBpbmZlciBSXG4gID8gUlxuICA6IFQ7XG5cbi8vIFdlIGluZmVyIGFsbCBhcmd1bWVudHMgaW5zdGVhZCBvZiBqdXN0IHRoZSBmaXJzdCBvbmUgYXMgd2UgYXJlIG1vcmUgZmxleGlibGUgZm9yIGxhdGVyIGNoYW5nZXNcbnR5cGUgSW5mZXJBcmd1bWVudHM8VD4gPSBUIGV4dGVuZHMgKC4uLmFyZ3M6IGluZmVyIFIpID0+IGFueSA/IFIgOiBuZXZlcjtcblxuLy8gSXQgaGVscHMgdG8gaW5mZXIgdGhlIHR5cGUgb2YgYW4gb2JqZWN0cyBrZXlcbi8vIFdlIGhhdmUgdG8gdXNlIGl0IGJlY2F1c2UgdXNpbmcganVzdCBVW0tdIGRpcmVjdGx5IHdvdWxkIEBUT0RPXG50eXBlIFNlbGVjdDxVLCBLPiA9IEsgZXh0ZW5kcyBrZXlvZiBVID8gVVtLXSA6IG5ldmVyO1xuXG50eXBlIEV4dHJhY3RTdHJpbmc8VCBleHRlbmRzIG9iamVjdD4gPSBFeHRyYWN0PGtleW9mIFQsIHN0cmluZz47XG5cbi8vIEhlbHBlciB0byBnZXQgZWl0aGVyIHRoZSBwYXJhbXMgb2YgdGhlIHRyYW5zZm9ybSBmdW5jdGlvbiwgb3IgaWYgdGhlIGZ1bmN0aW9uIGlzIG5vdCBwcmVzZW50IGEgZmFsbGJhY2sgdHlwZVxudHlwZSBGdW5jdGlvblBhcmFtc09yVmFsdWVUeXBlPFUsIEssIEY+ID0gSW5mZXJBcmd1bWVudHM8XG4gIFNlbGVjdDxVLCBLPlxuPiBleHRlbmRzIG5ldmVyXG4gID8gW0ZdXG4gIDogSW5mZXJBcmd1bWVudHM8U2VsZWN0PFUsIEs+PjtcblxuZXhwb3J0IHR5cGUgQWN0aW9ucyA9IHt9O1xuXG5leHBvcnQgdHlwZSBBY3Rpb25UcmFuc2Zvcm1zPFQgZXh0ZW5kcyB7fT4gPSBQYXJ0aWFsPHtcbiAgW0sgaW4ga2V5b2YgVF06ICguLi5hcmdzOiBhbnlbXSkgPT4gVFtLXTtcbn0+O1xuXG5leHBvcnQgdHlwZSBBY3Rpb25EaXNwYXRjaEZuPE8gZXh0ZW5kcyB1bmtub3duW10+ID0gKFxuICAuLi52YWx1ZTogSW5zdGFuY2VPclR5cGU8Tz5cbikgPT4gdm9pZDtcblxuZXhwb3J0IHR5cGUgQWN0aW9uRGlzcGF0Y2hlcnM8VCBleHRlbmRzIEFjdGlvbnMsIFUgZXh0ZW5kcyB7fT4gPSB7XG4gIFtLIGluIGtleW9mIFRdOiBBY3Rpb25EaXNwYXRjaEZuPFxuICAgIEZ1bmN0aW9uUGFyYW1zT3JWYWx1ZVR5cGU8VSwgSywgU2VsZWN0PFQsIEs+PlxuICA+O1xufTtcblxuZXhwb3J0IHR5cGUgQWN0aW9uT2JzZXJ2YWJsZXM8VCBleHRlbmRzIEFjdGlvbnM+ID0ge1xuICBbSyBpbiBFeHRyYWN0U3RyaW5nPFQ+IGFzIGAke0t9JGBdOiBPYnNlcnZhYmxlPEluc3RhbmNlT3JUeXBlPFRbS10+Pjtcbn07XG5cbmV4cG9ydCB0eXBlIFJ4QWN0aW9uczxUIGV4dGVuZHMgQWN0aW9ucywgVSBleHRlbmRzIHt9ID0gVD4gPSBBY3Rpb25EaXNwYXRjaGVyczxcbiAgVCxcbiAgVVxuPiAmXG4gIEFjdGlvbk9ic2VydmFibGVzPFQ+O1xuXG5mdW5jdGlvbiBhY3Rpb25Qcm94eUhhbmRsZXI8VCwgVT4oXG4gIHN1YmplY3RzOiBTdWJqZWN0TWFwPFQ+LFxuICB0cmFuc2Zvcm1zPzogVVxuKTogUHJveHlIYW5kbGVyPFJ4QWN0aW9uczxULCBVPj4ge1xuICByZXR1cm4ge1xuICAgIGdldChfLCBwcm9wZXJ0eTogc3RyaW5nKSB7XG4gICAgICB0eXBlIEtleXNPZlQgPSBLZXlzT2Y8VD47XG4gICAgICB0eXBlIFZhbHVlc09mVCA9IFZhbHVlc09mPFQ+O1xuXG4gICAgICBjb25zdCBwcm9wID0gcHJvcGVydHkgYXMgS2V5c09mVDtcblxuICAgICAgLy8gdGhlIHVzZXIgd2FudHMgdG8gZ2V0IGEgb2JzZXJ2YWJsZVxuICAgICAgaWYgKHByb3AudG9TdHJpbmcoKS5zcGxpdCgnJykucG9wKCkgPT09ICckJykge1xuICAgICAgICBjb25zdCBwcm9wTmFtZSA9IHByb3AudG9TdHJpbmcoKS5zbGljZSgwLCAtMSkgYXMgS2V5c09mVDtcbiAgICAgICAgc3ViamVjdHNbcHJvcE5hbWVdID0gc3ViamVjdHNbcHJvcE5hbWVdIHx8IG5ldyBTdWJqZWN0PFZhbHVlc09mVD4oKTtcbiAgICAgICAgcmV0dXJuIHN1YmplY3RzW3Byb3BOYW1lXTtcbiAgICAgIH1cblxuICAgICAgLy8gdGhlIHVzZXIgd2FudHMgdG8gZ2V0IGEgZGlzcGF0Y2hlciBmdW5jdGlvblxuICAgICAgcmV0dXJuIChhcmdzOiBWYWx1ZXNPZlQpID0+IHtcbiAgICAgICAgc3ViamVjdHNbcHJvcF0gPSBzdWJqZWN0c1twcm9wXSB8fCBuZXcgU3ViamVjdDxWYWx1ZXNPZlQ+KCk7XG4gICAgICAgIGNvbnN0IHZhbCA9XG4gICAgICAgICAgdHJhbnNmb3JtcyAmJiAodHJhbnNmb3JtcyBhcyBhbnkpW3Byb3BdXG4gICAgICAgICAgICA/ICh0cmFuc2Zvcm1zIGFzIGFueSlbcHJvcF0oYXJncylcbiAgICAgICAgICAgIDogYXJncztcbiAgICAgICAgc3ViamVjdHNbcHJvcF0ubmV4dCh2YWwpO1xuICAgICAgfTtcbiAgICB9LFxuICAgIHNldCgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTm8gc2V0dGVycyBhdmFpbGFibGUuIFRvIGVtaXQgY2FsbCB0aGUgcHJvcGVydHkgbmFtZS4nKTtcbiAgICB9LFxuICB9O1xufVxuXG5ARGlyZWN0aXZlKClcbmV4cG9ydCBjbGFzcyBFbmhhbmNlZFJ4U3RhdGU8XG4gIFQgZXh0ZW5kcyBvYmplY3QgPSB7fSxcbiAgVEFjdGlvbnMgZXh0ZW5kcyBvYmplY3QgPSB7fVxuPiBleHRlbmRzIFJ4U3RhdGU8VD4ge1xuICBwcml2YXRlIHN1YmplY3RzOiBTdWJqZWN0TWFwPFRBY3Rpb25zPiA9IHt9IGFzIFN1YmplY3RNYXA8VEFjdGlvbnM+O1xuXG4gIHByaXZhdGUgZWZmZWN0JCA9IGNyZWF0ZVNpZGVFZmZlY3RPYnNlcnZhYmxlKCk7XG4gIHByaXZhdGUgZWZmZWN0U3Vic2NyaXB0aW9uID0gdGhpcy5lZmZlY3QkLnN1YnNjcmliZSgpO1xuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHN1cGVyLm5nT25EZXN0cm95KCk7XG4gICAgdGhpcy5lZmZlY3RTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB0aGlzLmRlc3Ryb3koKTtcbiAgfVxuXG4gIGNyZWF0ZTxVIGV4dGVuZHMgQWN0aW9uVHJhbnNmb3JtczxUQWN0aW9ucz4gPSB7fT4oXG4gICAgdHJhbnNmb3Jtcz86IFVcbiAgKTogUnhBY3Rpb25zPFRBY3Rpb25zLCBVPiB7XG4gICAgcmV0dXJuIG5ldyBQcm94eShcbiAgICAgIHt9IGFzIFJ4QWN0aW9uczxUQWN0aW9ucywgVT4sXG4gICAgICBhY3Rpb25Qcm94eUhhbmRsZXIodGhpcy5zdWJqZWN0cywgdHJhbnNmb3JtcylcbiAgICApIGFzIFJ4QWN0aW9uczxUQWN0aW9ucywgVT47XG4gIH1cblxuICBkZXN0cm95KCkge1xuICAgIGZvciAoY29uc3Qgc3ViamVjdHNLZXkgaW4gdGhpcy5zdWJqZWN0cykge1xuICAgICAgdGhpcy5zdWJqZWN0c1tzdWJqZWN0c0tleV0uY29tcGxldGUoKTtcbiAgICB9XG4gIH1cblxuICBob2xkRWZmZWN0PFM+KFxuICAgIG9ic09yT2JzV2l0aFNpZGVFZmZlY3Q6IE9ic2VydmFibGU8Uz4sXG4gICAgc2lkZUVmZmVjdEZuOiAoXG4gICAgICB2YWx1ZTogUyxcbiAgICAgIGZpcnN0UnVuOiBib29sZWFuXG4gICAgKSA9PlxuICAgICAgfCAoKHByZXZpb3VzVmFsdWU6IFMgfCB1bmRlZmluZWQsIGlzVW5zdWJzY3JpYmVkOiBib29sZWFuKSA9PiB2b2lkKVxuICAgICAgfCB2b2lkXG4gICk6IHZvaWQge1xuICAgIGxldCBjbGVhbnVwRm46IChcbiAgICAgIHByZXZpb3VzVmFsdWU6IFMgfCB1bmRlZmluZWQsXG4gICAgICBpc1Vuc3Vic2NyaWJlZDogYm9vbGVhblxuICAgICkgPT4gdm9pZCA9IG5vb3A7XG4gICAgbGV0IGZpcnN0UnVuID0gZmFsc2U7XG4gICAgbGV0IGxhdGVzdFZhbHVlOiBTIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuXG4gICAgY29uc3Qgc2lkZUVmZmVjdCA9IG9ic09yT2JzV2l0aFNpZGVFZmZlY3QucGlwZShjYXRjaEVycm9yKChfKSA9PiBFTVBUWSkpO1xuXG4gICAgdGhpcy5lZmZlY3QkLm5leHRFZmZlY3RPYnNlcnZhYmxlKFxuICAgICAgc2lkZUVmZmVjdC5waXBlKFxuICAgICAgICB0YXAoe1xuICAgICAgICAgIG5leHQ6ICh2YWx1ZTogUykgPT4ge1xuICAgICAgICAgICAgaWYgKGNsZWFudXBGbiAmJiBmaXJzdFJ1bikge1xuICAgICAgICAgICAgICBjbGVhbnVwRm4obGF0ZXN0VmFsdWUsIGZhbHNlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgY2xlYW5VcE9yVm9pZCA9IHNpZGVFZmZlY3RGbih2YWx1ZSwgZmlyc3RSdW4pO1xuICAgICAgICAgICAgaWYgKGNsZWFuVXBPclZvaWQpIHtcbiAgICAgICAgICAgICAgY2xlYW51cEZuID0gY2xlYW5VcE9yVm9pZDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGF0ZXN0VmFsdWUgPSB2YWx1ZTtcblxuICAgICAgICAgICAgaWYgKCFmaXJzdFJ1bikge1xuICAgICAgICAgICAgICBmaXJzdFJ1biA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSxcbiAgICAgICAgICB1bnN1YnNjcmliZTogKCkgPT4ge1xuICAgICAgICAgICAgaWYgKGNsZWFudXBGbikge1xuICAgICAgICAgICAgICBjbGVhbnVwRm4obGF0ZXN0VmFsdWUsIHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0sXG4gICAgICAgIH0pXG4gICAgICApXG4gICAgKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY2FwaXRhbGl6ZTxUIGV4dGVuZHMgc3RyaW5nPihzdHI6IFQpOiBDYXBpdGFsaXplPFQ+IHtcbiAgcmV0dXJuIChzdHIuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBzdHIuc2xpY2UoMSkpIGFzIENhcGl0YWxpemU8VD47XG59XG4iXX0=