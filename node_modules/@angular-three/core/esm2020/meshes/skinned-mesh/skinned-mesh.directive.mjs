var _NgtSkeleton_skeleton, _NgtBone_bone;
import { __classPrivateFieldGet, __classPrivateFieldSet } from "tslib";
import { NGT_MATERIAL_GEOMETRY_CONTROLLER_PROVIDER, NGT_OBJECT_CONTROLLER_PROVIDER, NGT_OBJECT_INPUTS_WATCHED_CONTROLLER, NGT_OBJECT_TYPE, NGT_OBJECT_WATCHED_CONTROLLER, NgtCommonMesh, NgtMaterialGeometryControllerModule, NgtObject3dController, NgtObject3dInputsController, } from '@angular-three/core';
import { Directive, EventEmitter, Inject, Input, NgModule, NgZone, Optional, Output, } from '@angular/core';
import { requestAnimationFrame } from '@rx-angular/cdk/zone-less';
import * as THREE from 'three';
import * as i0 from "@angular/core";
import * as i1 from "@angular-three/core";
export class NgtSkinnedMesh extends NgtCommonMesh {
    set args(v) {
        if (this.materialGeometryController) {
            this.materialGeometryController.meshArgs = v;
        }
    }
}
NgtSkinnedMesh.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSkinnedMesh, deps: null, target: i0.ɵɵFactoryTarget.Directive });
NgtSkinnedMesh.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.1.1", type: NgtSkinnedMesh, selector: "ngt-skinned-mesh", inputs: { args: "args", bindMatrix: "bindMatrix", bindMode: "bindMode" }, providers: [
        { provide: NgtCommonMesh, useExisting: NgtSkinnedMesh },
        NGT_MATERIAL_GEOMETRY_CONTROLLER_PROVIDER,
        { provide: NGT_OBJECT_TYPE, useValue: THREE.SkinnedMesh },
    ], exportAs: ["ngtSkinnedMesh"], usesInheritance: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSkinnedMesh, decorators: [{
            type: Directive,
            args: [{
                    selector: 'ngt-skinned-mesh',
                    exportAs: 'ngtSkinnedMesh',
                    providers: [
                        { provide: NgtCommonMesh, useExisting: NgtSkinnedMesh },
                        NGT_MATERIAL_GEOMETRY_CONTROLLER_PROVIDER,
                        { provide: NGT_OBJECT_TYPE, useValue: THREE.SkinnedMesh },
                    ],
                }]
        }], propDecorators: { args: [{
                type: Input
            }], bindMatrix: [{
                type: Input
            }], bindMode: [{
                type: Input
            }] } });
export class NgtSkeleton {
    constructor(ngZone, skinnedMesh) {
        this.ngZone = ngZone;
        this.skinnedMesh = skinnedMesh;
        this.ready = new EventEmitter();
        _NgtSkeleton_skeleton.set(this, void 0);
        if (!skinnedMesh) {
            throw new Error('ngt-skeleton must be used within a ngt-skinned-mesh');
        }
    }
    get skeleton() {
        return __classPrivateFieldGet(this, _NgtSkeleton_skeleton, "f");
    }
    ngOnInit() {
        this.ngZone.runOutsideAngular(() => {
            const boneInverses = this.boneInverses
                ? this.boneInverses.map((threeMaxtrix) => {
                    if (threeMaxtrix instanceof THREE.Matrix4)
                        return threeMaxtrix;
                    return new THREE.Matrix4().set(...threeMaxtrix);
                })
                : undefined;
            __classPrivateFieldSet(this, _NgtSkeleton_skeleton, new THREE.Skeleton([], boneInverses), "f");
            this.ready.emit(this.skeleton);
            if (this.skinnedMesh) {
                const bindMatrix = this.skinnedMesh
                    .bindMatrix
                    ? this.skinnedMesh.bindMatrix instanceof THREE.Matrix4
                        ? this.skinnedMesh.bindMatrix
                        : new THREE.Matrix4().set(...this.skinnedMesh.bindMatrix)
                    : undefined;
                this.skinnedMesh.mesh.bind(this.skeleton, bindMatrix);
            }
        });
    }
}
_NgtSkeleton_skeleton = new WeakMap();
NgtSkeleton.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSkeleton, deps: [{ token: i0.NgZone }, { token: NgtSkinnedMesh, optional: true }], target: i0.ɵɵFactoryTarget.Directive });
NgtSkeleton.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.1.1", type: NgtSkeleton, selector: "ngt-skeleton", inputs: { boneInverses: "boneInverses" }, outputs: { ready: "ready" }, exportAs: ["ngtSkeleton"], ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSkeleton, decorators: [{
            type: Directive,
            args: [{
                    selector: 'ngt-skeleton',
                    exportAs: 'ngtSkeleton',
                }]
        }], ctorParameters: function () { return [{ type: i0.NgZone }, { type: NgtSkinnedMesh, decorators: [{
                    type: Optional
                }] }]; }, propDecorators: { boneInverses: [{
                type: Input
            }], ready: [{
                type: Output
            }] } });
export class NgtBone {
    constructor(objectController, objectInputsController, ngZone, parentSkinnedMesh, parentSkeleton) {
        this.objectController = objectController;
        this.objectInputsController = objectInputsController;
        this.ngZone = ngZone;
        this.parentSkinnedMesh = parentSkinnedMesh;
        this.parentSkeleton = parentSkeleton;
        this.ready = new EventEmitter();
        _NgtBone_bone.set(this, void 0);
        if (!parentSkinnedMesh) {
            throw new Error('ngt-bone must be used within a ngt-skinned-mesh');
        }
        objectInputsController.appendTo = parentSkinnedMesh.mesh;
        objectController.initFn = () => {
            __classPrivateFieldSet(this, _NgtBone_bone, new THREE.Bone(), "f");
            return __classPrivateFieldGet(this, _NgtBone_bone, "f");
        };
        objectController.readyFn = () => {
            this.ready.emit(this.bone);
        };
    }
    get bone() {
        return __classPrivateFieldGet(this, _NgtBone_bone, "f");
    }
    ngOnInit() {
        this.ngZone.runOutsideAngular(() => {
            this.objectController.init();
            requestAnimationFrame(() => {
                if (this.parentSkeleton && this.parentSkeleton.skeleton) {
                    this.parentSkeleton.skeleton.bones.push(this.bone);
                }
            });
        });
    }
}
_NgtBone_bone = new WeakMap();
NgtBone.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtBone, deps: [{ token: NGT_OBJECT_WATCHED_CONTROLLER }, { token: NGT_OBJECT_INPUTS_WATCHED_CONTROLLER }, { token: i0.NgZone }, { token: NgtSkinnedMesh, optional: true }, { token: NgtSkeleton, optional: true }], target: i0.ɵɵFactoryTarget.Directive });
NgtBone.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.1.1", type: NgtBone, selector: "ngt-bone", outputs: { ready: "ready" }, providers: [NGT_OBJECT_CONTROLLER_PROVIDER], exportAs: ["ngtBone"], ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtBone, decorators: [{
            type: Directive,
            args: [{
                    selector: 'ngt-bone',
                    exportAs: 'ngtBone',
                    providers: [NGT_OBJECT_CONTROLLER_PROVIDER],
                }]
        }], ctorParameters: function () { return [{ type: i1.NgtObject3dController, decorators: [{
                    type: Inject,
                    args: [NGT_OBJECT_WATCHED_CONTROLLER]
                }] }, { type: i1.NgtObject3dInputsController, decorators: [{
                    type: Inject,
                    args: [NGT_OBJECT_INPUTS_WATCHED_CONTROLLER]
                }] }, { type: i0.NgZone }, { type: NgtSkinnedMesh, decorators: [{
                    type: Optional
                }] }, { type: NgtSkeleton, decorators: [{
                    type: Optional
                }] }]; }, propDecorators: { ready: [{
                type: Output
            }] } });
export class NgtSkinnedMeshModule {
}
NgtSkinnedMeshModule.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSkinnedMeshModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule });
NgtSkinnedMeshModule.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSkinnedMeshModule, declarations: [NgtSkinnedMesh, NgtBone, NgtSkeleton], exports: [NgtSkinnedMesh, NgtBone, NgtSkeleton, NgtMaterialGeometryControllerModule] });
NgtSkinnedMeshModule.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSkinnedMeshModule, imports: [NgtMaterialGeometryControllerModule] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NgtSkinnedMeshModule, decorators: [{
            type: NgModule,
            args: [{
                    declarations: [NgtSkinnedMesh, NgtBone, NgtSkeleton],
                    exports: [
                        NgtSkinnedMesh,
                        NgtBone,
                        NgtSkeleton,
                        NgtMaterialGeometryControllerModule,
                    ],
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2tpbm5lZC1tZXNoLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2NvcmUvbWVzaGVzL3NyYy9za2lubmVkLW1lc2gvc2tpbm5lZC1tZXNoLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE9BQU8sRUFDTCx5Q0FBeUMsRUFDekMsOEJBQThCLEVBQzlCLG9DQUFvQyxFQUNwQyxlQUFlLEVBQ2YsNkJBQTZCLEVBQzdCLGFBQWEsRUFDYixtQ0FBbUMsRUFFbkMscUJBQXFCLEVBQ3JCLDJCQUEyQixHQUM1QixNQUFNLHFCQUFxQixDQUFDO0FBQzdCLE9BQU8sRUFDTCxTQUFTLEVBQ1QsWUFBWSxFQUNaLE1BQU0sRUFDTixLQUFLLEVBQ0wsUUFBUSxFQUNSLE1BQU0sRUFFTixRQUFRLEVBQ1IsTUFBTSxHQUNQLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ2xFLE9BQU8sS0FBSyxLQUFLLE1BQU0sT0FBTyxDQUFDOzs7QUFXL0IsTUFBTSxPQUFPLGNBQWUsU0FBUSxhQUFnQztJQUNsRSxJQUFhLElBQUksQ0FBQyxDQUFZO1FBQzVCLElBQUksSUFBSSxDQUFDLDBCQUEwQixFQUFFO1lBQ25DLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDO1NBQzlDO0lBQ0gsQ0FBQzs7MkdBTFUsY0FBYzsrRkFBZCxjQUFjLHFIQU5kO1FBQ1QsRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFLFdBQVcsRUFBRSxjQUFjLEVBQUU7UUFDdkQseUNBQXlDO1FBQ3pDLEVBQUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxRQUFRLEVBQUUsS0FBSyxDQUFDLFdBQVcsRUFBRTtLQUMxRDsyRkFFVSxjQUFjO2tCQVQxQixTQUFTO21CQUFDO29CQUNULFFBQVEsRUFBRSxrQkFBa0I7b0JBQzVCLFFBQVEs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QTZCLGFBRTdCLG9DQUFvQyxtQ0FJakIsY0FBYyw2QkFFakIsV0FBVzt3RkFqQjFCLE9BQU8sZ0VBRlAsQ0FBQyw4QkFBOEIsQ0FBQzsyRkFFaEMsT0FBTztrQkFMbkIsU0FBUzttQkFBQztvQkFDVCxRQUFRLEVBQUUsVUFBVTtvQkFDcEIsUUFBUSxFQUFFLFNBQVM7b0JBQ25CLFNBQVMsRUFBRSxDQUFDLDhCQUE4QixDQUFDO2lCQUM1Qzs7MEJBVUksTUFBTTsyQkFBQyw2QkFBNkI7OzBCQUVwQyxNQUFNOzJCQUFDLG9DQUFvQzttREFJakIsY0FBYzswQkFEeEMsUUFBUTs4QkFHZSxXQUFXOzBCQURsQyxRQUFROzRDQWZELEtBQUs7c0JBQWQsTUFBTTs7QUFvRFQsTUFBTSxPQUFPLG9CQUFvQjs7aUhBQXBCLG9CQUFvQjtrSEFBcEIsb0JBQW9CLGlCQW5IcEIsY0FBYyxFQThEZCxPQUFPLEVBL0NQLFdBQVcsYUFmWCxjQUFjLEVBOERkLE9BQU8sRUEvQ1AsV0FBVyxFQWlHcEIsbUNBQW1DO2tIQUcxQixvQkFBb0IsWUFIN0IsbUNBQW1DOzJGQUcxQixvQkFBb0I7a0JBVGhDLFFBQVE7bUJBQUM7b0JBQ1IsWUFBWSxFQUFFLENBQUMsY0FBYyxFQUFFLE9BQU8sRUFBRSxXQUFXLENBQUM7b0JBQ3BELE9BQU8sRUFBRTt3QkFDUCxjQUFjO3dCQUNkLE9BQU87d0JBQ1AsV0FBVzt3QkFDWCxtQ0FBbUM7cUJBQ3BDO2lCQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgTkdUX01BVEVSSUFMX0dFT01FVFJZX0NPTlRST0xMRVJfUFJPVklERVIsXG4gIE5HVF9PQkpFQ1RfQ09OVFJPTExFUl9QUk9WSURFUixcbiAgTkdUX09CSkVDVF9JTlBVVFNfV0FUQ0hFRF9DT05UUk9MTEVSLFxuICBOR1RfT0JKRUNUX1RZUEUsXG4gIE5HVF9PQkpFQ1RfV0FUQ0hFRF9DT05UUk9MTEVSLFxuICBOZ3RDb21tb25NZXNoLFxuICBOZ3RNYXRlcmlhbEdlb21ldHJ5Q29udHJvbGxlck1vZHVsZSxcbiAgTmd0TWF0cml4NCxcbiAgTmd0T2JqZWN0M2RDb250cm9sbGVyLFxuICBOZ3RPYmplY3QzZElucHV0c0NvbnRyb2xsZXIsXG59IGZyb20gJ0Bhbmd1bGFyLXRocmVlL2NvcmUnO1xuaW1wb3J0IHtcbiAgRGlyZWN0aXZlLFxuICBFdmVudEVtaXR0ZXIsXG4gIEluamVjdCxcbiAgSW5wdXQsXG4gIE5nTW9kdWxlLFxuICBOZ1pvbmUsXG4gIE9uSW5pdCxcbiAgT3B0aW9uYWwsXG4gIE91dHB1dCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfSBmcm9tICdAcngtYW5ndWxhci9jZGsvem9uZS1sZXNzJztcbmltcG9ydCAqIGFzIFRIUkVFIGZyb20gJ3RocmVlJztcblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnbmd0LXNraW5uZWQtbWVzaCcsXG4gIGV4cG9ydEFzOiAnbmd0U2tpbm5lZE1lc2gnLFxuICBwcm92aWRlcnM6IFtcbiAgICB7IHByb3ZpZGU6IE5ndENvbW1vbk1lc2gsIHVzZUV4aXN0aW5nOiBOZ3RTa2lubmVkTWVzaCB9LFxuICAgIE5HVF9NQVRFUklBTF9HRU9NRVRSWV9DT05UUk9MTEVSX1BST1ZJREVSLFxuICAgIHsgcHJvdmlkZTogTkdUX09CSkVDVF9UWVBFLCB1c2VWYWx1ZTogVEhSRUUuU2tpbm5lZE1lc2ggfSxcbiAgXSxcbn0pXG5leHBvcnQgY2xhc3MgTmd0U2tpbm5lZE1lc2ggZXh0ZW5kcyBOZ3RDb21tb25NZXNoPFRIUkVFLlNraW5uZWRNZXNoPiB7XG4gIEBJbnB1dCgpIHNldCBhcmdzKHY6IFtib29sZWFuXSkge1xuICAgIGlmICh0aGlzLm1hdGVyaWFsR2VvbWV0cnlDb250cm9sbGVyKSB7XG4gICAgICB0aGlzLm1hdGVyaWFsR2VvbWV0cnlDb250cm9sbGVyLm1lc2hBcmdzID0gdjtcbiAgICB9XG4gIH1cblxuICBASW5wdXQoKSBiaW5kTWF0cml4PzogTmd0TWF0cml4NDtcbiAgQElucHV0KCkgYmluZE1vZGU/OiBzdHJpbmc7XG59XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ25ndC1za2VsZXRvbicsXG4gIGV4cG9ydEFzOiAnbmd0U2tlbGV0b24nLFxufSlcbmV4cG9ydCBjbGFzcyBOZ3RTa2VsZXRvbiBpbXBsZW1lbnRzIE9uSW5pdCB7XG4gIEBJbnB1dCgpIGJvbmVJbnZlcnNlcz86IE5ndE1hdHJpeDRbXTtcbiAgQE91dHB1dCgpIHJlYWR5ID0gbmV3IEV2ZW50RW1pdHRlcjxUSFJFRS5Ta2VsZXRvbj4oKTtcblxuICAjc2tlbGV0b24/OiBUSFJFRS5Ta2VsZXRvbjtcbiAgZ2V0IHNrZWxldG9uKCkge1xuICAgIHJldHVybiB0aGlzLiNza2VsZXRvbjtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgbmdab25lOiBOZ1pvbmUsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBza2lubmVkTWVzaDogTmd0U2tpbm5lZE1lc2hcbiAgKSB7XG4gICAgaWYgKCFza2lubmVkTWVzaCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCduZ3Qtc2tlbGV0b24gbXVzdCBiZSB1c2VkIHdpdGhpbiBhIG5ndC1za2lubmVkLW1lc2gnKTtcbiAgICB9XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLm5nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICBjb25zdCBib25lSW52ZXJzZXM6IFRIUkVFLk1hdHJpeDRbXSB8IHVuZGVmaW5lZCA9IHRoaXMuYm9uZUludmVyc2VzXG4gICAgICAgID8gdGhpcy5ib25lSW52ZXJzZXMubWFwKCh0aHJlZU1heHRyaXgpID0+IHtcbiAgICAgICAgICAgIGlmICh0aHJlZU1heHRyaXggaW5zdGFuY2VvZiBUSFJFRS5NYXRyaXg0KSByZXR1cm4gdGhyZWVNYXh0cml4O1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5NYXRyaXg0KCkuc2V0KC4uLnRocmVlTWF4dHJpeCk7XG4gICAgICAgICAgfSlcbiAgICAgICAgOiB1bmRlZmluZWQ7XG4gICAgICB0aGlzLiNza2VsZXRvbiA9IG5ldyBUSFJFRS5Ta2VsZXRvbihbXSwgYm9uZUludmVyc2VzKTtcbiAgICAgIHRoaXMucmVhZHkuZW1pdCh0aGlzLnNrZWxldG9uKTtcblxuICAgICAgaWYgKHRoaXMuc2tpbm5lZE1lc2gpIHtcbiAgICAgICAgY29uc3QgYmluZE1hdHJpeDogVEhSRUUuTWF0cml4NCB8IHVuZGVmaW5lZCA9IHRoaXMuc2tpbm5lZE1lc2hcbiAgICAgICAgICAuYmluZE1hdHJpeFxuICAgICAgICAgID8gdGhpcy5za2lubmVkTWVzaC5iaW5kTWF0cml4IGluc3RhbmNlb2YgVEhSRUUuTWF0cml4NFxuICAgICAgICAgICAgPyB0aGlzLnNraW5uZWRNZXNoLmJpbmRNYXRyaXhcbiAgICAgICAgICAgIDogbmV3IFRIUkVFLk1hdHJpeDQoKS5zZXQoLi4udGhpcy5za2lubmVkTWVzaC5iaW5kTWF0cml4KVxuICAgICAgICAgIDogdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLnNraW5uZWRNZXNoLm1lc2guYmluZCh0aGlzLnNrZWxldG9uISwgYmluZE1hdHJpeCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbn1cblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnbmd0LWJvbmUnLFxuICBleHBvcnRBczogJ25ndEJvbmUnLFxuICBwcm92aWRlcnM6IFtOR1RfT0JKRUNUX0NPTlRST0xMRVJfUFJPVklERVJdLFxufSlcbmV4cG9ydCBjbGFzcyBOZ3RCb25lIGltcGxlbWVudHMgT25Jbml0IHtcbiAgQE91dHB1dCgpIHJlYWR5ID0gbmV3IEV2ZW50RW1pdHRlcjxUSFJFRS5Cb25lPigpO1xuXG4gICNib25lPzogVEhSRUUuQm9uZTtcbiAgZ2V0IGJvbmUoKSB7XG4gICAgcmV0dXJuIHRoaXMuI2JvbmU7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0KE5HVF9PQkpFQ1RfV0FUQ0hFRF9DT05UUk9MTEVSKVxuICAgIHByaXZhdGUgb2JqZWN0Q29udHJvbGxlcjogTmd0T2JqZWN0M2RDb250cm9sbGVyLFxuICAgIEBJbmplY3QoTkdUX09CSkVDVF9JTlBVVFNfV0FUQ0hFRF9DT05UUk9MTEVSKVxuICAgIHByaXZhdGUgb2JqZWN0SW5wdXRzQ29udHJvbGxlcjogTmd0T2JqZWN0M2RJbnB1dHNDb250cm9sbGVyLFxuICAgIHByaXZhdGUgbmdab25lOiBOZ1pvbmUsXG4gICAgQE9wdGlvbmFsKClcbiAgICBwcml2YXRlIHBhcmVudFNraW5uZWRNZXNoOiBOZ3RTa2lubmVkTWVzaCxcbiAgICBAT3B0aW9uYWwoKVxuICAgIHByaXZhdGUgcGFyZW50U2tlbGV0b246IE5ndFNrZWxldG9uXG4gICkge1xuICAgIGlmICghcGFyZW50U2tpbm5lZE1lc2gpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignbmd0LWJvbmUgbXVzdCBiZSB1c2VkIHdpdGhpbiBhIG5ndC1za2lubmVkLW1lc2gnKTtcbiAgICB9XG4gICAgb2JqZWN0SW5wdXRzQ29udHJvbGxlci5hcHBlbmRUbyA9IHBhcmVudFNraW5uZWRNZXNoLm1lc2g7XG4gICAgb2JqZWN0Q29udHJvbGxlci5pbml0Rm4gPSAoKSA9PiB7XG4gICAgICB0aGlzLiNib25lID0gbmV3IFRIUkVFLkJvbmUoKTtcbiAgICAgIHJldHVybiB0aGlzLiNib25lO1xuICAgIH07XG4gICAgb2JqZWN0Q29udHJvbGxlci5yZWFkeUZuID0gKCkgPT4ge1xuICAgICAgdGhpcy5yZWFkeS5lbWl0KHRoaXMuYm9uZSk7XG4gICAgfTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgIHRoaXMub2JqZWN0Q29udHJvbGxlci5pbml0KCk7XG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5wYXJlbnRTa2VsZXRvbiAmJiB0aGlzLnBhcmVudFNrZWxldG9uLnNrZWxldG9uKSB7XG4gICAgICAgICAgdGhpcy5wYXJlbnRTa2VsZXRvbi5za2VsZXRvbi5ib25lcy5wdXNoKHRoaXMuYm9uZSEpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxufVxuXG5ATmdNb2R1bGUoe1xuICBkZWNsYXJhdGlvbnM6IFtOZ3RTa2lubmVkTWVzaCwgTmd0Qm9uZSwgTmd0U2tlbGV0b25dLFxuICBleHBvcnRzOiBbXG4gICAgTmd0U2tpbm5lZE1lc2gsXG4gICAgTmd0Qm9uZSxcbiAgICBOZ3RTa2VsZXRvbixcbiAgICBOZ3RNYXRlcmlhbEdlb21ldHJ5Q29udHJvbGxlck1vZHVsZSxcbiAgXSxcbn0pXG5leHBvcnQgY2xhc3MgTmd0U2tpbm5lZE1lc2hNb2R1bGUge31cbiJdfQ==