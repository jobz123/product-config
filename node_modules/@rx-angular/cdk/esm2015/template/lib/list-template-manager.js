import { combineLatest, merge, Observable, of } from 'rxjs';
import { catchError, distinctUntilChanged, ignoreElements, map, switchMap, tap } from 'rxjs/operators';
import { onStrategy, strategyHandling } from '@rx-angular/cdk/render-strategies';
import { getTemplateHandler } from './list-view-handler';
import { createErrorHandler } from './render-error';
import { getTNode, notifyAllParentsIfNeeded, notifyInjectingParentIfNeeded, } from './utils';
export function createListTemplateManager(config) {
    const { templateSettings, renderSettings, trackBy, iterableDiffers } = config;
    const { defaultStrategyName, strategies, cdRef: injectingViewCdRef, patchZone, parent, eRef, } = renderSettings;
    const errorHandler = createErrorHandler(renderSettings.errorHandler);
    const strategyHandling$ = strategyHandling(defaultStrategyName, strategies);
    const differ = iterableDiffers.find([]).create(trackBy);
    //               type,  context
    const tNode = parent
        ? getTNode(injectingViewCdRef, eRef.nativeElement)
        : false;
    /* TODO (regarding createView): this is currently not in use. for the list-manager this would mean to provide
     functions for not only create. developers than should have to provide create, move, remove,... the whole thing.
     i don't know if this is the right decision for a first RC */
    const listViewHandler = getTemplateHandler(Object.assign(Object.assign({}, templateSettings), { initialTemplateRef: templateSettings.templateRef, patchZone }));
    const viewContainerRef = templateSettings.viewContainerRef;
    let notifyParent = false;
    let changesArr;
    let partiallyFinished = false;
    return {
        nextStrategy(nextConfig) {
            strategyHandling$.next(nextConfig);
        },
        render(values$) {
            return values$.pipe(render());
        },
    };
    function render() {
        return (o$) => combineLatest([o$, strategyHandling$.strategy$.pipe(distinctUntilChanged())]).pipe(
        // map iterable to latest diff
        map(([iterable, strategy]) => {
            if (partiallyFinished) {
                const currentIterable = [];
                for (let i = 0, ilen = viewContainerRef.length; i < ilen; i++) {
                    const viewRef = viewContainerRef.get(i);
                    currentIterable[i] = viewRef.context.$implicit;
                }
                differ.diff(currentIterable);
            }
            return {
                changes: differ.diff(iterable),
                items: iterable != null && Array.isArray(iterable) ? iterable : [],
                strategy
            };
        }), 
        // Cancel old renders
        switchMap(({ changes, items, strategy }) => {
            if (!changes) {
                return of([]);
            }
            const listChanges = listViewHandler.getListChanges(changes, items);
            changesArr = listChanges[0];
            const insertedOrRemoved = listChanges[1];
            const applyChanges$ = getObservablesFromChangesArray(changesArr, strategy, items.length);
            partiallyFinished = true;
            // @TODO we need to know if we need to notifyParent on move aswell
            notifyParent = insertedOrRemoved && parent;
            return new Observable(subscriber => {
                const s = merge(combineLatest(
                // emit after all changes are rendered
                applyChanges$.length > 0 ? applyChanges$ : [of(items)]).pipe(tap(() => (partiallyFinished = false)), 
                // somehow this makes the strategySelect work
                notifyAllParentsIfNeeded(tNode, injectingViewCdRef, strategy, () => notifyParent)), 
                // emit injectingParent if needed
                notifyInjectingParentIfNeeded(injectingViewCdRef, strategy, insertedOrRemoved).pipe(ignoreElements())).pipe(map(() => items), catchError((e) => {
                    partiallyFinished = false;
                    errorHandler.handleError(e);
                    return of(items);
                })).subscribe(subscriber);
                return () => {
                    s.unsubscribe();
                };
            });
        }));
    }
    /**
     * @internal
     *
     * returns an array of streams which process all of the view updates needed to reflect the latest diff to the
     * viewContainer.
     * I
     *
     * @param changes
     * @param strategy
     * @param count
     */
    function getObservablesFromChangesArray(changes, strategy, count) {
        return changes.length > 0
            ? changes.map((change) => {
                const payload = change[1];
                return onStrategy(change[0], strategy, type => {
                    switch (type) {
                        case 0 /* insert */:
                            listViewHandler.insertView(payload[0], payload[1], count);
                            break;
                        case 2 /* move */:
                            listViewHandler.moveView(payload[2], payload[0], payload[1], count);
                            break;
                        case 1 /* remove */:
                            listViewHandler.removeView(payload[1]);
                            break;
                        case 3 /* update */:
                            listViewHandler.updateView(payload[0], payload[1], count);
                            break;
                        case 4 /* context */:
                            listViewHandler.updateUnchangedContext(payload[1], count);
                            break;
                    }
                }, {});
            })
            : [of(null)];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC10ZW1wbGF0ZS1tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9jZGsvdGVtcGxhdGUvc3JjL2xpYi9saXN0LXRlbXBsYXRlLW1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBUUEsT0FBTyxFQUFFLGFBQWEsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBb0IsTUFBTSxNQUFNLENBQUM7QUFDOUUsT0FBTyxFQUNMLFVBQVUsRUFBRSxvQkFBb0IsRUFDaEMsY0FBYyxFQUNkLEdBQUcsRUFDSCxTQUFTLEVBQ1QsR0FBRyxFQUNKLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEIsT0FBTyxFQUF5QixVQUFVLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUt4RyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQU96RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNwRCxPQUFPLEVBQ0wsUUFBUSxFQUNSLHdCQUF3QixFQUN4Qiw2QkFBNkIsR0FFOUIsTUFBTSxTQUFTLENBQUM7QUFRakIsTUFBTSxVQUFVLHlCQUF5QixDQUd2QyxNQVdEO0lBQ0MsTUFBTSxFQUFFLGdCQUFnQixFQUFFLGNBQWMsRUFBRSxPQUFPLEVBQUUsZUFBZSxFQUFFLEdBQUcsTUFBTSxDQUFDO0lBQzlFLE1BQU0sRUFDSixtQkFBbUIsRUFDbkIsVUFBVSxFQUNWLEtBQUssRUFBRSxrQkFBa0IsRUFDekIsU0FBUyxFQUNULE1BQU0sRUFDTixJQUFJLEdBQ0wsR0FBRyxjQUFjLENBQUM7SUFDbkIsTUFBTSxZQUFZLEdBQUcsa0JBQWtCLENBQUMsY0FBYyxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ3JFLE1BQU0saUJBQWlCLEdBQUcsZ0JBQWdCLENBQUMsbUJBQW1CLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDNUUsTUFBTSxNQUFNLEdB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c0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBFbWJlZGRlZFZpZXdSZWYsXHJcbiAgSXRlcmFibGVEaWZmZXIsXHJcbiAgSXRlcmFibGVEaWZmZXJzLFxyXG4gIE5nSXRlcmFibGUsXHJcbiAgVGVtcGxhdGVSZWYsXHJcbiAgVHJhY2tCeUZ1bmN0aW9uLFxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBjb21iaW5lTGF0ZXN0LCBtZXJnZSwgT2JzZXJ2YWJsZSwgb2YsIE9wZXJhdG9yRnVuY3Rpb24gfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHtcclxuICBjYXRjaEVycm9yLCBkaXN0aW5jdFVudGlsQ2hhbmdlZCxcclxuICBpZ25vcmVFbGVtZW50cyxcclxuICBtYXAsXHJcbiAgc3dpdGNoTWFwLFxyXG4gIHRhcFxyXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgUnhTdHJhdGVneUNyZWRlbnRpYWxzLCBvblN0cmF0ZWd5LCBzdHJhdGVneUhhbmRsaW5nIH0gZnJvbSAnQHJ4LWFuZ3VsYXIvY2RrL3JlbmRlci1zdHJhdGVnaWVzJztcclxuaW1wb3J0IHtcclxuICBSeExpc3RWaWV3Q29tcHV0ZWRDb250ZXh0LFxyXG4gIFJ4TGlzdFZpZXdDb250ZXh0LFxyXG59IGZyb20gJy4vbGlzdC12aWV3LWNvbnRleHQnO1xyXG5pbXBvcnQgeyBnZXRUZW1wbGF0ZUhhbmRsZXIgfSBmcm9tICcuL2xpc3Qtdmlldy1oYW5kbGVyJztcclxuaW1wb3J0IHtcclxuICBSeExpc3RUZW1wbGF0ZUNoYW5nZSxcclxuICBSeExpc3RUZW1wbGF0ZUNoYW5nZVR5cGUsXHJcbiAgUnhSZW5kZXJTZXR0aW5ncyxcclxuICBSeFRlbXBsYXRlU2V0dGluZ3MsXHJcbn0gZnJvbSAnLi9tb2RlbCc7XHJcbmltcG9ydCB7IGNyZWF0ZUVycm9ySGFuZGxlciB9IGZyb20gJy4vcmVuZGVyLWVycm9yJztcclxuaW1wb3J0IHtcclxuICBnZXRUTm9kZSxcclxuICBub3RpZnlBbGxQYXJlbnRzSWZOZWVkZWQsXHJcbiAgbm90aWZ5SW5qZWN0aW5nUGFyZW50SWZOZWVkZWQsXHJcbiAgVE5vZGUsXHJcbn0gZnJvbSAnLi91dGlscyc7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFJ4TGlzdE1hbmFnZXI8VD4ge1xyXG4gIG5leHRTdHJhdGVneTogKGNvbmZpZzogc3RyaW5nIHwgT2JzZXJ2YWJsZTxzdHJpbmc+KSA9PiB2b2lkO1xyXG5cclxuICByZW5kZXIoY2hhbmdlcyQ6IE9ic2VydmFibGU8TmdJdGVyYWJsZTxUPj4pOiBPYnNlcnZhYmxlPHZvaWQ+O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlTGlzdFRlbXBsYXRlTWFuYWdlcjxcclxuICBULFxyXG4gIEMgZXh0ZW5kcyBSeExpc3RWaWV3Q29udGV4dDxUPlxyXG4+KGNvbmZpZzoge1xyXG4gIHJlbmRlclNldHRpbmdzOiBSeFJlbmRlclNldHRpbmdzPFQsIEM+O1xyXG4gIHRlbXBsYXRlU2V0dGluZ3M6IE9taXQ8XHJcbiAgICBSeFRlbXBsYXRlU2V0dGluZ3M8VCwgQywgUnhMaXN0Vmlld0NvbXB1dGVkQ29udGV4dD4sXHJcbiAgICAncGF0Y2hab25lJ1xyXG4gID4gJiB7XHJcbiAgICB0ZW1wbGF0ZVJlZjogVGVtcGxhdGVSZWY8Qz47XHJcbiAgfTtcclxuICAvL1xyXG4gIHRyYWNrQnk6IFRyYWNrQnlGdW5jdGlvbjxUPjtcclxuICBpdGVyYWJsZURpZmZlcnM6IEl0ZXJhYmxlRGlmZmVycztcclxufSk6IFJ4TGlzdE1hbmFnZXI8VD4ge1xyXG4gIGNvbnN0IHsgdGVtcGxhdGVTZXR0aW5ncywgcmVuZGVyU2V0dGluZ3MsIHRyYWNrQnksIGl0ZXJhYmxlRGlmZmVycyB9ID0gY29uZmlnO1xyXG4gIGNvbnN0IHtcclxuICAgIGRlZmF1bHRTdHJhdGVneU5hbWUsXHJcbiAgICBzdHJhdGVnaWVzLFxyXG4gICAgY2RSZWY6IGluamVjdGluZ1ZpZXdDZFJlZixcclxuICAgIHBhdGNoWm9uZSxcclxuICAgIHBhcmVudCxcclxuICAgIGVSZWYsXHJcbiAgfSA9IHJlbmRlclNldHRpbmdzO1xyXG4gIGNvbnN0IGVycm9ySGFuZGxlciA9IGNyZWF0ZUVycm9ySGFuZGxlcihyZW5kZXJTZXR0aW5ncy5lcnJvckhhbmRsZXIpO1xyXG4gIGNvbnN0IHN0cmF0ZWd5SGFuZGxpbmckID0gc3RyYXRlZ3lIYW5kbGluZyhkZWZhdWx0U3RyYXRlZ3lOYW1lLCBzdHJhdGVnaWVzKTtcclxuICBjb25zdCBkaWZmZXI6IEl0ZXJhYmxlRGlmZmVyPFQ+ID0gaXRlcmFibGVEaWZmZXJzLmZpbmQoW10pLmNyZWF0ZSh0cmFja0J5KTtcclxuICAvLyAgICAgICAgICAgICAgIHR5cGUsICBjb250ZXh0XHJcbiAgY29uc3QgdE5vZGU6IFROb2RlID0gcGFyZW50XHJcbiAgICA/IGdldFROb2RlKGluamVjdGluZ1ZpZXdDZFJlZiwgZVJlZi5uYXRpdmVFbGVtZW50KVxyXG4gICAgOiBmYWxzZTtcclxuICAvKiBUT0RPIChyZWdhcmRpbmcgY3JlYXRlVmlldyk6IHRoaXMgaXMgY3VycmVudGx5IG5vdCBpbiB1c2UuIGZvciB0aGUgbGlzdC1tYW5hZ2VyIHRoaXMgd291bGQgbWVhbiB0byBwcm92aWRlXHJcbiAgIGZ1bmN0aW9ucyBmb3Igbm90IG9ubHkgY3JlYXRlLiBkZXZlbG9wZXJzIHRoYW4gc2hvdWxkIGhhdmUgdG8gcHJvdmlkZSBjcmVhdGUsIG1vdmUsIHJlbW92ZSwuLi4gdGhlIHdob2xlIHRoaW5nLlxyXG4gICBpIGRvbid0IGtub3cgaWYgdGhpcyBpcyB0aGUgcmlnaHQgZGVjaXNpb24gZm9yIGEgZmlyc3QgUkMgKi9cclxuICBjb25zdCBsaXN0Vmlld0hhbmRsZXIgPSBnZXRUZW1wbGF0ZUhhbmRsZXIoe1xyXG4gICAgLi4udGVtcGxhdGVTZXR0aW5ncyxcclxuICAgIGluaXRpYWxUZW1wbGF0ZVJlZjogdGVtcGxhdGVTZXR0aW5ncy50ZW1wbGF0ZVJlZixcclxuICAgIHBhdGNoWm9uZSxcclxuICB9KTtcclxuICBjb25zdCB2aWV3Q29udGFpbmVyUmVmID0gdGVtcGxhdGVTZXR0aW5ncy52aWV3Q29udGFpbmVyUmVmO1xyXG5cclxuICBsZXQgbm90aWZ5UGFyZW50ID0gZmFsc2U7XHJcbiAgbGV0IGNoYW5nZXNBcnI6IFJ4TGlzdFRlbXBsYXRlQ2hhbmdlW107XHJcbiAgbGV0IHBhcnRpYWxseUZpbmlzaGVkID0gZmFsc2U7XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICBuZXh0U3RyYXRlZ3kobmV4dENvbmZpZzogT2JzZXJ2YWJsZTxzdHJpbmc+KTogdm9pZCB7XHJcbiAgICAgIHN0cmF0ZWd5SGFuZGxpbmckLm5leHQobmV4dENvbmZpZyk7XHJcbiAgICB9LFxyXG4gICAgcmVuZGVyKHZhbHVlcyQ6IE9ic2VydmFibGU8TmdJdGVyYWJsZTxUPj4pOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgICByZXR1cm4gdmFsdWVzJC5waXBlKHJlbmRlcigpKTtcclxuICAgIH0sXHJcbiAgfTtcclxuXHJcbiAgZnVuY3Rpb24gcmVuZGVyKCk6IE9wZXJhdG9yRnVuY3Rpb248TmdJdGVyYWJsZTxUPiwgYW55PiB7XHJcbiAgICByZXR1cm4gKG8kOiBPYnNlcnZhYmxlPE5nSXRlcmFibGU8VD4+KTogT2JzZXJ2YWJsZTxhbnk+ID0+XHJcbiAgICAgIGNvbWJpbmVMYXRlc3QoW28kLCBzdHJhdGVneUhhbmRsaW5nJC5zdHJhdGVneSQucGlwZShkaXN0aW5jdFVudGlsQ2hhbmdlZCgpKV0pLnBpcGUoXHJcbiAgICAgICAgLy8gbWFwIGl0ZXJhYmxlIHRvIGxhdGVzdCBkaWZmXHJcbiAgICAgICAgbWFwKChbaXRlcmFibGUsIHN0cmF0ZWd5XSkgPT4ge1xyXG4gICAgICAgICAgaWYgKHBhcnRpYWxseUZpbmlzaGVkKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRJdGVyYWJsZSA9IFtdO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMCwgaWxlbiA9IHZpZXdDb250YWluZXJSZWYubGVuZ3RoOyBpIDwgaWxlbjsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgY29uc3Qgdmlld1JlZiA9IDxFbWJlZGRlZFZpZXdSZWY8Qz4+dmlld0NvbnRhaW5lclJlZi5nZXQoaSk7XHJcbiAgICAgICAgICAgICAgY3VycmVudEl0ZXJhYmxlW2ldID0gdmlld1JlZi5jb250ZXh0LiRpbXBsaWNpdDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBkaWZmZXIuZGlmZihjdXJyZW50SXRlcmFibGUpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgY2hhbmdlczogZGlmZmVyLmRpZmYoaXRlcmFibGUpLFxyXG4gICAgICAgICAgICBpdGVtczogaXRlcmFibGUgIT0gbnVsbCAmJiBBcnJheS5pc0FycmF5KGl0ZXJhYmxlKSA/IGl0ZXJhYmxlIDogW10sXHJcbiAgICAgICAgICAgIHN0cmF0ZWd5XHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIC8vIENhbmNlbCBvbGQgcmVuZGVyc1xyXG4gICAgICAgIHN3aXRjaE1hcCgoeyBjaGFuZ2VzLCBpdGVtcywgc3RyYXRlZ3kgfSkgPT4ge1xyXG4gICAgICAgICAgaWYgKCFjaGFuZ2VzKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBvZihbXSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBjb25zdCBsaXN0Q2hhbmdlcyA9IGxpc3RWaWV3SGFuZGxlci5nZXRMaXN0Q2hhbmdlcyhjaGFuZ2VzLCBpdGVtcyk7XHJcbiAgICAgICAgICBjaGFuZ2VzQXJyID0gbGlzdENoYW5nZXNbMF07XHJcbiAgICAgICAgICBjb25zdCBpbnNlcnRlZE9yUmVtb3ZlZCA9IGxpc3RDaGFuZ2VzWzFdO1xyXG4gICAgICAgICAgY29uc3QgYXBwbHlDaGFuZ2VzJCA9IGdldE9ic2VydmFibGVzRnJvbUNoYW5nZXNBcnJheShcclxuICAgICAgICAgICAgY2hhbmdlc0FycixcclxuICAgICAgICAgICAgc3RyYXRlZ3ksXHJcbiAgICAgICAgICAgIGl0ZW1zLmxlbmd0aFxyXG4gICAgICAgICAgKTtcclxuICAgICAgICAgIHBhcnRpYWxseUZpbmlzaGVkID0gdHJ1ZTtcclxuICAgICAgICAgIC8vIEBUT0RPIHdlIG5lZWQgdG8ga25vdyBpZiB3ZSBuZWVkIHRvIG5vdGlmeVBhcmVudCBvbiBtb3ZlIGFzd2VsbFxyXG4gICAgICAgICAgbm90aWZ5UGFyZW50ID0gaW5zZXJ0ZWRPclJlbW92ZWQgJiYgcGFyZW50O1xyXG4gICAgICAgICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKHN1YnNjcmliZXIgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBzID0gbWVyZ2UoXHJcbiAgICAgICAgICAgICAgY29tYmluZUxhdGVzdChcclxuICAgICAgICAgICAgICAgIC8vIGVtaXQgYWZ0ZXIgYWxsIGNoYW5nZXMgYXJlIHJlbmRlcmVkXHJcbiAgICAgICAgICAgICAgICBhcHBseUNoYW5nZXMkLmxlbmd0aCA+IDAgPyBhcHBseUNoYW5nZXMkIDogW29mKGl0ZW1zKV1cclxuICAgICAgICAgICAgICApLnBpcGUoXHJcbiAgICAgICAgICAgICAgICB0YXAoKCkgPT4gKHBhcnRpYWxseUZpbmlzaGVkID0gZmFsc2UpKSxcclxuICAgICAgICAgICAgICAgIC8vIHNvbWVob3cgdGhpcyBtYWtlcyB0aGUgc3RyYXRlZ3lTZWxlY3Qgd29ya1xyXG4gICAgICAgICAgICAgICAgbm90aWZ5QWxsUGFyZW50c0lmTmVlZGVkKFxyXG4gICAgICAgICAgICAgICAgICB0Tm9kZSxcclxuICAgICAgICAgICAgICAgICAgaW5qZWN0aW5nVmlld0NkUmVmLFxyXG4gICAgICAgICAgICAgICAgICBzdHJhdGVneSxcclxuICAgICAgICAgICAgICAgICAgKCkgPT4gbm90aWZ5UGFyZW50XHJcbiAgICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgICAgKSxcclxuICAgICAgICAgICAgICAvLyBlbWl0IGluamVjdGluZ1BhcmVudCBpZiBuZWVkZWRcclxuICAgICAgICAgICAgICBub3RpZnlJbmplY3RpbmdQYXJlbnRJZk5lZWRlZChcclxuICAgICAgICAgICAgICAgIGluamVjdGluZ1ZpZXdDZFJlZixcclxuICAgICAgICAgICAgICAgIHN0cmF0ZWd5LFxyXG4gICAgICAgICAgICAgICAgaW5zZXJ0ZWRPclJlbW92ZWRcclxuICAgICAgICAgICAgICApLnBpcGUoaWdub3JlRWxlbWVudHMoKSlcclxuICAgICAgICAgICAgKS5waXBlKFxyXG4gICAgICAgICAgICAgIG1hcCgoKSA9PiBpdGVtcyksXHJcbiAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcGFydGlhbGx5RmluaXNoZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIGVycm9ySGFuZGxlci5oYW5kbGVFcnJvcihlKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBvZihpdGVtcyk7XHJcbiAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgKS5zdWJzY3JpYmUoc3Vic2NyaWJlcik7XHJcbiAgICAgICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgcy51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgIH0pXHJcbiAgICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAaW50ZXJuYWxcclxuICAgKlxyXG4gICAqIHJldHVybnMgYW4gYXJyYXkgb2Ygc3RyZWFtcyB3aGljaCBwcm9jZXNzIGFsbCBvZiB0aGUgdmlldyB1cGRhdGVzIG5lZWRlZCB0byByZWZsZWN0IHRoZSBsYXRlc3QgZGlmZiB0byB0aGVcclxuICAgKiB2aWV3Q29udGFpbmVyLlxyXG4gICAqIElcclxuICAgKlxyXG4gICAqIEBwYXJhbSBjaGFuZ2VzXHJcbiAgICogQHBhcmFtIHN0cmF0ZWd5XHJcbiAgICogQHBhcmFtIGNvdW50XHJcbiAgICovXHJcbiAgZnVuY3Rpb24gZ2V0T2JzZXJ2YWJsZXNGcm9tQ2hhbmdlc0FycmF5KFxyXG4gICAgY2hhbmdlczogUnhMaXN0VGVtcGxhdGVDaGFuZ2U8VD5bXSxcclxuICAgIHN0cmF0ZWd5OiBSeFN0cmF0ZWd5Q3JlZGVudGlhbHMsXHJcbiAgICBjb3VudDogbnVtYmVyXHJcbiAgKTogT2JzZXJ2YWJsZTxSeExpc3RUZW1wbGF0ZUNoYW5nZVR5cGU+W10ge1xyXG4gICAgcmV0dXJuIGNoYW5nZXMubGVuZ3RoID4gMFxyXG4gICAgICA/IGNoYW5nZXMubWFwKChjaGFuZ2UpID0+IHtcclxuICAgICAgICBjb25zdCBwYXlsb2FkID0gY2hhbmdlWzFdO1xyXG4gICAgICAgICAgcmV0dXJuIG9uU3RyYXRlZ3koXHJcbiAgICAgICAgICAgIGNoYW5nZVswXSxcclxuICAgICAgICAgICAgc3RyYXRlZ3ksXHJcbiAgICAgICAgICAgIHR5cGUgPT4ge1xyXG4gICAgICAgICAgICAgIHN3aXRjaCAodHlwZSkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSBSeExpc3RUZW1wbGF0ZUNoYW5nZVR5cGUuaW5zZXJ0OlxyXG4gICAgICAgICAgICAgICAgICBsaXN0Vmlld0hhbmRsZXIuaW5zZXJ0VmlldyhwYXlsb2FkWzBdLCBwYXlsb2FkWzFdLCBjb3VudCk7XHJcbiAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBSeExpc3RUZW1wbGF0ZUNoYW5nZVR5cGUubW92ZTpcclxuICAgICAgICAgICAgICAgICAgbGlzdFZpZXdIYW5kbGVyLm1vdmVWaWV3KFxyXG4gICAgICAgICAgICAgICAgICAgIHBheWxvYWRbMl0sXHJcbiAgICAgICAgICAgICAgICAgICAgcGF5bG9hZFswXSxcclxuICAgICAgICAgICAgICAgICAgICBwYXlsb2FkWzFdLFxyXG4gICAgICAgICAgICAgICAgICAgIGNvdW50XHJcbiAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBSeExpc3RUZW1wbGF0ZUNoYW5nZVR5cGUucmVtb3ZlOlxyXG4gICAgICAgICAgICAgICAgICBsaXN0Vmlld0hhbmRsZXIucmVtb3ZlVmlldyhwYXlsb2FkWzFdKTtcclxuICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFJ4TGlzdFRlbXBsYXRlQ2hhbmdlVHlwZS51cGRhdGU6XHJcbiAgICAgICAgICAgICAgICAgIGxpc3RWaWV3SGFuZGxlci51cGRhdGVWaWV3KHBheWxvYWRbMF0sIHBheWxvYWRbMV0sIGNvdW50KTtcclxuICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFJ4TGlzdFRlbXBsYXRlQ2hhbmdlVHlwZS5jb250ZXh0OlxyXG4gICAgICAgICAgICAgICAgICBsaXN0Vmlld0hhbmRsZXIudXBkYXRlVW5jaGFuZ2VkQ29udGV4dChwYXlsb2FkWzFdLCBjb3VudCk7XHJcbiAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAge31cclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfSlcclxuICAgICAgOiBbb2YobnVsbCldO1xyXG4gIH1cclxufVxyXG4iXX0=