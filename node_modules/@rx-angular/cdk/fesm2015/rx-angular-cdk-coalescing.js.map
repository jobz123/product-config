{"version":3,"file":"rx-angular-cdk-coalescing.js","sources":["../../../../libs/cdk/coalescing/src/lib/coalescingManager.ts","../../../../libs/cdk/coalescing/src/lib/coalesceWith.ts","../../../../libs/cdk/coalescing/src/rx-angular-cdk-coalescing.ts"],"sourcesContent":["interface CoalescingContextProps extends Record<string, unknown> {\r\n  numCoalescingSubscribers: number;\r\n}\r\n\r\nexport interface CoalescingManager {\r\n  remove: (scope: Record<string, unknown>) => void;\r\n  add: (scope: Record<string, unknown>) => void;\r\n  isCoalescing: (scope: Record<string, unknown>) => boolean;\r\n}\r\n\r\nexport const coalescingManager: CoalescingManager = createCoalesceManager();\r\ntype KeyOf<O> = keyof O;\r\ntype ValueOf<O> = O[keyof O];\r\nfunction hasKey<O>(ctx: O, property: KeyOf<O>): ctx is O {\r\n  return ctx[property] != null;\r\n}\r\n/*\r\n * createPropertiesWeakMap\r\n *\r\n * @param getDefaults: (o: O) => P\r\n * Example:\r\n *\r\n * export interface Properties {\r\n *   isCoalescing: boolean;\r\n * }\r\n *\r\n * const obj: object = {\r\n *   foo: 'bar',\r\n *   isCoalescing: 'weakMap version'\r\n * };\r\n *\r\n * const getDefaults = (ctx: object): Properties => ({isCoalescing: false});\r\n * const propsMap = createPropertiesWeakMap<object, Properties>(getDefaults);\r\n *\r\n * console.log('obj before:', obj);\r\n * // {foo: \"bar\", isCoalescing: \"weakMap version\"}\r\n * console.log('props before:', propsMap.getProps(obj));\r\n * // {isCoalescing: \"weakMap version\"}\r\n *\r\n * propsMap.setProps(obj, {isCoalescing: true});\r\n * console.log('obj after:', obj);\r\n * // {foo: \"bar\", isCoalescing: \"weakMap version\"}\r\n * console.log('props after:', propsMap.getProps(obj));\r\n * // {isCoalescing: \"true\"}\r\n * */\r\nfunction createPropertiesWeakMap<\r\n  O extends Record<string, unknown>,\r\n  P extends O\r\n>(getDefaults: (o: O) => P) {\r\n  type K = KeyOf<P>;\r\n  const propertyMap = new WeakMap<O, P>();\r\n\r\n  return {\r\n    getProps: getProperties,\r\n    setProps: setProperties,\r\n  };\r\n\r\n  function getProperties(ctx: O): P {\r\n    const defaults = getDefaults(ctx);\r\n    const propertiesPresent: P | undefined = propertyMap.get(ctx);\r\n    let properties: P;\r\n\r\n    if (propertiesPresent !== undefined) {\r\n      properties = propertiesPresent as P;\r\n    } else {\r\n      properties = {} as P;\r\n\r\n      (Object.entries(defaults) as unknown[]).forEach(\r\n        ([prop, value]: [KeyOf<P>, ValueOf<P>]): void => {\r\n          if (hasKey(ctx as P, prop)) {\r\n            properties[prop] = (ctx as P)[prop];\r\n          } else {\r\n            properties[prop] = value;\r\n          }\r\n        }\r\n      );\r\n\r\n      propertyMap.set(ctx, properties);\r\n    }\r\n    return properties;\r\n  }\r\n\r\n  function setProperties(ctx: O, props: Partial<P>): P {\r\n    const properties: P = getProperties(ctx);\r\n    (Object.entries(props) as [K, P[K]][]).forEach(([prop, value]) => {\r\n      properties[prop] = value;\r\n    });\r\n    propertyMap.set(ctx, properties);\r\n    return properties;\r\n  }\r\n}\r\n\r\nconst coalescingContextPropertiesMap = createPropertiesWeakMap<\r\n  Record<string, unknown>,\r\n  CoalescingContextProps\r\n>((ctx) => ({\r\n  numCoalescingSubscribers: 0,\r\n}));\r\n/**\r\n * @describe createCoalesceManager\r\n *\r\n * returns a\r\n * Maintains a weak map of component references ans flags\r\n * them if the coalescing process is already started for them.\r\n *\r\n * Used in render aware internally.\r\n */\r\nfunction createCoalesceManager(): CoalescingManager {\r\n  return {\r\n    remove: removeWork,\r\n    add: addWork,\r\n    isCoalescing,\r\n  };\r\n\r\n  // Increments the number of subscriptions in a scope e.g. a class instance\r\n  function removeWork(scope: Record<string, unknown>): void {\r\n    const numCoalescingSubscribers =\r\n      coalescingContextPropertiesMap.getProps(scope).numCoalescingSubscribers -\r\n      1;\r\n    coalescingContextPropertiesMap.setProps(scope, {\r\n      numCoalescingSubscribers:\r\n        numCoalescingSubscribers >= 0 ? numCoalescingSubscribers : 0,\r\n    });\r\n  }\r\n\r\n  // Decrements the number of subscriptions in a scope e.g. a class instance\r\n  function addWork(scope: Record<string, unknown>): void {\r\n    const numCoalescingSubscribers =\r\n      coalescingContextPropertiesMap.getProps(scope).numCoalescingSubscribers +\r\n      1;\r\n    coalescingContextPropertiesMap.setProps(scope, {\r\n      numCoalescingSubscribers,\r\n    });\r\n  }\r\n\r\n  // Checks if anybody else is already coalescing atm\r\n  function isCoalescing(scope: Record<string, unknown>): boolean {\r\n    return (\r\n      coalescingContextPropertiesMap.getProps(scope).numCoalescingSubscribers >\r\n      0\r\n    );\r\n  }\r\n}\r\n","import {\r\n  MonoTypeOperatorFunction,\r\n  Observable,\r\n  Observer,\r\n  Subscriber,\r\n  Subscription,\r\n  Unsubscribable,\r\n} from 'rxjs';\r\nimport { coalescingManager } from './coalescingManager';\r\n\r\n/**\r\n * @description\r\n * Limits the number of synchronous emitted a value from the source Observable to\r\n * one emitted value per\r\n *   durationSelector e.g. [`AnimationFrame`](https://developer.mozilla.org/en-US/docs/Web/API/Window/requestAnimationFrame), then repeats\r\n * this process for every tick of the browsers event loop.\r\n *\r\n * The coalesce operator is based on the [throttle](https://rxjs-dev.firebaseapp.com/api/operators/throttle) operator.\r\n * In addition to that is provides emitted values for the trailing end only, as well as maintaining a context to scope\r\n *   coalescing.\r\n *\r\n * @param {function(value: T): Observable} durationSelector - A function\r\n * that receives a value from the source Observable, for computing the silencing\r\n * duration for each source value, returned as an Observable or a Promise.\r\n * It defaults to `requestAnimationFrame` as durationSelector.\r\n * @param scope\r\n * Defaults to `{ leading: false, trailing: true }`. The default scoping is per subscriber.\r\n * @return {Observable<T>} An Observable that performs the coalesce operation to\r\n * limit the rate of emissions from the source.\r\n *\r\n * @usageNotes\r\n * Emit clicks at a rate of at most one click per second\r\n * ```typescript\r\n * import { fromEvent, animationFrames } from 'rxjs';\r\n * import { coalesce } from 'ngRx/component';\r\n *\r\n * const clicks = fromEvent(document, 'click');\r\n * const result = clicks.pipe(coalesce(ev => animationFrames));\r\n * result.subscribe(x => console.log(x));\r\n * ```\r\n */\r\nexport function coalesceWith<T>(\r\n  durationSelector: Observable<unknown>,\r\n  scope?: Record<string, unknown>\r\n): MonoTypeOperatorFunction<T> {\r\n  const _scope = scope || {};\r\n\r\n  return (source) => {\r\n    return new Observable<T>((observer) => {\r\n      const rootSubscription = new Subscription();\r\n      rootSubscription.add(\r\n        source.subscribe(createInnerObserver(observer, rootSubscription))\r\n      );\r\n      return rootSubscription;\r\n    });\r\n\r\n    function createInnerObserver(\r\n      outerObserver: Subscriber<T>,\r\n      rootSubscription: Subscription\r\n    ): Observer<T> {\r\n      let actionSubscription: Unsubscribable;\r\n      let latestValue: T | undefined;\r\n\r\n      const tryEmitLatestValue = () => {\r\n        if (actionSubscription) {\r\n          // We only decrement the number if it is greater than 0 (isCoalescing)\r\n          coalescingManager.remove(_scope);\r\n          if (!coalescingManager.isCoalescing(_scope)) {\r\n            outerObserver.next(latestValue);\r\n          }\r\n        }\r\n      };\r\n      return {\r\n        complete: () => {\r\n          tryEmitLatestValue();\r\n          outerObserver.complete();\r\n        },\r\n        error: (error) => outerObserver.error(error),\r\n        next: (value) => {\r\n          latestValue = value;\r\n          if (!actionSubscription) {\r\n            // tslint:disable-next-line:no-unused-expression\r\n            coalescingManager.add(_scope);\r\n            actionSubscription = durationSelector.subscribe({\r\n              error: (error) => outerObserver.error(error),\r\n              next: () => {\r\n                tryEmitLatestValue();\r\n                actionSubscription?.unsubscribe();\r\n                actionSubscription = undefined;\r\n              },\r\n              complete: () => {\r\n                tryEmitLatestValue();\r\n                actionSubscription = undefined;\r\n              },\r\n            });\r\n            rootSubscription.add(\r\n              new Subscription(() => {\r\n                tryEmitLatestValue();\r\n                actionSubscription?.unsubscribe();\r\n                actionSubscription = undefined;\r\n              })\r\n            );\r\n          }\r\n        },\r\n      };\r\n    }\r\n  };\r\n}\r\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":[],"mappings":"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"}