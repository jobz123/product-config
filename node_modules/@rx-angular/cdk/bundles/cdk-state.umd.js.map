{"version":3,"file":"cdk-state.umd.js","sources":["../../../../libs/cdk/state/src/lib/accumulateObservables.ts","../../../../libs/cdk/state/src/cdk-state.ts"],"sourcesContent":["import { coalesceWith } from '@rx-angular/cdk/coalescing';\r\nimport { Promise } from '@rx-angular/cdk/zone-less';\r\nimport { combineLatest, from, Observable } from 'rxjs';\r\nimport { distinctUntilChanged, filter, map, shareReplay } from 'rxjs/operators';\r\nimport { ArrayReducerFn, ExtractObservableValue, NotEmpty, ObservableMap, PropName, PropType } from './model';\r\n\r\nconst resolvedPromise = Promise.resolve();\r\nconst resolvedPromise$ = from(resolvedPromise);\r\n\r\n/**\r\n * @internal\r\n *\r\n * Used for typing\r\n */\r\nfunction getEntriesToObjectReducerFn<T extends Record<string, any>>(\r\n  keys: PropName<T>[]\r\n): ArrayReducerFn<T> {\r\n  return (\r\n    accumulator: T,\r\n    currentValue?: PropType<T>,\r\n    currentIndex?: number\r\n  ): T => {\r\n    return {\r\n      ...accumulator,\r\n      [keys[currentIndex]]: currentValue\r\n    };\r\n  };\r\n}\r\n\r\n/**\r\n * This Observable creation function helps to accumulate an object of key & Observable of values to\r\n * an Observable of objects of key & value.\r\n * This comes in handy if you quickly want to create subsets as objects/state-slices of different Observables.\r\n *\r\n * The resulting Observable filters out undefined values forwards only distinct values and shared the aggregated output.\r\n *\r\n * @example\r\n *\r\n * Default usage:\r\n *\r\n * const object$: Observable<{\r\n *   prop1: number,\r\n *   prop2: string,\r\n *   prop3: string\r\n * }> = accumulateObservables({\r\n *   prop1: interval(42),\r\n *   prop2: of('lorem'),\r\n *   prop3: 'test'\r\n * });\r\n *\r\n * Usage with custom duration selector:\r\n *\r\n * const object$: Observable<{\r\n *   prop1: number,\r\n *   prop2: string,\r\n *   prop3: string\r\n * }> = accumulateObservables({\r\n *   prop1: interval(42),\r\n *   prop2: of('lorem'),\r\n *   prop3: 'test'\r\n * }, timer(0, 20));\r\n *\r\n * @param obj - An object of key & Observable values pairs\r\n * @param durationSelector - An Observable determining the duration for the internal coalescing method\r\n */\r\nexport function accumulateObservables<T extends ObservableMap & NotEmpty<T>>(\r\n  // @TODO type static or Observable to enable mixing of imperative and reatctive values\r\n  obj: T,\r\n  durationSelector: Observable<any> = resolvedPromise$\r\n): Observable<{ [K in keyof T]: ExtractObservableValue<T[K]> }> {\r\n  const keys = Object.keys(obj) as (keyof T)[];\r\n  // @TODO better typing to enable static values => coerceObservable(obj[key])\r\n  const observables = keys.map((key) =>\r\n    obj[key].pipe(\r\n      // we avoid using the nullish operator later ;)\r\n      filter((v) => v !== undefined),\r\n      // state \"changes\" differ from each other, this operator ensures distinct values\r\n      distinctUntilChanged()\r\n    )\r\n  );\r\n  return combineLatest(observables).pipe(\r\n    // As combineLatest will emit multiple times for a change in multiple properties we coalesce those emissions\r\n    // together\r\n    coalesceWith(durationSelector),\r\n    // mapping array of values to object\r\n    map((values) =>\r\n      values.reduce(getEntriesToObjectReducerFn(keys), {} as any)\r\n    ),\r\n    // by using shareReplay we share the last composition work done to create the accumulated object\r\n    shareReplay(1)\r\n  );\r\n}\r\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":["Promise","from","filter","distinctUntilChanged","combineLatest","coalesceWith","map","shareReplay"],"mappings":";;;;;;IAMA,IAAM,eAAe,GAAGA,gBAAO,CAAC,OAAO,EAAE,CAAC;IAC1C,IAAM,gBAAgB,GAAGC,SAAI,CAAC,eAAe,CAAC,CAAC;IAE/C;;;;;IAKA,SAAS,2BAA2B,CAClC,IAAmB;QAEnB,OAAO,UACL,WAAc,EACd,YAA0B,EAC1B,YAAqB;;YAErB,uCACK,WAAW,aACd,GAAC,IAAI,CAAC,YAAY,CAAC,IAAG,YAAY,OAClC;SACH,CAAC;IACJ,CAAC;IAED;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;aAoCgB,qBAAqB;IACnC;IACA,GAAM,EACN,gBAAoD;QAApD,iCAAA,EAAA,mCAAoD;QAEpD,IAAM,IAAI,GAAG,MAAM,CAAC,IAAI,CAAC,GAAG,CAAgB,CAAC;;QAE7C,IAAM,WAAW,GAAG,IAAI,CAAC,GAAG,CAAC,UAAC,GAAG,IAC/B,OAAA,GAAG,CAAC,GAAG,CAAC,CAAC,IAAI;;QAEXC,gBAAM,CAAC,UAAC,CAAC,IAAK,OAAA,CAAC,KAAK,SAAS,GAAA,CAAC;;QAE9BC,8BAAoB,EAAE,CACvB,GAAA,CACF,CAAC;QACF,OAAOC,kBAAa,CAAC,WAAW,CAAC,CAAC,IAAI;;;QAGpCC,uBAAY,CAAC,gBAAgB,CAAC;;QAE9BC,aAAG,CAAC,UAAC,MAAM,IACT,OAAA,MAAM,CAAC,MAAM,CAAC,2BAA2B,CAAC,IAAI,CAAC,EAAE,EAAS,CAAC,GAAA,CAC5D;;QAEDC,qBAAW,CAAC,CAAC,CAAC,CACf,CAAC;IACJ;;IC3FA;;;;;;;;;;;;"}